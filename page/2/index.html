<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="I am cmp-cc" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="I am cmp-cc">
<meta property="og:url" content="http://cmp-cc.github.io/page/2/index.html">
<meta property="og:site_name" content="I am cmp-cc">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="I am cmp-cc">
<meta name="twitter:description">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> I am cmp-cc </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?0fb6f1a75a76726c10a144a8257465e3";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">I am cmp-cc</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">一直在打杂，从未被超越。</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/12/28/2014/Hadoop 日常实战 文件压缩/" itemprop="url">
                  Hadoop 日常实战 文件压缩
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-12-28T19:25:00+08:00" content="2014-12-28">
              2014-12-28
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Distributed-Development/" itemprop="url" rel="index">
                    <span itemprop="name">Distributed Development</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Distributed-Development/Hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">Hadoop</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/12/28/2014/Hadoop 日常实战 文件压缩/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/12/28/2014/Hadoop 日常实战 文件压缩/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Mapreduce 程序执行可以分为三个阶段：<br>1、Mapper 阶段<br><strong>从HDFS中读取数据源，将计算结果写入HDFS</strong><br>2、Suffle与排序阶段<br><strong>从HDFS中读取Mapper阶段结果数据，并进行混排操作（Suffle与排序），并将结果数据传递给Reducer</strong><br>3、Reducer阶段<br><strong>Reducer接受数据，再将计算结果写入HDFS或其它</strong></p>
<blockquote>
<p>这里我忽略combiner阶段。 因为combiner阶段只是一步优化操作，不属于Mapreduce模型中的核心。</p>
</blockquote>
<p>如上可知，执行Mapreduce程序一共需要两次文件的读入和写入。  如果增加文件压缩，将大大提高程序的运行效率。</p>
<h2 id="Hadoop-支持的压缩算法"><a href="#Hadoop-支持的压缩算法" class="headerlink" title="Hadoop 支持的压缩算法"></a>Hadoop 支持的压缩算法</h2><h3 id="内置压缩算法"><a href="#内置压缩算法" class="headerlink" title="内置压缩算法"></a>内置压缩算法</h3><p>优势：</p>
<ul>
<li>它减少了存储文件所需的空间；</li>
<li>加快了数据在网络上或者从磁盘上或到磁盘上的传输速度；<br>hadoop对于压缩格式的是透明识别,我们的MapReduce任务的执行是透明的，hadoop能够自动为我们 将压缩的文件解压，而不用我们去关心。 hadoop就会根据扩展名去选择解码器解压。当压缩文件做为mapreduce的输入时，mapreduce将自动通过扩展名找到相应的codec对其解压。</li>
</ul>
<p><strong>主流的压缩格式：</strong></p>
<table>
<thead>
<tr>
<th>压缩格式</th>
<th>工具</th>
<th>算法</th>
<th>文件扩展名</th>
<th>多文件</th>
<th>是否可切分</th>
<th>HadoopCompressionCodec</th>
</tr>
</thead>
<tbody>
<tr>
<td>DEFLATE</td>
<td>无</td>
<td>DEFLATE</td>
<td>.deflate</td>
<td>否</td>
<td>否</td>
<td>org.apache.hadoop.io.compress.DefaultCodec</td>
</tr>
<tr>
<td>Gzip</td>
<td>gzip</td>
<td>DEFLATE</td>
<td>.gz</td>
<td>否</td>
<td>否</td>
<td>org.apache.hadoop.io.compress.GzipCodec</td>
</tr>
<tr>
<td>bzip2</td>
<td>bzip2</td>
<td>bzip2</td>
<td>.bz2</td>
<td>否</td>
<td>是</td>
<td>org.apache.hadoop.io.compress.BZip2Codec</td>
</tr>
<tr>
<td>LZO</td>
<td>lzop</td>
<td>LZO</td>
<td>.lzo</td>
<td>否</td>
<td>是（需要索引）</td>
<td>com.hadoop.compression.lzo.LzopCodec</td>
</tr>
<tr>
<td>Snappy</td>
<td>N/A</td>
<td>Snappy</td>
<td>.Snappy</td>
<td>否</td>
<td>否</td>
<td>org.apache.hadoop.io.compress.SnappyCodec</td>
</tr>
<tr>
<td>LZ4</td>
<td>N/A</td>
<td>LZ4</td>
<td>.lz4</td>
<td>否</td>
<td>否</td>
<td>org.apache.hadoop.io.compress.Lz4Codec</td>
</tr>
</tbody>
</table>
<p>压缩算法比较<br>    主要是时间比较与空间比较。</p>
<p>1）GZIP的压缩率最高，但是其实CPU密集型的，对CPU的消耗比其他算法要多，压缩和解压速度也慢；<br>2）LZO的压缩率居中，比GZIP要低一些，但是压缩和解压速度明显要比GZIP快很多，其中解压速度快的更多；<br>3）Zippy/Snappy的压缩率最低，而压缩和解压速度要稍微比LZO要快一些。</p>
<h3 id="LZO-算法引入Hadoop"><a href="#LZO-算法引入Hadoop" class="headerlink" title="LZO 算法引入Hadoop"></a>LZO 算法引入Hadoop</h3><p>上述压缩格式类型。 除lzo 格式需要另外下载。MR2 均内置上述格式。<br>Lzo下载地址： <a href="https://github.com/twitter/hadoop-lzo" target="_blank" rel="external">https://github.com/twitter/hadoop-lzo</a><br>Lzo 本身不支持切分(splitable) 但是我们可以增加索引，即可支持切分<br>Hadoop的Lzo代码库中有索引工具。（DistributedLzoIndexer）<br>请参照：<br><a href="https://github.com/twitter/hadoop-lzo/blob/master/src/test/java/com/hadoop/mapreduce/TestLzoTextInputFormat.java" target="_blank" rel="external">https://github.com/twitter/hadoop-lzo/blob/master/src/test/java/com/hadoop/mapreduce/TestLzoTextInputFormat.java</a></p>
<p><strong>如果希望reduce输出的是lzo格式的文件，添加下面的语句</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FileOutputFormat.setCompressOutput(job, true);</span><br><span class="line">FileOutputFormat.setOutputCompressorClass(job, LzopCodec.class);</span><br><span class="line">int result = job.waitForCompletion(true) ? 0 : 1;</span><br><span class="line">//上面的语句执行完成后，会生成最后的输出文件，需要在此基础上添加lzo的索引</span><br><span class="line">LzoIndexer lzoIndexer = new LzoIndexer(conf);</span><br><span class="line">lzoIndexer.index(new Path(args[1]));</span><br></pre></td></tr></table></figure></p>
<p>如果已经存在lzo文件，但没有添加索引，可以采用下面的方法，在输入路径的文件上上添加lzo索引<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop jar $HADOOP_HOME/lib/hadoop-lzo-0.4.17.jar com.hadoop.compression.lzo.LzoIndexer hdf://inputpath</span><br></pre></td></tr></table></figure></p>
<h2 id="压缩分片的最重要性"><a href="#压缩分片的最重要性" class="headerlink" title="压缩分片的最重要性"></a>压缩分片的最重要性</h2><p><strong>理解分片(splitable)的价值:</strong></p>
<ul>
<li>支持分片是很有用的。<br><strong>如： 在HDFS上有一个1G的文件。按照HDFS块(block)的设置大小进行文件划分(默认64M)。 那么就会被划分为16个数据块。</strong><ul>
<li>支持分片：运行这个Mapreduce作业，就会对应16个Map。</li>
<li>不支持分片：运行这个Mapreduce作业，只能对应1个Map。</li>
</ul>
</li>
<li>为什么？Hadoop又是怎么判断文件是否支持分片？对程序有什么影响？<ul>
<li>1、支持分片，就意味着支持压缩数据流的任意位置读取数据。</li>
<li>2、Hadoop 则是通过文件后缀名来判断所属的文件是否支持分片。</li>
<li>3、牺牲数据本地性优势： 1个Map任务要处理16个HDFS块，而且损失了数据本地化优化特性(执行Map任务与HDFS数据位于同一个节点上)。 而且map的任务越少，就意味着执行的时间越长。</li>
</ul>
</li>
</ul>
<h2 id="MapReduce-中使用压缩。"><a href="#MapReduce-中使用压缩。" class="headerlink" title="MapReduce 中使用压缩。"></a>MapReduce 中使用压缩。</h2><p><strong>在MapReduce中使用压缩是简单的。 我们通常有两种方式。</strong></p>
<h3 id="代码方式："><a href="#代码方式：" class="headerlink" title="代码方式："></a>代码方式：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// Map端输出压缩：</span><br><span class="line">conf.setBoolean(&quot;mapred.compress.map.output&quot;, true);  </span><br><span class="line">conf.setClass(&quot;mapred.map.output.compression.codec&quot;,GzipCodec.class, CompressionCodec.class);</span><br><span class="line">// Reduce 端输出压缩</span><br><span class="line">conf.setBoolean(&quot;mapred.out.compress&quot;,true);</span><br><span class="line">conf.setClass(&quot;mapred.output.compression.codec&quot;,SnappyCodec.class,CompressionCodec.class);	</span><br><span class="line"></span><br><span class="line">/ /或者</span><br><span class="line"></span><br><span class="line">FileOutputFormat.setCompressOutput(job, true);  </span><br><span class="line">FileOutputFormat.setOutputCompressorClass(job, SnappyCodec.class);</span><br></pre></td></tr></table></figure>
<h3 id="配置文件："><a href="#配置文件：" class="headerlink" title="配置文件："></a>配置文件：</h3><p>找到mapred-site.xml文件。  如： 我公司集群环境配置。<br>Map端输出压缩配置：  我希望Map段输出压缩，并使用Snappy算法压缩<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;mapred.compress.map.output&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;true&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"> &lt;property&gt;</span><br><span class="line">    &lt;name&gt;mapred.map.output.compression.codec&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;org.apache.hadoop.io.compress.SnappyCodec&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line">/*Reduce端输出压缩配置： 我不希望Reduce的输出文件进行压缩。所以使用默认*/</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;mapred.output.compress&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;false&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;mapred.output.compression.codec&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;org.apache.hadoop.io.compress.DefaultCodec&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>提示： 如果使用的CDH版本，按照Cloudera官网的Hadoop配置，默认配置了Mapper阶段进行文件压缩。</p>
</blockquote>
<h2 id="项目实战运用"><a href="#项目实战运用" class="headerlink" title="项目实战运用"></a>项目实战运用</h2><p><strong>如下是参考的一篇博客的介绍，并非个人实战经验，有待验证</strong></p>
<p>项目中使用clearspring公司开源的基数估计的概率算法：stream-lib，用于解决去重计算问题，如UV计算等，它的特点在于：</p>
<ul>
<li>一个UV的计算，可以限制在一个固定大小的位图空间内完成（不同大小，对应不同的误差率），如8K，64K；</li>
<li>不同的位图可以进行合并操作，得到合并后的UV。<br>当系统中维护的位图越多的时候，不管是在内存中，还是在存储系统（MySQL、HBase等）中，都会占用相当大的存储空间。因此，需要考虑采取合适的算法来压缩位图。这里分为以下两类情况：</li>
<li>当位图在内存中时，此时压缩算法的选择，必须有尽可能快的压缩和解压速度，同时不能消耗过多CPU资源，因此，适合使用LZO或Snappy这样的压缩算法，做到快速的压缩和解压；</li>
<li>当位图存储到DB中时，更关注的是存储空间的节省，要有尽可能高的压缩率，因此，适合使用GZIP这样的压缩算法，同时在从内存Dump到DB的过程也可以减少网络IO的传输开销。</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/12/16/2014/Hadoop日常实战 计数器/" itemprop="url">
                  Hadoop日常实战 计数器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-12-16T17:26:00+08:00" content="2014-12-16">
              2014-12-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Distributed-Development/" itemprop="url" rel="index">
                    <span itemprop="name">Distributed Development</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Distributed-Development/Hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">Hadoop</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/12/16/2014/Hadoop日常实战 计数器/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/12/16/2014/Hadoop日常实战 计数器/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>计数器是一种收集作业统计信息的有效有段</p>
<p>  <strong>在一般情况下，我很需要了解一下Mapreduce 的运行情况，运行的过程是不可见，程序运行成功，但我们不能保证数据是正确的。我们需要质量控制、应用级统计。计数器可以辅助诊断系统故障，检测某一事件是否发生。计数特定属性、方法、异常。然后进一步分析程序数据的正确性。</strong></p>
<h2 id="内置计数器控制台视图"><a href="#内置计数器控制台视图" class="headerlink" title="内置计数器控制台视图"></a>内置计数器控制台视图</h2><p>Hadoop 中的内置计数器，用于帮助你分析Mapreduce执行程序的具体状体。</p>
<p>如下是<code>Hadoop 2.0.0-cdh4.7.0</code> Hadoop Mapreudce执行程序控制台显示</p>
<img src="/2014/12/16/2014/Hadoop日常实战%20计数器/QQ图片20141211110508.png" alt="内置计数器" title="内置计数器">
<p> <strong>Counter有组（group）的概念，用于表示逻辑上相同范围的所有数值。</strong><br>上图默认输出Counter分为三个组，从中我们可以分析出程序运行使用 CPU、内存、IO读写、网络流量的一个基本情况 </p>
<p>文章推荐: <a href="http://www.cnblogs.com/ggjucheng/archive/2013/05/08/3065220.html" target="_blank" rel="external">http://www.cnblogs.com/ggjucheng/archive/2013/05/08/3065220.html</a></p>
<h2 id="内置计数器的分类："><a href="#内置计数器的分类：" class="headerlink" title="内置计数器的分类："></a>内置计数器的分类：</h2><table>
<thead>
<tr>
<th>分组</th>
<th>属性名</th>
</tr>
</thead>
<tbody>
<tr>
<td>Mapreduce任务计数器</td>
<td>org.apache.hadoop.mapreduce. TaskCounter</td>
</tr>
<tr>
<td>任务计数器</td>
<td>org.apache.hadoop.mapreduce. JobCounter</td>
</tr>
<tr>
<td>文件系统计数器</td>
<td>org.apache.hadoop.mapreduce.FileSystemCounter</td>
</tr>
<tr>
<td>输入文件计数器</td>
<td>org.apache.hadoop.mapreduce.lib.input. FileInputFormatCounter</td>
</tr>
<tr>
<td>输出文件计数器</td>
<td>org.apache.hadoop.mapreduce.lib.output. FileOutputFormatCounter</td>
</tr>
</tbody>
</table>
<p><strong>这些就是hadoop 内置的计数器类（组），均是枚举类型。</strong></p>
<h2 id="静态计数器和动态计数器"><a href="#静态计数器和动态计数器" class="headerlink" title="静态计数器和动态计数器"></a>静态计数器和动态计数器</h2><ul>
<li><p>静态计数器<br><strong>定义一个枚举(enum) 枚举的名称即使Counter组的名称。 枚举属性即使要记录的数值名称，Mapreduce框架将跨所有map和reduce聚集这些计数器，并在作业结束时产生一个结果。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">static enum ReporInfo&#123;</span><br><span class="line">    // 统计map端读取数据是否按预期。 MISSING输出为0，表示没有输入数据完整或无缺损。</span><br><span class="line">  MISSING</span><br><span class="line">&#125;</span><br><span class="line">//通过Mapper中的context对象进行计数</span><br><span class="line">context.getCounter(Temperature.MISSING).increment(1);</span><br></pre></td></tr></table></figure>
</li>
<li><p>动态计数器<br><strong>动态计数器使用更加简单,你需要指定两个变量，这个变量均是动态指定。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 组的名称  和  动态计数的字段名称</span><br><span class="line">context.getCounter(&quot;group name&quot;,&quot;dynamic args&quot;).increment(1);</span><br></pre></td></tr></table></figure>
</li>
<li><p>比较<br><strong>静态类型： 先将java枚举类型转换成String类型，再通过RPC发送计数器，两种创建和访问计数器方法(枚举类型和String类型) 实际是等价的。<br>相比之下，枚举类型易于使用，还提供类型安全，使用与大多数作业，特定场合使用动态计数器。</strong></p>
</li>
</ul>
<h2 id="通过计数器获取Mapreduce的运行情况"><a href="#通过计数器获取Mapreduce的运行情况" class="headerlink" title="通过计数器获取Mapreduce的运行情况"></a>通过计数器获取Mapreduce的运行情况</h2><p>获取计数器：  作业长时间运行，我们需要通过计数器了解运行情况。我们只需要写一个监听类就可以。<br>如下是Mapreduce2.0写法，同样需要引用1.0中的JobClient类。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">String jobID = args[0];</span><br><span class="line">JobClient jobClient = new JobClient(new JobConf(getConf()));</span><br><span class="line">RunningJob job = jobClient.getJob(JobID.forName(jobID));</span><br><span class="line">Counters counters = job.getCounters();</span><br><span class="line">long missing = counters.getCounter(</span><br><span class="line">MaxTemperatureWithCounters.Temperature.MISSING);</span><br><span class="line">    </span><br><span class="line">long total = counters.getCounter(Task.Counter.MAP_INPUT_RECORDS);</span><br><span class="line"></span><br><span class="line">System.out.printf(&quot;Records with missing temperature fields: %.2f%%\n&quot;,100.0 * missing / total);</span><br></pre></td></tr></table></figure></p>
<h2 id="计数器原理"><a href="#计数器原理" class="headerlink" title="计数器原理"></a>计数器原理</h2><img src="/2014/12/16/2014/Hadoop日常实战%20计数器/c5c20a58-0087-49b2-a5d5-91ca4ae38066.jpg" alt="计数器原理图" title="计数器原理图">
<ul>
<li>计数器实质是由JobTracker维护，计数器值会定期传到tasktracker，在由tasktracker传递给jobtracker。也就是说所有的计数器信息都是存在jobTracker的内存中，计数器序列化并状态更新同步到JobTracker。</li>
<li>TaskTracker中累加计数器 记录单节点中的计数个数。通过“心跳“ 传递信息给JobTracker。</li>
<li>JobTracker会下运行结束之前最终汇总时剔除掉失败任务计数器。</li>
</ul>
<p>Mapreduce1.0中并没有限制计数器的个数，极其影响程序性能。<br>为了不对JobTracker产生印象。计数器数目应当控制到100以下。</p>
<p>如果你的计数器超过了120个就会报如下错误：<br>org.apache.hadoop.mapreduce.counters.LimitExceededException: Too many counters: 121 max=120</p>
<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><p>你可能遇到如下异常<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">14/12/12 09:56:48 INFO mapred.JobClient: Task Id : attempt_201412091419_0236_m_000028_0, Status : FAILED</span><br><span class="line">Error: Found interface org.apache.hadoop.mapreduce.Counter, but class was expected</span><br></pre></td></tr></table></figure></p>
<ul>
<li>原因：<br><strong>你本地的使用的编译环境是Hadoop1.0(MR1) 而你的集群环境为hadoop2.0(MR2) 所以默认没有找到。</strong></li>
<li>解决方案<br>更改为hadoop2.0(hadoop-mapreduce-client-core-2.0.0-cdh4.7.0.jar，hadoop-common-2.0.0-cdh4.7.0.jar)的jar。和集群环境保持一致。</li>
</ul>
<p>推荐Blog：<br><a href="http://langyu.iteye.com/blog/1171091" target="_blank" rel="external">http://langyu.iteye.com/blog/1171091</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/11/28/2014/Linux sftp 进行文件传输/" itemprop="url">
                  Linux sftp 进行文件传输
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-11-28T20:32:00+08:00" content="2014-11-28">
              2014-11-28
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Operating-System/" itemprop="url" rel="index">
                    <span itemprop="name">Operating System</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Operating-System/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/11/28/2014/Linux sftp 进行文件传输/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/11/28/2014/Linux sftp 进行文件传输/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>使用Winscp 进行Window 和 Linux 之间进行文件传输确实很方便，你只需要拖拽就可以，非常方便。</p>
<p>Linux 与 Linux 之间进行文件传输，我们可以直接使用scp命令即可。</p>
<p>这里介绍 sftp 进行文件传输， 我习惯使用SecureCRT（SSH终端仿真程序）进行sftp操作。</p>
<p>同样，你可以使用rs、sz 进行文件传输，它只作用于单文件传输。</p>
<h2 id="sftp-基础命令"><a href="#sftp-基础命令" class="headerlink" title="sftp 基础命令"></a>sftp 基础命令</h2><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>ascii</td>
<td>Set transfer mode to ASCII</td>
</tr>
<tr>
<td>binary</td>
<td>Set transfer mode to binary</td>
</tr>
<tr>
<td>cd path</td>
<td>更改远程目录到”路径”</td>
</tr>
<tr>
<td>detail remote-path</td>
<td>显示系统信息关于远程文件或文件夹</td>
</tr>
<tr>
<td>ldetail local-path</td>
<td>显示系统信息关于本地文件或文件夹</td>
</tr>
<tr>
<td>lcd path</td>
<td>更改本地目录到”路径” </td>
</tr>
<tr>
<td>chgrp group path</td>
<td>将文件”path”的权限更改为”mode” </td>
</tr>
<tr>
<td>chmod mode path</td>
<td>将文件”path”的权限更改为”mode” </td>
</tr>
<tr>
<td>chown owner path</td>
<td>将文件”path”的属主更改为”owner” </td>
</tr>
<tr>
<td>exit</td>
<td>退出 sftp </td>
</tr>
<tr>
<td>help</td>
<td>显示帮助文本</td>
</tr>
<tr>
<td>include filename</td>
<td>Include commands from ‘filename’ Alternate: &lt; filename</td>
</tr>
<tr>
<td>get [-a l -b] remote-path</td>
<td>Download file force ascii (-a) or binary (-b) mode 下载文件</td>
</tr>
<tr>
<td>ln [-s] existingpath linkpath</td>
<td>Hardlink / symlink remote file</td>
</tr>
<tr>
<td>ls [options] [path]</td>
<td>符号链接远程文件 </td>
</tr>
<tr>
<td>lls [options] [path]</td>
<td>显示本地目录列表 </td>
</tr>
<tr>
<td>mkdir path</td>
<td>创建远程目录 </td>
</tr>
<tr>
<td>lmkdir path</td>
<td>创建本地目录</td>
</tr>
<tr>
<td>mv oldpath newpath</td>
<td>移动远程文件</td>
</tr>
<tr>
<td>open [user@]host[:port]</td>
<td>连接到远程主机</td>
</tr>
<tr>
<td>put [-a l -b] local-path</td>
<td>Upload file force ascii (-a) or binary (-b) mode 上传文件</td>
</tr>
<tr>
<td>pwd</td>
<td>打印本地工作目录</td>
</tr>
<tr>
<td>lpwd</td>
<td>打印本地工作目录</td>
</tr>
<tr>
<td>quit</td>
<td>退出 sftp</td>
</tr>
<tr>
<td>rmdir path</td>
<td>移除远程目录</td>
</tr>
<tr>
<td>lrmdir path</td>
<td>移除本地目录 </td>
</tr>
<tr>
<td>rm path</td>
<td>删除远程文件</td>
</tr>
<tr>
<td>lrm path</td>
<td>删除本地文件</td>
</tr>
<tr>
<td>su username</td>
<td>Substitutes the current user This is only supported with VShell for Windows 3.5 or later.</td>
</tr>
<tr>
<td>type [transfer-mode]</td>
<td>Display or set file transfer mode</td>
</tr>
<tr>
<td>view remote-path</td>
<td>Download and open file</td>
</tr>
<tr>
<td>version</td>
<td>显示协议版本</td>
</tr>
</tbody>
</table>
<h2 id="进入sftp-模式"><a href="#进入sftp-模式" class="headerlink" title="进入sftp 模式"></a>进入sftp 模式</h2><ul>
<li>命令行模式下输入 ：<code>sftp 用户名@IP地址</code> ， 然后会提示你输入密码</li>
<li>如果是SecureCRT。 <code>Alt+p</code> 或者 <code>File -&gt; 链接sftp</code></li>
</ul>
<h2 id="sftp-基本使用"><a href="#sftp-基本使用" class="headerlink" title="sftp 基本使用"></a>sftp 基本使用</h2><p>sftp主要是用来传输文件的，所以我们主要使用两个命令。</p>
<blockquote>
<p>提示 </p>
<h3 id="文件上传-（从本机到远程主机）"><a href="#文件上传-（从本机到远程主机）" class="headerlink" title="文件上传 （从本机到远程主机）"></a>文件上传 （从本机到远程主机）</h3></blockquote>
<p><strong>使用 put [-Ppr] local [remote]</strong></p>
<p><strong>实例1： 上传单个文件</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">// 查看Window 当前目录</span><br><span class="line">sftp&gt; lpwd</span><br><span class="line">C:/Users/root/Documents</span><br><span class="line"></span><br><span class="line">// 切换Window 上传目录</span><br><span class="line">sftp&gt; lcd d:/temp </span><br><span class="line">// 查看roles.csv文件</span><br><span class="line">sftp&gt; lls -l</span><br><span class="line"> Oct 23, 2014 14:30 </span><br><span class="line"> Oct 21, 2014 11:21 actors.csv</span><br><span class="line"> Nov 10, 2014 11:01 ali</span><br><span class="line"> Oct 21, 2014 11:19 movies.csv</span><br><span class="line"> Jan 14, 2014 16:56 neo4j</span><br><span class="line"> Oct 28, 2014 17:40 package.json</span><br><span class="line"> Oct 21, 2014 11:21 roles.csv</span><br><span class="line"> Nov 30, 2014 20:54 TV.war</span><br><span class="line"> // 查看当前终端路径</span><br><span class="line">sftp&gt; pwd                </span><br><span class="line">/usr/local/program/server_tool/apache-tomcat-7.0.32/webapps</span><br><span class="line"></span><br><span class="line">// 切换到上传路径</span><br><span class="line">sftp&gt; cd ~</span><br><span class="line">sftp&gt; pwd</span><br><span class="line">/home/centos</span><br><span class="line"></span><br><span class="line">// 使用put 进行文件上传</span><br><span class="line">sftp&gt; put roles.csv ./</span><br><span class="line">Uploading roles.csv to /home/centos/roles.csv</span><br><span class="line">Skipping directory d:/temp</span><br><span class="line">  100% 367 bytes    367 bytes/s 00:00:00     </span><br><span class="line">d:/temp/roles.csv: 367 bytes transferred in 0 seconds (367 bytes/s)</span><br><span class="line"></span><br><span class="line">// 查看，ok 成功的。</span><br><span class="line">sftp&gt; ls</span><br><span class="line">roles.csv</span><br></pre></td></tr></table></figure></p>
<p><strong>实例2： 上传文件目录</strong><br><code>put -r 目录名称 目录名称</code> <code>-r</code> 表示文件夹。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 很简单，参考实例1。 默认上传当前路径</span><br><span class="line">put -r download/</span><br></pre></td></tr></table></figure></p>
<p><strong>实例3： 上传所有文件</strong></p>
<ul>
<li><p>上传当前所有文件 到 远程目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">put *</span><br></pre></td></tr></table></figure>
</li>
<li><p>上传当前所有文件及其文件夹 到 远程目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">put -r *</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="文件下载-从远程主机到本机"><a href="#文件下载-从远程主机到本机" class="headerlink" title="文件下载(从远程主机到本机)"></a>文件下载(从远程主机到本机)</h3><p><strong>使用 get [-Ppr] remote [local]</strong></p>
<p><strong>关于get (文件下载)说明和实例 略。   参考put (文件上传) 。 两则异曲同工</strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/11/07/2014/Linux 开发环境安装指南/" itemprop="url">
                  Linux 开发环境安装指南
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-11-07T16:53:00+08:00" content="2014-11-07">
              2014-11-07
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Operating-System/" itemprop="url" rel="index">
                    <span itemprop="name">Operating System</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Operating-System/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/11/07/2014/Linux 开发环境安装指南/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/11/07/2014/Linux 开发环境安装指南/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>我的Linux (Centos)开发、应用部署环境，持续更新</strong></p>
<h2 id="安装JDK1-8"><a href="#安装JDK1-8" class="headerlink" title="安装JDK1.8"></a>安装JDK1.8</h2><h3 id="查看Linux-自带的JDK是否安装"><a href="#查看Linux-自带的JDK是否安装" class="headerlink" title="查看Linux 自带的JDK是否安装"></a>查看Linux 自带的JDK是否安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -version</span><br></pre></td></tr></table></figure>
<img src="/2014/11/07/2014/Linux%20开发环境安装指南/596f24a9-b58f-40e3-b02c-6cfdf4c58dab.png" alt="已安装OpenJDK7 运行环境，但没有编译环境" title="已安装OpenJDK7 运行环境，但没有编译环境">
<h3 id="卸载自带JDK"><a href="#卸载自带JDK" class="headerlink" title="卸载自带JDK"></a>卸载自带JDK</h3><h4 id="查看相关依赖"><a href="#查看相关依赖" class="headerlink" title="查看相关依赖"></a>查看相关依赖</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa | grep java</span><br><span class="line"></span><br><span class="line">或则</span><br><span class="line"></span><br><span class="line">rmp -qa |grep jdk</span><br></pre></td></tr></table></figure>
<img src="/2014/11/07/2014/Linux%20开发环境安装指南/2310dfba-98e6-478a-890e-11291c66f2d1.png" alt="已安装OpenJDK7的相关依赖" title="已安装OpenJDK7的相关依赖">
<h4 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -e --nodeps java-1.7.0-openjdk-1.7.0.75-2.5.4.2.el7_0.x86_64</span><br><span class="line">rpm -e --nodeps java-1.7.0-openjdk-headless-1.7.0.75-2.5.4.2.el7_0.x86_64</span><br></pre></td></tr></table></figure>
<h3 id="下载JDK1-8"><a href="#下载JDK1-8" class="headerlink" title="下载JDK1.8"></a>下载JDK1.8</h3><p>在Oracle 选择合适的版本，进行JDK安装，这里更新至JDK1.8<br><strong>Oracle官网上下载jdk，需要点击accept licence的才能下载，使用下面的命令，直接可以下载。</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget --no-check-certificate --no-cookies --header &quot;Cookie: oraclelicense=accept-securebackup-cookie&quot; http://download.oracle.com/otn-pub/java/jdk/8u73-b02/jdk-8u73-linux-x64.tar.gz</span><br></pre></td></tr></table></figure></p>
<h3 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h3><p>-C 表示解压路径<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf jdk-8u73-linux-x64.tar.gz -C /usr/local/jdk/</span><br></pre></td></tr></table></figure></p>
<h3 id="环境变量配置"><a href="#环境变量配置" class="headerlink" title="环境变量配置"></a>环境变量配置</h3><ul>
<li><p>修改 <code>/etc/profile</code>文件,添加如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br><span class="line">//添加如下</span><br><span class="line"></span><br><span class="line">JAVA_HOME=/usr/local/jdk/jdk1.8.0_73</span><br><span class="line">CLASSPATH=$CLASSPATH:$JAVA_HOME/lib:.</span><br><span class="line">PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line"></span><br><span class="line">export PATH</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新加载配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="安装-Mysql-5-7-11"><a href="#安装-Mysql-5-7-11" class="headerlink" title="安装 Mysql 5.7.11"></a>安装 Mysql 5.7.11</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><strong>这里更新至最新版Mysql5.7.11 源码(这里采用编译安装)</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://cdn.mysql.com/Downloads/MySQL-5.7/mysql-5.7.11.tar.gz</span><br></pre></td></tr></table></figure></p>
<h3 id="解压-1"><a href="#解压-1" class="headerlink" title="解压"></a>解压</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf mysql-5.7.11.tar.gz</span><br></pre></td></tr></table></figure>
<h3 id="安装必要的包"><a href="#安装必要的包" class="headerlink" title="安装必要的包"></a>安装必要的包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install cmake gcc gcc-c++ ncurses-devel perl-Data-Dumper</span><br></pre></td></tr></table></figure>
<h3 id="安装Boost"><a href="#安装Boost" class="headerlink" title="安装Boost"></a>安装Boost</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://jaist.dl.sourceforge.net/project/boost/boost/1.59.0/boost_1_59_0.zip unzip boost_1_59_0.zip</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">unzip boost_1_59_0.zip </span><br><span class="line">cd boost_1_59_0 </span><br><span class="line">./bootstrap.sh  </span><br><span class="line">./b2 </span><br><span class="line">./b2 install</span><br></pre></td></tr></table></figure>
<h3 id="生成makefile-和-编译"><a href="#生成makefile-和-编译" class="headerlink" title="生成makefile 和 编译"></a>生成makefile 和 编译</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd mysql-5.7.11</span><br><span class="line">// 生成makefile</span><br><span class="line">cmake .</span><br><span class="line">// 编译</span><br><span class="line">make</span><br></pre></td></tr></table></figure>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make install</span><br><span class="line"></span><br><span class="line">// mysql 将会安装到/usr/local/mysql路径</span><br></pre></td></tr></table></figure>
<h3 id="添加mysql用户和组"><a href="#添加mysql用户和组" class="headerlink" title="添加mysql用户和组"></a>添加mysql用户和组</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//创建mysql 组</span><br><span class="line">sudo groupadd mysql</span><br><span class="line">// 创建mysql用户 所属组为mysql</span><br><span class="line">sudo useradd -r -g mysql mysql</span><br></pre></td></tr></table></figure>
<h3 id="修改目录和文件权限，安装默认数据库"><a href="#修改目录和文件权限，安装默认数据库" class="headerlink" title="修改目录和文件权限，安装默认数据库"></a>修改目录和文件权限，安装默认数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo chown -R mysql.</span><br><span class="line">sudo chgrp -R mysql.</span><br><span class="line">bin/mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data</span><br><span class="line">bin/mysql_ssl_rsa_setup </span><br><span class="line">sudo chown -R root .</span><br><span class="line">sudo chown -R mysql data</span><br></pre></td></tr></table></figure>
<h3 id="创建-etc-my-cnf文件"><a href="#创建-etc-my-cnf文件" class="headerlink" title="创建/etc/my.cnf文件"></a>创建/etc/my.cnf文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/mysql/support-files/my-default.cnf /etc/my.cnf</span><br><span class="line">vi /etc/my.cnf</span><br><span class="line">// 增加如下</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">server_id = 1</span><br><span class="line">#binary log</span><br><span class="line">log-bin = mysql-bin</span><br><span class="line">binlog_format = mixed</span><br><span class="line"># expire_logs_day = 30</span><br><span class="line">#slow query log</span><br><span class="line">slow_query_log = 1</span><br><span class="line">slow_query_log_file = /var/log/mysql/slow.log</span><br><span class="line">long_query_time = 3</span><br><span class="line">log-queries-not-using-indexes</span><br><span class="line">log-slow-admin-statements</span><br><span class="line"># 这里忽略密码了，重设密码后，应当删除</span><br><span class="line">skip-grant-tables</span><br></pre></td></tr></table></figure>
<h3 id="复制mysql服务启动脚本并加入PATH路径"><a href="#复制mysql服务启动脚本并加入PATH路径" class="headerlink" title="复制mysql服务启动脚本并加入PATH路径"></a>复制mysql服务启动脚本并加入PATH路径</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">vim /etc/profile</span><br><span class="line">// 添加如下</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PATH=/usr/local/mysql/bin:/usr/local/mysql/lib:$PATH:.</span><br><span class="line">export PATH</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<h3 id="启动Mysql-并加入开机自动启动"><a href="#启动Mysql-并加入开机自动启动" class="headerlink" title="启动Mysql 并加入开机自动启动"></a>启动Mysql 并加入开机自动启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service mysqld start </span><br><span class="line">chkconfig --level 35 mysqld on</span><br></pre></td></tr></table></figure>
<h3 id="重设密码"><a href="#重设密码" class="headerlink" title="重设密码"></a>重设密码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot</span><br><span class="line"></span><br><span class="line">//选择数据库</span><br><span class="line">use mysql</span><br><span class="line">// 设置密码。 5.7 相比5.5 user表中password字段改为authentication_string。如下</span><br><span class="line">update user set authentication_string=PASSWORD(&apos;123456&apos;) where user=&apos;root&apos; and host=&apos;localhost&apos;;</span><br><span class="line">//更新权限表</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/04/13/2014/Maven3 setting.xml 设置/" itemprop="url">
                  Maven3 setting.xml 设置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-04-13T16:54:00+08:00" content="2014-04-13">
              2014-04-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Project-Build/" itemprop="url" rel="index">
                    <span itemprop="name">Project Build</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Project-Build/Maven/" itemprop="url" rel="index">
                    <span itemprop="name">Maven</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/04/13/2014/Maven3 setting.xml 设置/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/04/13/2014/Maven3 setting.xml 设置/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="不要修改setting-xml地址-和-仓库地址地址"><a href="#不要修改setting-xml地址-和-仓库地址地址" class="headerlink" title="不要修改setting.xml地址 和 仓库地址地址"></a>不要修改setting.xml地址 和 仓库地址地址</h2><p>Maven3 默认setting.xml文件地址和仓库地址为：</p>
<blockquote>
<p>C:/Users/用户名称/.m2/setting.xml<br>C:/Users/用户名称/.m2/repository</p>
</blockquote>
<p><strong>你可能觉得仓库地址在C盘有点不合理，它在我指定的目录不是更好吗？  例如：D:/Work-Repository/Maven-Repository</strong></p>
<p>于是：</p>
<ul>
<li>你复制setting.xml 文件到 D:/Work-Repository/Maven-Repository</li>
<li><p>修改setting.xml Maven仓库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;localRepository&gt;D:/Work-Repository/Mvn-Repository&lt;/localRepository&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改STS/IDEA/MyEclipse 中的setting.xml 地址</p>
</li>
<li>OK，你成功。</li>
</ul>
<p>但是：<br><strong>你可能忘了你有多个工作目录。偶尔你新建一个工作目录，忘了改setting.xml<br>糟糕的事情发生了</strong></p>
<ul>
<li>为什么还要重复下载Jar？</li>
<li>八嘎！ 为什么两个仓库都在用啊~~   恍然大悟！！</li>
</ul>
<h2 id="修改你的镜像地址"><a href="#修改你的镜像地址" class="headerlink" title="修改你的镜像地址"></a>修改你的镜像地址</h2><p>国外的源总是缓慢的，比如：</p>
<blockquote>
<p><a href="http://my.repository.com/repo/path" target="_blank" rel="external">http://my.repository.com/repo/path</a></p>
</blockquote>
<p>使用OSChina Maven仓库，如下配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;mirrors&gt;</span><br><span class="line"></span><br><span class="line">  &lt;mirror&gt;</span><br><span class="line">    &lt;id&gt;mirrorId&lt;/id&gt;</span><br><span class="line">    &lt;mirrorOf&gt;repositoryId&lt;/mirrorOf&gt;</span><br><span class="line">    &lt;name&gt;Human Readable Name for this Mirror.&lt;/name&gt;</span><br><span class="line">    &lt;url&gt;http://my.repository.com/repo/path&lt;/url&gt;</span><br><span class="line">  &lt;/mirror&gt;</span><br><span class="line">  </span><br><span class="line">&lt;/mirrors&gt;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>提示，OSChina源也有不好使的地方，比如：引入嵌入式数据库： H2，它就找不到，这个时候，你需要切换到其他源或在pom.xml 指定下载源地址。</p>
</blockquote>
<h2 id="想到了，日后再更新。"><a href="#想到了，日后再更新。" class="headerlink" title="想到了，日后再更新。"></a>想到了，日后再更新。</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/04/04/2014/MyBatis 与 第三方框架集成/" itemprop="url">
                  MyBatis 与 第三方框架集成
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-04-04T22:09:00+08:00" content="2014-04-04">
              2014-04-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Java-Web/" itemprop="url" rel="index">
                    <span itemprop="name">Java Web</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Java-Web/Mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">Mybatis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/04/04/2014/MyBatis 与 第三方框架集成/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/04/04/2014/MyBatis 与 第三方框架集成/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>MyBatis 集成第三方框架应用集成</strong></p>
<h2 id="与Spring-集成"><a href="#与Spring-集成" class="headerlink" title="与Spring 集成"></a>与Spring 集成</h2><h3 id="Spring-介绍"><a href="#Spring-介绍" class="headerlink" title="Spring 介绍"></a>Spring 介绍</h3><p>   Spring 框 架 是 一 个 基 于 依 赖 注 入 （ Dependency Injection ） 和 面 向 切 面 编 程 (Aspect Oriented Programming,AOP)的 Java 框架，鼓励使用基于 POJO 的编程模型。另外，Spring 提供了声明式和编程式的事务管理能力，可以很大程度上简化应用程序的数据访问层（data access layer）的实现。</p>
<p><strong>MyBatis-Spring 是 MyBatis 框架的子模块，用于与Spring 进行无缝集成。</strong><br>使用 Spring 的基于注解的事务管理机制将大大简化MyBatis 事务管理操作。</p>
<ul>
<li>MyBatis 与 Spring 框架集成<ul>
<li>依赖整合</li>
<li>Spring 应用程序中配置 MyBatis<ul>
<li>ApplicationContext 上注册 MyBatis bean 实体对象</li>
</ul>
</li>
<li>配置和注入 SqlSession 和 Mapperbean 实体对象以及调用映射语句<ul>
<li>使用SqlSession</li>
<li>使用映射器</li>
</ul>
</li>
<li>Spring 基于注解的事务处理机制来使用 MyBatis</li>
</ul>
</li>
</ul>
<h3 id="Spring-应用程序中配置-MyBatis"><a href="#Spring-应用程序中配置-MyBatis" class="headerlink" title="Spring 应用程序中配置 MyBatis"></a>Spring 应用程序中配置 MyBatis</h3><h4 id="Maven-进行依赖管理"><a href="#Maven-进行依赖管理" class="headerlink" title="Maven 进行依赖管理"></a>Maven 进行依赖管理</h4><p>如下是使用Maven进行项目依赖管理（Spring 4 + MyBatis3）。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">	xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">	&lt;groupId&gt;org.freecode&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;spring_mybatis&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">	&lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">	&lt;name&gt;spring_mybatis&lt;/name&gt;</span><br><span class="line">	&lt;url&gt;http://maven.apache.org&lt;/url&gt;</span><br><span class="line"></span><br><span class="line">	&lt;properties&gt;</span><br><span class="line">		&lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">		&lt;java.version&gt;1.7&lt;/java.version&gt;</span><br><span class="line">		&lt;junit.version&gt;4.11&lt;/junit.version&gt;</span><br><span class="line">		&lt;slf4j.version&gt;1.7.5&lt;/slf4j.version&gt;</span><br><span class="line">		&lt;log4j.version&gt;1.2.17&lt;/log4j.version&gt;</span><br><span class="line">		&lt;mybatis.version&gt;3.2.6&lt;/mybatis.version&gt;</span><br><span class="line">		&lt;mybatis-spring.version&gt;1.2.2&lt;/mybatis-spring.version&gt;</span><br><span class="line">		&lt;mysql.version&gt;5.1.21&lt;/mysql.version&gt;</span><br><span class="line"></span><br><span class="line">		&lt;spring.version&gt;4.0.4.RELEASE&lt;/spring.version&gt;</span><br><span class="line">		&lt;aspectj.version&gt;1.6.8&lt;/aspectj.version&gt;</span><br><span class="line">		&lt;commons.dbcp.version&gt;1.4&lt;/commons.dbcp.version&gt;</span><br><span class="line">		&lt;commons.pool.version&gt;1.6&lt;/commons.pool.version&gt;</span><br><span class="line">		&lt;commons.lang.version&gt;2.5&lt;/commons.lang.version&gt;</span><br><span class="line"></span><br><span class="line">	&lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">	&lt;dependencies&gt;</span><br><span class="line">		&lt;!-- Test start --&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;$&#123;junit.version&#125;&lt;/version&gt;</span><br><span class="line">			&lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-test&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;$&#123;spring.version&#125;&lt;/version&gt;</span><br><span class="line">			&lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;!-- Test end --&gt;</span><br><span class="line"></span><br><span class="line">		&lt;!-- MyBatis start --&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.mybatis&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;mybatis&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;$&#123;mybatis.version&#125;&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.mybatis&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;mybatis-spring&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;$&#123;mybatis-spring.version&#125;&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;!-- MyBatis end --&gt;</span><br><span class="line"></span><br><span class="line">		&lt;!-- Spring start (不包含Spring Web) --&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-core&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;$&#123;spring.version&#125;&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-context&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;$&#123;spring.version&#125;&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-context-support&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;$&#123;spring.version&#125;&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-jdbc&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;$&#123;spring.version&#125;&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;!-- Spring end --&gt;</span><br><span class="line"></span><br><span class="line">		&lt;!-- MySql start --&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;$&#123;mysql.version&#125;&lt;/version&gt;</span><br><span class="line">			&lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;!-- MySql end --&gt;</span><br><span class="line"></span><br><span class="line">		&lt;!-- other start --&gt;</span><br><span class="line"></span><br><span class="line">		&lt;!-- other end --&gt;</span><br><span class="line"></span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.slf4j&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;$&#123;slf4j.version&#125;&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.slf4j&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;jcl-over-slf4j&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;$&#123;slf4j.version&#125;&lt;/version&gt;</span><br><span class="line">			&lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.slf4j&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;$&#123;slf4j.version&#125;&lt;/version&gt;</span><br><span class="line">			&lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;log4j&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;log4j&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;$&#123;log4j.version&#125;&lt;/version&gt;</span><br><span class="line">			&lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">	&lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">	&lt;build&gt;</span><br><span class="line">		&lt;plugins&gt;</span><br><span class="line">			&lt;plugin&gt;</span><br><span class="line">				&lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</span><br><span class="line">				&lt;configuration&gt;</span><br><span class="line">					&lt;source&gt;$&#123;java.version&#125;&lt;/source&gt;</span><br><span class="line">					&lt;target&gt;$&#123;java.version&#125;&lt;/target&gt;</span><br><span class="line">					&lt;encoding&gt;$&#123;project.build.sourceEncoding&#125;&lt;/encoding&gt;</span><br><span class="line">				&lt;/configuration&gt;</span><br><span class="line">			&lt;/plugin&gt;</span><br><span class="line">		&lt;/plugins&gt;</span><br><span class="line">	&lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure></p>
<p>如果你只使用 MyBatis 而没有使用 Spring，在每一个方法中，我们需要手动创建 SqlSessionFactory 对象，并且从 SqlSessionFactory 对象中创建SqlSession。而且我们还要负责提交或者回滚事务、关闭 SqlSession 对象。</p>
<p>通过使用 MyBatis-Spring 模块，我们可以在 Spring 的应用上下文 ApplicationContext 中配置 MyBatisBeans,Spring 会负责实例化 SqlSessionFactory 对象以及创建 SqlSession 对象，并将其注入到 DAO 或者 Service类中。并且，你可以使用 Spring 的基于注解的事务管理功能，不用自己在数据访问层中书写事务处理代码了。</p>
<h4 id="配置-MyBatis-Beans"><a href="#配置-MyBatis-Beans" class="headerlink" title="配置 MyBatis Beans"></a>配置 MyBatis Beans</h4><p>为了让 Spring 来实例化 MyBatis 组件如 SqlSessionFactory、SqlSession、以及映射器 Mapper 对象，我们需要在 Spring 的 bean 配置文件中配置它们，假设在 applicationContext.xml 中，配置如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;beans&gt;</span><br><span class="line">	&lt;bean id=&quot;dataSource&quot; class=&quot;org.springframework.jdbc.datasource. DriverManagerDataSource&quot;&gt;</span><br><span class="line">		&lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/test&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;username&quot; value=&quot;root&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;password&quot; value=&quot;admin&quot; /&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line">	&lt;bean id=&quot;sqlSessionFactory&quot; class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt;</span><br><span class="line">		&lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;typeAliases&quot; value=&quot;org.freecode.domain.Student, org.freecode.domain.Tutor&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;typeAliasesPackage&quot; value=&quot;org.freecode.domain&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;typeHandlers&quot; value=&quot;org.freecode.typehandlers.PhoneTypeHandler&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;typeHandlersPackage&quot; value=&quot;org.freecode.typehandlers&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;mapperLocations&quot; value=&quot;classpath*:org/freecode/**/*.xml&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;configLocation&quot; value=&quot;WEB-INF/mybatisconfig.xml&quot; /&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>使用上述的 bean 定义，Spring 会使用如下配置属性创建一个 SqlSessionFactory 对象：<ul>
<li>dataSource:它引用了 dataSource bean</li>
<li>typeAliases:它指定了一系列的完全限定名的类名列表，用逗号隔开，这些别名将通过默认的别名规则创建（将首字母小写的非无完全限定类名作为别名）。</li>
<li>typeAliasesPackage:它指定了一系列包名列表，用逗号隔开，包内含有需要创建别名的 JavaBeans。</li>
<li>typeHandlers:它指定了一系列的类型处理器类的完全限定名的类名列表，用逗号隔开。</li>
<li>typeHandlersPackage: 它指定了一系列包名列表，用逗号隔开，包内含有需要被注册的类型处理器类。</li>
<li>mapperLocations:它指定了 SQL 映射器 Mapper XML 配置文件的位置</li>
<li>configLocation:它指定了 MyBatisSqlSessionFactory 配置文件所在的位置。</li>
</ul>
</li>
</ul>
<h4 id="使用-SqlSession"><a href="#使用-SqlSession" class="headerlink" title="使用 SqlSession"></a>使用 SqlSession</h4><p>   一旦 SqlSessionFactory bean 被配置，我们需要配置 SqlSessionTemplate bean，SqlSessionTemplate bean是一个线程安全的 Spring bean，我们可以从中获取到线程安全的 SqlSession 对象。由于 SqlSessionTemplate 提供线程安全的 SqlSession 对象，你可以在多个 Spring bean 实体对象中共享 SqlSessionTemplate 对象。从概念上看，SqlSessionTemplate 和 Spring 的 DAO 模块中的 JdbcTemplate 非常相似。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;sqlSession&quot; class=&quot;org.mybatis.spring.SqlSessionTemplate&quot;&gt;</span><br><span class="line">	&lt;constructor-arg index=&quot;0&quot; ref=&quot;sqlSessionFactory&quot; /&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>
<p>现在我肯可以将 SqlSession bean 实体对象注射到任意的 Spring bean 实体中，然后使用 SqlSession 对象调用SQL 映射语句。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class StudentDaoImpl implements StudentDao &#123;</span><br><span class="line">	private SqlSession sqlSession;</span><br><span class="line">	public void setSqlSession(SqlSession session) &#123;</span><br><span class="line">		this.sqlSession = session;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void createStudent(Student student) &#123;</span><br><span class="line">		StudentMapper mapper = this.sqlSession.getMapper(StudentMapper.class);</span><br><span class="line">		mapper.insertStudent(student);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你正在使用基于 XML 来配置 Spring beans,你可以将 SqlSession bean 实体对象注射到 StudenDaoImplbean 实体对象中，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;studentDao&quot; class=&quot;org.freecode.dao.StudentDaoImpl&quot;&gt;</span><br><span class="line">	&lt;property name=&quot;sqlSession&quot; ref=&quot;sqlSession&quot; /&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>
<p>如果你使用基于注解的方式配置 Spring beans，你如下将 SqlSession bean 实体对象注入到 StudentDaoImplbean 实体对象中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Repository</span><br><span class="line">public class StudentDaoImpl implements StudentDao &#123;</span><br><span class="line">	private SqlSession sqlSession;</span><br><span class="line">	@Autowired</span><br><span class="line">	public void setSqlSession(SqlSession session) &#123;</span><br><span class="line">		this.sqlSession = session;</span><br><span class="line">	&#125;</span><br><span class="line">	public void createStudent(Student student) &#123;</span><br><span class="line">		StudentMapper mapper = this.sqlSession.getMapper(StudentMapper.class);</span><br><span class="line">		mapper.insertStudent(student);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>还有另外一种注入 Sqlsession 对象的方法，即，通过拓展继承 SqlSessionDaoSupport。这种方式让我们可以在执行映射语句时，加入任何自定义的逻辑。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class StudentMapperImpl extends SqlSessionDaoSupport implements StudentMapper &#123;</span><br><span class="line"></span><br><span class="line">	public void createStudent(Student student) &#123;</span><br><span class="line">		StudentMapper mapper = getSqlSession().getMapper(StudentMapper.class);</span><br><span class="line">		mapper.insertAddress(student.getAddress());</span><br><span class="line">		//Custom logic</span><br><span class="line">		mapper.insertStudent(student);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;studentMapper&quot; class=&quot;org.freecode.dao.StudentMapperImpl&quot;&gt;</span><br><span class="line">	&lt;property name=&quot;sqlSessionFactory&quot; ref=&quot;sqlSessionFactory&quot; /&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>
<p>在以上的这些方式中，我们注入了 SqlSession 对象，获取 Mapper 实例，然后执行映射语句。这里 Spring 会为我们提供一个线程安全的 SqlSession 对象，以及当方法结束后关闭 SqlSession 对象。<br>然而，MyBatis-Spring 模块提供了更好的方式，我们可以不通过 SqlSession 获取映射器 Mapper，直接注射 Sql映射器 Mapper bean。我们下节将讨论它。</p>
<h4 id="使用映射器"><a href="#使用映射器" class="headerlink" title="使用映射器"></a>使用映射器</h4><p>我们可以使用 MapperFactoryBean 将映射器 Mapper 接口配置成 Spring bean 实体。如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public interface StudentMapper &#123;</span><br><span class="line">	@Select(&quot;select stud_id as studId, name, email, phone from students where stud_id=#&#123;id&#125;&quot;)</span><br><span class="line">	Student findStudentById(Integer id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;studentMapper&quot; class=&quot;org.mybatis.spring.mapper.MapperFactoryBean&quot;&gt;</span><br><span class="line">	&lt;property name=&quot;mapperInterface&quot; value=&quot;org.freecode.mappers.StudentMapper&quot; /&gt;</span><br><span class="line">	&lt;property name=&quot;sqlSessionFactory&quot; ref=&quot;sqlSessionFactory&quot; /&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>
<p>现在 StudentMapper bean 实体对象可以被注入到任意的 Spring bean 实体对象中，并调用映射语句方法，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class StudentService &#123;</span><br><span class="line">	private StudentMapper studentMapper;</span><br><span class="line">	public void createStudent(Student student) &#123;</span><br><span class="line">		this.studentMapper.insertStudent(student);</span><br><span class="line">	&#125;</span><br><span class="line">	public void setStudentMapper (StudentMapperstudentMapper) &#123;</span><br><span class="line">		this. studentMapper = studentMapper;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;studentService&quot; class=&quot;org.freecode.services. StudentService&quot;&gt;</span><br><span class="line">	&lt;property name=&quot;studentMapper&quot; ref=&quot;studentMapper&quot; /&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>
<p>分别配置每一个映射器 Mapper 接口是一个非常单调的过程。我们可以使用 MapperScannerConfigurer 来扫描包（package）中的映射器 Mapper 接口，并自动地注册。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;</span><br><span class="line">	&lt;property name=&quot;basePackage&quot; value=&quot;org.freecode.mappers&quot; /&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure></p>
<p>如果映射器 Mapper 接口在不同的包(package)中，你可以为 basePackage 属性指定一个以逗号分隔的包名列表。</p>
<ul>
<li>MyBatis-Spring-1.2.0 介绍了两种新的扫描映射器 Mapper 接口的方法：<ul>
<li>使用<mybatis:scan>元素</mybatis:scan></li>
<li>使用@MapperScan 注解（需 Spring3.1+版本）<h4 id=""><a href="#" class="headerlink" title=""></a><mybatis:scan></mybatis:scan></h4><mybatis:scan>元素将在特定的以逗号分隔的包名列表中搜索映射器 Mapper 接口。使用这个新的 MyBatis-Spring 名空间你需要添加以下的 schema 声明：</mybatis:scan></li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">	xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">	xmlns:mybatis=&quot;http://mybatis.org/schema/mybatis-spring&quot;</span><br><span class="line">	xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans</span><br><span class="line">		http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">		http://mybatis.org/schema/mybatis-spring</span><br><span class="line">		http://mybatis.org/schema/mybatis-spring.xsd&quot;&gt;</span><br><span class="line">	&lt;mybatis:scan base-package=&quot;org.freecode.mappers&quot; /&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>&lt;mybatis:scan&gt;</code>元素提供了下列的属性来自定义扫描过程：<ul>
<li>annotation: 扫描器将注册所有的在 base-package 包内并且匹配指定注解的映射器 Mapper 接口。</li>
<li>factory-ref: 当 Spring 上 下 文 中 有 多 个 SqlSessionFactory 实 例 时 ， 需 要 指 定 某 一 特 定 的SqlSessionFactory 来创建映射器 Mapper 接口。正常情况下，只有应用程序中有一个以上的数据源才会使用。</li>
<li>marker-interface: 扫描器将注册在 base-package 包中的并且继承了特定的接口类的映射器 Mapper 接口</li>
<li>template-ref: 当 Spring 上 下 文 中 有 多 个 SqlSessionTemplate 实 例 时 ， 需 要 指 定 某 一 特 定 的SqlSessionTemplate 来创建映射器 Mapper 接口。正常情况下，只有应用程序中有一个以上的数据源才会使用。</li>
<li>name-generator:BeannameGenerator 类的完全限定类名，用来命名检测到的组件。<h4 id="MapperScan"><a href="#MapperScan" class="headerlink" title="MapperScan"></a>MapperScan</h4>Spring 框架 3.x+版本支持使用@Configuration 和@Bean 注解来提供基于 Java 的配置。如果你倾向于使用基于Java 的配置，你可以使用@MapperScan 注解来扫描映射器 Mapper接口。@MapperScan 和<mybatis:scan>工作方式相同，并且也提供了对应的自定义选项。</mybatis:scan></li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@MapperScan(&quot;org.freecode.mappers&quot;)</span><br><span class="line">public class AppConfig &#123;</span><br><span class="line">	@Bean</span><br><span class="line">	public DataSource dataSource() &#123;</span><br><span class="line">		return new PooledDataSource(&quot;com.mysql.jdbc.Driver&quot;,&quot;jdbc:mysql://localhost:3306/test&quot;, &quot;root&quot;, &quot;123456&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">	@Bean</span><br><span class="line">	public SqlSessionFactory sqlSessionFactory() throws Exception &#123;</span><br><span class="line">		SqlSessionFactoryBeansessionFactory = new SqlSessionFactoryBean();</span><br><span class="line">		sessionFactory.setDataSource(dataSource());</span><br><span class="line">		return sessionFactory.getObject();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>@MapperScan 注解有以下属性供自定义扫描过程使用:<ul>
<li>annotationClass: 扫描器将注册所有的在 base-package 包内并且匹配指定注解的映射器 Mapper 接口。</li>
<li>markerInterface: 扫描器将注册在 base-package 包中的并且继承了特定的接口类的映射器 Mapper 接口</li>
<li>sqlSessionFactoryRef: 当 Spring 上 下 文 中 有 一 个 以 上 的 SqlSesssionFactory 时 ， 用 来 指 定 特 定SqlSessionFactory</li>
<li>sqlSessionTemplateRef: 当 Spring 上下文 中有一 个以上的 sqlSessionTemplate 时，用 来 指定特定sqlSessionTemplate</li>
<li>nameGenerator:BeanNameGenerator 类用来命名在 Spring 容器内检测到的组件。</li>
<li>basePackageClasses:basePackages()的类型安全的替代品。包内的每一个类都会被扫描。</li>
<li>basePackages:扫描器扫描的基包，扫描器会扫描内部的 Mapper 接口。注意包内的至少有一个方法声明的才会被注册。具体类将会被忽略。</li>
</ul>
</li>
</ul>
<blockquote>
<p>与注入 Sqlsession 相比，更推荐使用注入 Mapper，因为它摆脱了对MyBatis API 的依赖。</p>
</blockquote>
<h4 id="使用-Spring-进行事务管理"><a href="#使用-Spring-进行事务管理" class="headerlink" title="使用 Spring 进行事务管理"></a>使用 Spring 进行事务管理</h4><p>只使用 MyBatis，你需要写事务控制相关代码，如提交或者回退数据库操作。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public Student createStudent(Student student) &#123;</span><br><span class="line">	SqlSession sqlSession = MyBatisUtil.getSqlSessionFactory().openSession();</span><br><span class="line">	try &#123;</span><br><span class="line">		StudentMapper mapper = sqlSession.getMapper(StudentMapper.class);</span><br><span class="line">		mapper.insertAddress(student.getAddress());</span><br><span class="line">		mapper.insertStudent(student);</span><br><span class="line">		sqlSession.commit();</span><br><span class="line">		return student;</span><br><span class="line">	&#125;catch (Exception e) &#123;</span><br><span class="line">		sqlSession.rollback();</span><br><span class="line">		throw new RuntimeException(e);</span><br><span class="line">	&#125; finally &#123;</span><br><span class="line">		sqlSession.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们可以使用 Spring 的基于注解的事务处理机制来避免书写上述的每个方法中控制事务的冗余代码。<br>为了能使用 Spring 的事务管理功能，我们需要在 Spring 应用上下文中配置 TransactionManager bean 实体对象：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;transactionManager&quot; class=&quot;org.springframework.jdbc. datasource.DataSourceTransactionManager&quot;&gt;</span><br><span class="line">	&lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure></p>
<p>事务管理器引用的 dataSource 和 SqlSessionFactory bean 使用的 dataSource 相同。<br>在 Spring 中使用基于注解的事务管理特性，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;tx:annotation-driven transaction-manager=&quot;transactionManager&quot;/&gt;</span><br></pre></td></tr></table></figure></p>
<p>现在你可以在 Spring service bean 上使用@Transactional 注解，表示在此 service 中的每一个方法都应该在一个事务中运行。如果方法成功运行完毕，Spring 会提交操作。如果有运行期异常发生，则会执行回滚操作。另外，Spring 会将 MyBatis 的异常转换成合适的 DataAccessExceptions，这样会为特定错误上提供额外的信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">@Transactional</span><br><span class="line">public class StudentService &#123;</span><br><span class="line">	@Autowired</span><br><span class="line">	private StudentMapper studentMapper;</span><br><span class="line">	public Student createStudent(Student student) &#123;</span><br><span class="line">		studentMapper.insertAddress(student.getAddress());</span><br><span class="line">		if(student.getName().equalsIgnoreCase(&quot;&quot;)) &#123;</span><br><span class="line">			throw new RuntimeException(&quot;Student name should not beempty.&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		studentMapper.insertStudent(student);</span><br><span class="line">		return student;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是一个 Spring 的 applicationContext.xml 完成配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;beans&gt;</span><br><span class="line">	&lt;context:annotation-config /&gt;</span><br><span class="line">	&lt;context:component-scan base-package=&quot;org.freecode&quot; /&gt;</span><br><span class="line">	&lt;context:property-placeholder location=&quot;classpath:application.properties&quot; /&gt;</span><br><span class="line">	&lt;tx:annotation-driven transaction-manager=&quot;transactionManager&quot; /&gt;</span><br><span class="line">	&lt;bean id=&quot;transactionManager&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;</span><br><span class="line">		&lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line">	&lt;bean class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;</span><br><span class="line">		&lt;property name=&quot;basePackage&quot; value=&quot;org.freecode.mappers&quot; /&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line">	&lt;bean id=&quot;sqlSession&quot; class=&quot;org.mybatis.spring.SqlSessionTemplate&quot;&gt;</span><br><span class="line">		&lt;constructor-arg index=&quot;0&quot; ref=&quot;sqlSessionFactory&quot; /&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line">	&lt;bean id=&quot;sqlSessionFactory&quot; class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt;</span><br><span class="line">		&lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;typeAliases&quot; value=&quot;org.freecode.domain.Student,org.freecode.domain.Tutor&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;typeAliasesPackage&quot; value=&quot;org.freecode.domain&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;typeHandlers&quot; value=&quot;org.freecode.typehandlers.PhoneTypeHandler&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;typeHandlersPackage&quot; value=&quot;org.freecode.typehandlers&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;mapperLocations&quot; value=&quot;classpath*:com/mybatis3/**/*.xml&quot; /&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line">	&lt;bean id=&quot;dataSource&quot; class=&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;&gt;</span><br><span class="line">		&lt;property name=&quot;driverClassName&quot; value=&quot;$&#123;jdbc.driverClassName&#125;&quot;&gt;&lt;/property&gt;</span><br><span class="line">		&lt;property name=&quot;url&quot; value=&quot;$&#123;jdbc.url&#125;&quot;&gt;&lt;/property&gt;</span><br><span class="line">		&lt;property name=&quot;username&quot; value=&quot;$&#123;jdbc.username&#125;&quot;&gt;&lt;/property&gt;</span><br><span class="line">		&lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.password&#125;&quot;&gt;&lt;/property&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></p>
<p>现在让我们写一个独立的测试客户端来测试 StudentService，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">@RunWith(SpringJUnit4ClassRunner.class)</span><br><span class="line">@ContextConfiguration(locations = &quot;classpath:applicationContext.xml&quot;)</span><br><span class="line">public class StudentServiceTest &#123;</span><br><span class="line">	@Autowired</span><br><span class="line">	private StudentService studentService;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void testCreateStudent() &#123;</span><br><span class="line">	Address address = new Address(0, &quot;Quaker RidgeRd.&quot;, &quot;Bethel&quot;, &quot;Brooklyn&quot;, &quot;06801&quot;, &quot;USA&quot;);</span><br><span class="line">	Student stud = new Student();</span><br><span class="line">	long ts = System.currentTimeMillis();</span><br><span class="line">	stud.setName(&quot;stud_&quot; + ts);</span><br><span class="line">	stud.setEmail(&quot;stud_&quot; + ts + &quot;@gmail.com&quot;);</span><br><span class="line">	stud.setAddress(address);</span><br><span class="line">	Student student = studentService.createStudent(stud);</span><br><span class="line">	assertNotNull(student);</span><br><span class="line">	assertEquals(&quot;stud_&quot; + ts, student.getName());</span><br><span class="line">	assertEquals(&quot;stud_&quot; + ts + &quot;@gmail.com&quot;, student.getEmail());</span><br><span class="line">	System.err.println(&quot;CreatedStudent: &quot; + student);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test(expected = DataAccessException.class)</span><br><span class="line">		public void testCreateStudentForException()&#123;</span><br><span class="line">		Address address = new Address(0, &quot;Quaker RidgeRd.&quot;, &quot;Bethel&quot;, &quot;Brooklyn&quot;, &quot;06801&quot;, &quot;USA&quot;);</span><br><span class="line">		Student stud = new Student();</span><br><span class="line">		long ts = System.currentTimeMillis();</span><br><span class="line">		stud.setName(&quot;Timothy&quot;);</span><br><span class="line">		stud.setEmail(&quot;stud_&quot; + ts + &quot;@gmail.com&quot;);</span><br><span class="line">		stud.setAddress(address);</span><br><span class="line">		studentService.createStudent(stud);</span><br><span class="line">		fail(&quot;You should not reach here&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里在 testCreateStudent()方法中，我们为 Address 和 Student 赋上了合适的数据，所以 Address 和 Student会被分别插入到表 ADDRESSES 和 STUDENTS 中。在 testCreateStudentForException()方法我们设置了名字为Timothy，该名称在数据库中已经存在了，所以当你尝试将此 student 记录插入到数据库中，MySQL 会抛出一个 UNIQUEKEY 冲突的异常，Spring 会将此异常转换成 DataAccessException 异常，并且将插入 ADDRESSES 表中的数据回滚（rollback）掉。</p>
<p><br><br><br><br><br></p>
<blockquote>
<p>学习参考：《Java Persistence with MyBatis 3》</p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/04/03/2014/MyBatis 使用XML配置SQL 映射器/" itemprop="url">
                  MyBatis 使用XML配置SQL 映射器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-04-03T11:09:00+08:00" content="2014-04-03">
              2014-04-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Java-Web/" itemprop="url" rel="index">
                    <span itemprop="name">Java Web</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Java-Web/Mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">Mybatis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/04/03/2014/MyBatis 使用XML配置SQL 映射器/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/04/03/2014/MyBatis 使用XML配置SQL 映射器/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>关系型数据库和 SQL 是经受时间考验和验证的数据存储机制。和其他的 ORM 框架如 Hibernate 不同，MyBatis鼓励开发者可以直接使用数据库，而不是将其对开发者隐藏，因为这样可以充分发挥数据库服务器所提供的 SQL 语句的巨大威力。与此同时，MyBaits 消除了书写大量冗余代码的痛苦，它使使用 SQL 更容易。</p>
<p>  在代码里直接嵌套 SQL 语句是很差的编码实践，并且维护起来困难。MyBaits 使用了映射器配置文件或注解来配置 SQL语句。</p>
<p>我们会看到具体怎样使用映射器配置文件来配置映射 SQL 语句。</p>
<p>理解如下概念：</p>
<ul>
<li>映射器配置文件 和 映射器接口</li>
<li>映射语句<ul>
<li>配置 INSERT, UPDATE, DELETE, and SELECT 语句</li>
</ul>
</li>
<li>结果映射 ResultMaps<ul>
<li>简单 ResultMaps</li>
<li>使用内嵌 select 语句子查询的一对一映射</li>
<li>使用内嵌的结果集查询的一对一映射</li>
<li>使用内嵌 select 语句子查询的一对多映射</li>
<li>使用内嵌的结果集查询的一对一映射</li>
</ul>
</li>
<li>动态 SQL 语句<ul>
<li>If 条件</li>
<li>choose (when, otherwise) 条件</li>
<li>trim (where, set) 条件</li>
<li>foreach 循环</li>
</ul>
</li>
<li>MyBatis 菜谱</li>
</ul>
<h2 id="映射器配置文件和映射器接口"><a href="#映射器配置文件和映射器接口" class="headerlink" title="映射器配置文件和映射器接口"></a>映射器配置文件和映射器接口</h2><p>映射器配置文件中配置映射语句，然后使用SqlSession对象调用他们。如下:<br>StudentMapper.xml 配置文件内，是如何配置 id 为“findStudentById”的 SQL 语句的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span><br><span class="line">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span><br><span class="line">&lt;mapper namespace=&quot;org.freecode.mappers.StudentMapper&quot;&gt;</span><br><span class="line">&lt;select id=&quot;findStudentById&quot; parameterType=&quot;int&quot; resultType=&quot;Student&quot;&gt;</span><br><span class="line">select stud_id as studId, name, email, dob</span><br><span class="line">from Students where stud_id=#&#123;studId&#125;</span><br><span class="line">&lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure></p>
<p><strong>我们可以通过下列代码调用 findStudentById 映射的 SQL 语句:</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public Student findStudentById2(Integer studId)&#123;</span><br><span class="line">		SqlSession sqlSession = MyBatisSqlSessionFactory.openSession();</span><br><span class="line">		try&#123;</span><br><span class="line">			return (Student)sqlSession.selectOne(&quot;org.freecode.mappers.StudentMapper.findStudentById&quot;,studId);</span><br><span class="line">		&#125;finally&#123;</span><br><span class="line">			sqlSession.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>我们可以通过字符串（字符串形式为：映射器配置文件所在的包名 namespace + 在文件内定义的语句 id，如上，即包名 org.freecode.mappers.StudentMapper 和语句 id findStudentById 组成）调用映射的 SQL 语句，但是这种方式容易出错。你需要检查映射器配置文件中的定义，以保证你的输入参数类型和结果返回类型是有效的。</p>
</blockquote>
<p>MyBatis 通过使用映射器 Mapper 接口提供了更好的调用映射语句的方法。一旦我们通过映射器配置文件配置了映射语句，我们可以创建一个完全对应的一个映射器接口，接口名跟配置文件名相同，接口所在包名也跟配置文件所在包名完全一样(如StudentMapper.xml所在的包名是org.freecode.mappers ， 对 应 的 接 口 名 就 是org.freecode.mappers.StudentMapper.java ）。映射器接口中的方法签名也跟映射器配置文件中完全对应：方法名为配置文件中 id 值；方法参数类型为 parameterType 对应值；方法返回值类型为 returnType 对应值。</p>
<p>对于上述的 StudentMapper.xml 文件，我们可以创建一个映射器接口 StudentMapper.java 如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">package org.freecode.mappers;</span><br><span class="line">public interface StudentMapper&#123;</span><br><span class="line">    Student findStudentById(Integer id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在 StudentMapper.xml 映射器配置文件中，其名空间 namespace 应该跟 StudentMapper 接口的完全限定名保持一致。另外，StudentMapper.xml 中语句 id，parameterType，returnType 应该分别和 StudentMapper 接口中的方法名，参数类型，返回值相对应。</p>
<p>使用映射器接口我们可以以类型安全的形式调用调用映射语句。如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public Student findStudentById(Integer studId)&#123;</span><br><span class="line">		SqlSession sqlSession = MyBatisUtil.getSqlSession();</span><br><span class="line">		try&#123;</span><br><span class="line">			StudentMapper studentMapper = sqlSession.getMapper(StudentMapper.class);</span><br><span class="line">			return studentMapper.findStudentById(studId);</span><br><span class="line">		&#125;finally&#123;</span><br><span class="line">			sqlSession.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>即使映射器 Mapper 接口可以以类型安全的方式调用映射语句，但是我们我负责书写正确的，匹配方法名、参数类型、和返回值的映射器 Mapper 接口。 如果映射器 Mapper 接口中的方法和 XML 中的映射语句不能匹配，会在运行期 抛出一个异常。实际上，指定 parameterType 是可选的；MyBatis 可以使用反 射机制来决定 parameterType。但是，从配置可读性的角度来看，最好指定 parameterType 属性。如果 parameterType 没有被提及，开发者必须查看 Mapper XML 配置和 Java 代码了解传递给语句的输入参数的数据类型。</p>
</blockquote>
<h2 id="映射语句"><a href="#映射语句" class="headerlink" title="映射语句"></a>映射语句</h2><p><strong>MyBatis 提供了多种元素来配置不同类型的语句，如 SELECT，INSERT，UPDATE，DELETE。接下来让我们看看如何具体配置映射语句</strong></p>
<h3 id="INSERT-语句"><a href="#INSERT-语句" class="headerlink" title="INSERT 语句"></a>INSERT 语句</h3><p>一个 INSERT SQL 语句可以在<insert>元素在映射器 XML 配置文件中配置，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;insert id=&quot;insertStudent&quot; parameterType=&quot;Student&quot;&gt;</span><br><span class="line">     INSERT INTO STUDENTS(STUD_ID,NAME,EMAIL, PHONE) VALUES(#&#123;studId&#125;,#&#123;name&#125;,#&#123;email&#125;,#&#123;phone&#125;)</span><br><span class="line">&lt;/insert&gt;</span><br></pre></td></tr></table></figure></insert></p>
<p>这里我们使用一个 ID insertStudent，可以在名空间 org.freecode.mappers.StudentMapper.insertStudent 中唯一标识。parameterType 属性应该是一个完全限定类名或者是一个类型别名（alias）。</p>
<p>我们可以如下调用这个语句：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int count = sqlSession.insert(&quot;org.freecode.mappers.StudentMapper.insertStudent&quot;, student);</span><br></pre></td></tr></table></figure></p>
<p>sqlSession.insert() 方法返回执行 INSERT 语句后所影响的行数。</p>
<p>如果不使用名空间（namespace）和语句 id 来调用映射语句，你可以通过创建一个映射器 Mapper 接口，并以类型安全的方式调用方法，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">package org.freecode.mappers;</span><br><span class="line">public interface StudentMapper &#123;</span><br><span class="line">  int insertStudent(Student student);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>你可以如下调用 insertStudent 映射语句：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">StudentMapper mapper = sqlSession.getMapper(StudentMapper.class);</span><br><span class="line">int count = mapper.insertStudent(student);</span><br></pre></td></tr></table></figure></p>
<p><strong>自动生成主键</strong></p>
<p>在上述的 INSERT 语句中，我们为可以自动生成（auto-generated）主键的列 STUD_ID 插入值。我们可以使用useGeneratedKeys 和 keyProperty 属性让数据库生成 auto_increment 列的值，并将生成的值设置到其中一个</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;insert id=&quot;insertStudent&quot; parameterType=&quot;Student&quot; useGeneratedKeys=&quot;true&quot; keyProperty=&quot;studId&quot;&gt;</span><br><span class="line">    INSERT INTO STUDENTS(NAME, EMAIL, PHONE) VALUES(#&#123;name&#125;,#&#123;email&#125;,#&#123;phone&#125;)</span><br><span class="line">&lt;/insert&gt;</span><br></pre></td></tr></table></figure>
<p>这里 STUD_ID 列值将会被 MySQL 数据库自动生成，并且生成的值会被设置到 student 对象的 studId 属性上。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">StudentMapper mapper = sqlSession.getMapper(StudentMapper.class);</span><br><span class="line">mapper.insertStudent(student);</span><br></pre></td></tr></table></figure></p>
<p>现在可以如下获取插入的 STUDENT 记录的 STUD_ID 的值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int studentId = student.getStudId();</span><br></pre></td></tr></table></figure></p>
<p>有些数据库如 Oracle 并不支持 AUTO_INCREMENT 列，其使用序列（SEQUENCE）来生成主键值。<br>假设我们有一个名为 STUD_ID_SEQ 的序列来生成 SUTD_ID 主键值。使用如下代码来生成主键：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;insert id=&quot;insertStudent&quot; parameterType=&quot;Student&quot;&gt;</span><br><span class="line">    &lt;selectKey keyProperty=&quot;studId&quot; resultType=&quot;int&quot; order=&quot;BEFORE&quot;&gt;</span><br><span class="line">        SELECT ELEARNING.STUD_ID_SEQ.NEXTVAL FROM DUAL</span><br><span class="line">    &lt;/selectKey&gt;</span><br><span class="line">    INSERT INTO STUDENTS(STUD_ID,NAME,EMAIL, PHONE) VALUES(#&#123;studId&#125;,#&#123;name&#125;,#&#123;email&#125;,#&#123;phone&#125;)</span><br><span class="line">&lt;/insert&gt;</span><br></pre></td></tr></table></figure></p>
<p>   这里我们使用了<selectkey>子元素来生成主键值，并将值保存到 Student 对象的 studId 属性上。 属性order=“before”表示 MyBatis 将取得序列的下一个值作为主键值，并且在执行 INSERT SQL 语句之前将值设置到studId 属性上。</selectkey></p>
<p>   我们也可以在获取序列的下一个值时，使用触发器（trigger）来设置主键值，并且在执行 INSERT SQL 语句之<br>前将值设置到主键列上。如果你采取这样的方式，则对应的 INSERT 映射语句如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;insert id=&quot;insertStudent&quot; parameterType=&quot;Student&quot;&gt;</span><br><span class="line">    INSERT INTO STUDENTS(NAME,EMAIL, PHONE) VALUES(#&#123;name&#125;,#&#123;email&#125;,#&#123;phone&#125;)</span><br><span class="line">    &lt;selectKey keyProperty=&quot;studId&quot; resultType=&quot;int&quot; order=&quot;AFTER&quot;&gt;</span><br><span class="line">        SELECT ELEARNING.STUD_ID_SEQ.CURRVAL FROM DUAL</span><br><span class="line">    &lt;/selectKey&gt;</span><br><span class="line">&lt;/insert&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="UPDATE-语句"><a href="#UPDATE-语句" class="headerlink" title="UPDATE 语句"></a>UPDATE 语句</h3><p>一个 UPDATE SQL 语句可以在<update>元素在映射器 XML 配置文件中配置，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;update id=&quot;updateStudent&quot; parameterType=&quot;Student&quot;&gt;</span><br><span class="line">     UPDATE STUDENTS SET NAME=#&#123;name&#125;, EMAIL=#&#123;email&#125;, PHONE=#&#123;phone&#125; WHERE STUD_ID=#&#123;studId&#125;</span><br><span class="line">&lt;/update&gt;</span><br></pre></td></tr></table></figure></update></p>
<p>我们可以如下调用此语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int noOfRowsUpdated = sqlSession.update(&quot;org.freecode.mappers.StudentMapper.updateStudent&quot;, student);</span><br></pre></td></tr></table></figure>
<p>sqlSession.update() 方法返回执行 UPDATE 语句之后影响的行数。</p>
<p>  如果不使用名空间（namespace）和语句 id 来调用映射语句，你可以通过创建一个映射器 Mapper 接口，并以类型安全的方式调用方法，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">package org.freecode.mappers;</span><br><span class="line">public interface StudentMapper</span><br><span class="line">&#123;</span><br><span class="line">	int updateStudent(Student student);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你可以使用映射器 Mapper 接口来调用 updateStudent 语句，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">StudentMapper mapper = sqlSession.getMapper(StudentMapper.class);</span><br><span class="line">int noOfRowsUpdated = mapper.updateStudent(student);</span><br></pre></td></tr></table></figure>
<h3 id="DELETE-语句"><a href="#DELETE-语句" class="headerlink" title="DELETE 语句"></a>DELETE 语句</h3><p>一个 UPDATE SQL 语句可以在<update>元素在映射器 XML 配置文件中配置，如下所示：</update></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;delete id=&quot;deleteStudent&quot; parameterType=&quot;int&quot;&gt;</span><br><span class="line">   DELETE FROM STUDENTS WHERE STUD_ID=#&#123;studId&#125;</span><br><span class="line">&lt;/delete&gt;</span><br></pre></td></tr></table></figure>
<p>我们可以如下调用此语句：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int studId = 1;</span><br><span class="line">int noOfRowsDeleted = sqlSession.delete(&quot;org.freecode.mappers.StudentMapper.deleteStudent&quot;, studId);</span><br></pre></td></tr></table></figure></p>
<p>sqlSession.delete() 方法返回 delete 语句执行后影响的行数。</p>
<p>   如果不使用名空间（namespace）和语句 id 来调用映射语句，你可以通过创建一个映射器 Mapper 接口，并以类型安全的方式调用方法，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">package org.freecode.mappers;</span><br><span class="line">public interface StudentMapper &#123;</span><br><span class="line">	int deleteStudent(int studId); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你可以使用映射器 Mapper 接口来调用 updateStudent 语句，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">StudentMapper mapper = sqlSession.getMapper(StudentMapper.class);</span><br><span class="line">int noOfRowsDeleted = mapper.deleteStudent(studId);</span><br></pre></td></tr></table></figure>
<h3 id="SELECT-语句"><a href="#SELECT-语句" class="headerlink" title="SELECT 语句"></a>SELECT 语句</h3><p>MyBatis 真正强大的功能，在于映射 SELECT 查询结果到 JavaBeans 方面的极大灵活性。<br>让我们看看一个简单的 select 查询是如何（在 MyBatis 中）配置的，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;findStudentById&quot; parameterType=&quot;int&quot; resultType=&quot;Student&quot;&gt;</span><br><span class="line">	SELECT STUD_ID, NAME, EMAIL, PHONE FROM STUDENTS WHERE STUD_ID=#&#123;studId&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<p>我们可以如下调用此语句：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int studId =1;</span><br><span class="line">Student student = sqlSession.selectOne(&quot;org.freecode.mappers.</span><br><span class="line">StudentMapper.findStudentById&quot;, studId);</span><br></pre></td></tr></table></figure></p>
<p>  如果不使用名空间（namespace）和语句 id 来调用映射语句，你可以通过创建一个映射器 Mapper 接口，并以类型安全的方式调用方法，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">package org.freecode.mappers;</span><br><span class="line">public interface StudentMapper &#123;</span><br><span class="line">	Student findStudentById(Integer studId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你可以使用映射器 Mapper 接口来调用 updateStudent 语句，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">StudentMapper mapper = sqlSession.getMapper(StudentMapper.class);</span><br><span class="line">Student student = mapper.findStudentById(studId);</span><br></pre></td></tr></table></figure></p>
<p>如果你检查 Student 对象的属性值，你会发现 studId 属性值并没有被 stud_id 列值填充。这是因为 MyBatis 自动对JavaBean 中和列名匹配的属性进行填充。这就是为什么 name ,email,和 phone 属性被填充，而 studId 属性没有被填充。</p>
<p>  为了解决这一问题，我们可以为列名起一个可以与 JavaBean 中属性名匹配的别名，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;findStudentById&quot; parameterType=&quot;int&quot; resultType=&quot;Student&quot;&gt;</span><br><span class="line">SELECT STUD_ID AS studId, NAME,EMAIL, PHONE FROM STUDENTS WHERE STUD_ID=#&#123;studId&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>
<p>现在，Student 这个 Bean 对象中的值将会恰当地被 stud_id,name,email,phone 列填充了。<br>现在，让我们看一下如何执行返回多条结果的 SELECT 语句查询，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;findAllStudents&quot; resultType=&quot;Student&quot;&gt;</span><br><span class="line">	SELECT STUD_ID AS studId, NAME,EMAIL, PHONE FROM STUDENTS</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Student&gt; students = sqlSession.selectList(&quot;org.freecode.mappers.StudentMapper.findAllStudents&quot;);</span><br></pre></td></tr></table></figure>
<p>映射器 Mapper 接口 StudentMapper 可以如下定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">package org.freecode.mappers;</span><br><span class="line">public interface StudentMapper</span><br><span class="line">&#123;</span><br><span class="line">	List&lt;Student&gt; findAllStudents();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用上述代码，我们可以如下调用 findAllStudents 语句：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">StudentMapper mapper = sqlSession.getMapper(StudentMapper.class);</span><br><span class="line">List&lt;Student&gt; students = mapper.findAllStudents();</span><br></pre></td></tr></table></figure></p>
<p>如果你注意到上述的 SELECT 映射定义，你可以看到，我们为所有的映射语句中的 stud_id 起了别名。<br>我们可以使用 ResultMaps，来避免上述的到处重复别名。我们稍后会继续讨论。<br>除了 java.util.List，你也可以是由其他类型的集合类，如 Set,Map，以及（SortedSet）。MyBatis 根据集合的类型，会采用适当的集合实现，如下所示：</p>
<ul>
<li>对于 List，Collection，Iterable 类型，MyBatis 将返回 java.util.ArrayList</li>
<li>对于 Map 类型，MyBatis 将返回 java.util.HashMap</li>
<li>对于 Set 类型，MyBatis 将返回 java.util.HashSet</li>
<li>对于 SortedSet 类型，MyBatis 将返回 java.util.TreeSet</li>
</ul>
<h2 id="结果集映射-ResultMaps"><a href="#结果集映射-ResultMaps" class="headerlink" title="结果集映射 ResultMaps"></a>结果集映射 ResultMaps</h2><p>ResultMaps 被用来 将 SQL SELECT 语句的结果集映射到 JavaBeans 的属性中。我们可以定义结果集映射 ResultMaps并且在一些 SELECT 语句上引用 resultMap。MyBatis 的结果集映射 ResultMaps 特性非常强大，你可以使用它将简单的SELECT 语句映射到复杂的一对一和一对多关系的 SELECT 语句上。</p>
<h3 id="简单-ResultMap"><a href="#简单-ResultMap" class="headerlink" title="简单 ResultMap"></a>简单 ResultMap</h3><p>一个映射了查询结果和 Student JavaBean 的简单的 resultMap 定义如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;resultMap id=&quot;StudentResult&quot; type=&quot;org.freecode.domain.Student&quot;&gt;</span><br><span class="line">	&lt;id property=&quot;studId&quot; column=&quot;stud_id&quot; /&gt;</span><br><span class="line">	&lt;result property=&quot;name&quot; column=&quot;name&quot; /&gt;</span><br><span class="line">	&lt;result property=&quot;email&quot; column=&quot;email&quot; /&gt;</span><br><span class="line">	&lt;result property=&quot;phone&quot; column=&quot;phone&quot; /&gt;</span><br><span class="line">&lt;/resultMap&gt;</span><br><span class="line"></span><br><span class="line">&lt;select id=&quot;findStudentById&quot; parameterType=&quot;int&quot; resultMap=&quot;StudentResult&quot;&gt;</span><br><span class="line">	SELECT * FROM STUDENTS WHERE STUD_ID=#&#123;studId&#125;</span><br><span class="line">&lt;/select&gt;</span><br><span class="line">&lt;select id=&quot;findAllStudents&quot; resultMap=&quot;StudentResult&quot;&gt;</span><br><span class="line">	SELECT * FROM STUDENTS</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<p>表示 resultMap 的 StudentResult id 值应该在此名空间内是唯一的。并且 type 属性应该是完全限定类名或者是返回类型的别名。<br><code>&lt;result&gt;</code>子元素被用来将一个 resultset 列映射到 JavaBean 的一个属性中。</p>
<p>  <code>&lt;id&gt;</code>元素和<code>&lt;result&gt;</code>元素功能相同，不过它被用来映射到唯一标识属性，用来区分和比较对象（一般和主键列相对应）。</p>
<p>在<code>&lt;select&gt;</code>语句中，我们使用了 resultMap 属性，而不是 resultType 来引用 StudentResult 映射。当<code>&lt;select&gt;</code>语句中配置了 resutlMap 属性，MyBatis 会使用此数据库列名与对象属性映射关系来填充 JavaBean 中的属性。</p>
<blockquote>
<p>resultType 和 resultMap 二者只能用其一，不能同时使用。</p>
</blockquote>
<p>让我们来看另外一个<code>&lt;select&gt;</code>映射语句定义的例子，怎样将查询结果填充到 HashMap 中。如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;findStudentById&quot; parameterType=&quot;int&quot; resultType=&quot;map&quot;&gt;</span><br><span class="line">	SELECT * FROM STUDENTS WHERE STUD_ID=#&#123;studId&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<p>在上述的<code>&lt;select&gt;</code>语句中，我们将 resultType 配置成 map，即 java.util.HashMap 的别名。在这种情况下，结果集<br>的列名将会作为 Map 中的 key 值，而列值将作为 Map 的 value 值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;String,Object&gt; studentMap = sqlSession.selectOne(&quot;org.freecode.mappers.StudentMapper.findStudentById&quot;, studId);</span><br><span class="line">System.out.println(&quot;stud_id :&quot;+studentMap.get(&quot;stud_id&quot;));</span><br><span class="line">System.out.println(&quot;name :&quot;+studentMap.get(&quot;name&quot;));</span><br><span class="line">System.out.println(&quot;email :&quot;+studentMap.get(&quot;email&quot;));</span><br><span class="line">System.out.println(&quot;phone :&quot;+studentMap.get(&quot;phone&quot;));</span><br></pre></td></tr></table></figure>
<p>让我们再看一个 使用 resultType=”map”,返回多行结果的例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;findAllStudents&quot; resultType=&quot;map&quot;&gt;</span><br><span class="line">	SELECT STUD_ID, NAME, EMAIL, PHONE FROM STUDENTS</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<p>由于 resultType=”map”和语句返回多行，则最终返回的数据类型应该是<code>List&lt;HashMap&lt;String,Object&gt;&gt;</code>，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List&lt;HashMap&lt;String, Object&gt;&gt; studentMapList =</span><br><span class="line">sqlSession.selectList(&quot;org.freecode.mappers.StudentMapper.findAllStudents&quot;);</span><br><span class="line">for(HashMap&lt;String, Object&gt; studentMap : studentMapList)&#123;</span><br><span class="line">	System.out.println(&quot;studId :&quot; + studentMap.get(&quot;stud_id&quot;));</span><br><span class="line">	System.out.println(&quot;name :&quot; + studentMap.get(&quot;name&quot;));</span><br><span class="line">	System.out.println(&quot;email :&quot; + studentMap.get(&quot;email&quot;));</span><br><span class="line">	System.out.println(&quot;phone :&quot; + studentMap.get(&quot;phone&quot;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="拓展-ResultMap"><a href="#拓展-ResultMap" class="headerlink" title="拓展 ResultMap"></a>拓展 ResultMap</h3><p>我们可以从从另外一个<code>&lt;resultMap&gt;</code>，拓展出一个新的<code>&lt;resultMap&gt;</code>，这样，原先的属性映射可以继承过来，以实现。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;resultMap type=&quot;Student&quot; id=&quot;StudentResult&quot;&gt;</span><br><span class="line">	&lt;id property=&quot;studId&quot; column=&quot;stud_id&quot; /&gt;</span><br><span class="line">	&lt;result property=&quot;name&quot; column=&quot;name&quot; /&gt;</span><br><span class="line">	&lt;result property=&quot;email&quot; column=&quot;email&quot; /&gt;</span><br><span class="line">	&lt;result property=&quot;phone&quot; column=&quot;phone&quot; /&gt;</span><br><span class="line">&lt;/resultMap&gt;</span><br><span class="line">&lt;resultMap type=&quot;Student&quot; id=&quot;StudentWithAddressResult&quot; extends=&quot;StudentResult&quot;&gt;</span><br><span class="line">	&lt;result property=&quot;address.addrId&quot; column=&quot;addr_id&quot; /&gt;</span><br><span class="line">	&lt;result property=&quot;address.street&quot; column=&quot;street&quot; /&gt;</span><br><span class="line">	&lt;result property=&quot;address.city&quot; column=&quot;city&quot; /&gt;</span><br><span class="line">	&lt;result property=&quot;address.state&quot; column=&quot;state&quot; /&gt;</span><br><span class="line">	&lt;result property=&quot;address.zip&quot; column=&quot;zip&quot; /&gt;</span><br><span class="line">	&lt;result property=&quot;address.country&quot; column=&quot;country&quot; /&gt;</span><br><span class="line">&lt;/resultMap&gt;</span><br></pre></td></tr></table></figure></p>
<p>id 为 StudentWithAddressResult 的 resultMap 拓展了 id 为 StudentResult 的 resultMap。</p>
<p>如果你只想映射 Student 数据，你可以使用 id 为 StudentResult 的 resultMap,如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;findStudentById&quot; parameterType=&quot;int&quot; resultMap=&quot;StudentResult&quot;&gt;</span><br><span class="line">	SELECT * FROM STUDENTS WHERE STUD_ID=#&#123;studId&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<p>如果你想将映射 Student 数据和 Address 数据，你可以使用 id 为 StudentWithAddressResult 的 resultMap：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;selectStudentWithAddress&quot; parameterType=&quot;int&quot; resultMap=&quot;StudentWithAddressResult&quot;&gt;</span><br><span class="line">	SELECT STUD_ID, NAME, EMAIL, PHONE, A.ADDR_ID, STREET, CITY, STATE, ZIP, COUNTRY</span><br><span class="line">		FROM STUDENTS S LEFT OUTER JOIN ADDRESSES A ON</span><br><span class="line">		S.ADDR_ID=A.ADDR_ID</span><br><span class="line">		WHERE STUD_ID=#&#123;studId&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="一对一映射"><a href="#一对一映射" class="headerlink" title="一对一映射"></a>一对一映射</h2><p>在我们的域模型样例中，每一个学生都有一个与之关联的地址信息。表 STUDENTS 有一个 ADDR_ID 列，是 ADDRESSES表的外键。<br>STUDENTS 表的样例数据如下所示：</p>
<table>
<thead>
<tr>
<th>STUD_ID</th>
<th>NAME</th>
<th>EMAIL</th>
<th>PHONE</th>
<th>ADDR_ID</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>John</td>
<td>john@gmail.com</td>
<td>123-456-7890</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>Paul</td>
<td>paul@gmail.com</td>
<td>111-222-3333</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>ADDRESSES 表的样例输入如下所示：</p>
<table>
<thead>
<tr>
<th>ADDR_ID</th>
<th>STREET</th>
<th>CITY</th>
<th>STATE</th>
<th>ZIP</th>
<th>COUNTRY</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Naperville</td>
<td>CHICAGO</td>
<td>IL</td>
<td>60515</td>
<td>USA</td>
</tr>
<tr>
<td>2</td>
<td>Paul</td>
<td>CHICAGO</td>
<td>IL</td>
<td>60515</td>
<td>USA</td>
</tr>
</tbody>
</table>
<p>下面让我们看一下怎样取 Student 明细和其 Address 明细。</p>
<p>Student 和 Address 的 JavaBean 以及映射器 Mapper XML 文件定义如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class Address &#123;</span><br><span class="line">	private Integer addrId;</span><br><span class="line">	private String street;</span><br><span class="line">	private String city;</span><br><span class="line">	private String state;</span><br><span class="line">	private String zip;</span><br><span class="line">	private String country;</span><br><span class="line">	// setters &amp; getters</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class Student &#123;</span><br><span class="line">	private Integer studId;</span><br><span class="line">	private String name;</span><br><span class="line">	private String email;</span><br><span class="line">	private PhoneNumber phone;</span><br><span class="line">	private Address address;</span><br><span class="line">	//setters &amp; getters</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;resultMap type=&quot;Student&quot; id=&quot;StudentWithAddressResult&quot;&gt;</span><br><span class="line">    &lt;id property=&quot;studId&quot; column=&quot;stud_id&quot; /&gt;</span><br><span class="line">    &lt;result property=&quot;name&quot; column=&quot;name&quot; /&gt;</span><br><span class="line">    &lt;result property=&quot;email&quot; column=&quot;email&quot; /&gt;</span><br><span class="line">    &lt;result property=&quot;phone&quot; column=&quot;phone&quot; /&gt;</span><br><span class="line">    &lt;result property=&quot;address.addrId&quot; column=&quot;addr_id&quot; /&gt;</span><br><span class="line">    &lt;result property=&quot;address.street&quot; column=&quot;street&quot; /&gt;</span><br><span class="line">    &lt;result property=&quot;address.city&quot; column=&quot;city&quot; /&gt;</span><br><span class="line">    &lt;result property=&quot;address.state&quot; column=&quot;state&quot; /&gt;</span><br><span class="line">    &lt;result property=&quot;address.zip&quot; column=&quot;zip&quot; /&gt;</span><br><span class="line">    &lt;result property=&quot;address.country&quot; column=&quot;country&quot; /&gt;</span><br><span class="line">&lt;/resultMap&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;select id=&quot;selectStudentWithAddress&quot; parameterType=&quot;int&quot; resultMap=&quot;StudentWithAddressResult&quot;&gt;</span><br><span class="line">SELECT STUD_ID, NAME, EMAIL, A.ADDR_ID, STREET, CITY, STATE,</span><br><span class="line">ZIP, COUNTRY</span><br><span class="line">FROM STUDENTS S LEFT OUTER JOIN ADDRESSES A ON</span><br><span class="line">S.ADDR_ID=A.ADDR_ID WHERE STUD_ID=#&#123;studId&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>
<p>我们可以使用圆点记法为内嵌的对象的属性赋值。在上述的 resultMap 中，Student 的 address 属性使用了圆点记法被赋上了 address 对应列的值。同样地，我们可以访问任意深度的内嵌对象的属性。我们可以如下访问内嵌对象属性：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//接口定义</span><br><span class="line">public interface StudentMapper&#123;</span><br><span class="line">	Student selectStudentWithAddress(int studId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//使用</span><br><span class="line">int studId = 1;</span><br><span class="line"> </span><br><span class="line">StudentMapper studentMapper = sqlSession.getMapper(StudentMapper.class);</span><br><span class="line">Student student = studentMapper.selectStudentWithAddress(studId);</span><br><span class="line">System.out.println(&quot;Student :&quot; + student);</span><br><span class="line">System.out.println(&quot;Address :&quot; + student.getAddress());</span><br></pre></td></tr></table></figure></p>
<p>上述样例展示了一对一关联映射的一种方法。然而，使用这种方式映射，如果 address 结果需要在其他的 SELECT 映射语句中映射成 Address 对象，我们需要为每一个语句重复这种映射关系。MyBatis 提供了更好地实现一对一关联映射的方法：嵌套结果 ResultMap 和嵌套 select 查询语句。接下来，我们将讨论这两种方式。</p>
<h3 id="使用嵌套结果-ResultMap-实现一对一关系映射"><a href="#使用嵌套结果-ResultMap-实现一对一关系映射" class="headerlink" title="使用嵌套结果 ResultMap 实现一对一关系映射"></a>使用嵌套结果 ResultMap 实现一对一关系映射</h3><p>我们可以使用一个嵌套结果 ResultMap 方式来获取 Student 及其 Address 信息，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;resultMap type=&quot;Address&quot; id=&quot;AddressResult&quot;&gt;</span><br><span class="line">    &lt;id property=&quot;addrId&quot; column=&quot;addr_id&quot; /&gt;</span><br><span class="line">    &lt;result property=&quot;street&quot; column=&quot;street&quot; /&gt;</span><br><span class="line">    &lt;result property=&quot;city&quot; column=&quot;city&quot; /&gt;</span><br><span class="line">    &lt;result property=&quot;state&quot; column=&quot;state&quot; /&gt;</span><br><span class="line">    &lt;result property=&quot;zip&quot; column=&quot;zip&quot; /&gt;</span><br><span class="line">    &lt;result property=&quot;country&quot; column=&quot;country&quot; /&gt;</span><br><span class="line">&lt;/resultMap&gt;</span><br><span class="line"></span><br><span class="line">&lt;resultMap type=&quot;Student&quot; id=&quot;StudentWithAddressResult&quot;&gt;</span><br><span class="line">    &lt;id property=&quot;studId&quot; column=&quot;stud_id&quot; /&gt;</span><br><span class="line">    &lt;result property=&quot;name&quot; column=&quot;name&quot; /&gt;</span><br><span class="line">    &lt;result property=&quot;email&quot; column=&quot;email&quot; /&gt;</span><br><span class="line">    &lt;association property=&quot;address&quot; resultMap=&quot;AddressResult&quot; /&gt;</span><br><span class="line">&lt;/resultMap&gt;</span><br><span class="line"></span><br><span class="line">&lt;select id=&quot;findStudentWithAddress&quot; parameterType=&quot;int&quot; resultMap=&quot;StudentWithAddressResult&quot;&gt;</span><br><span class="line">SELECT STUD_ID, NAME, EMAIL, A.ADDR_ID, STREET, CITY, STATE,</span><br><span class="line">ZIP, COUNTRY</span><br><span class="line">FROM STUDENTS S LEFT OUTER JOIN ADDRESSES A ON</span><br><span class="line">S.ADDR_ID=A.ADDR_ID WHERE STUD_ID=#&#123;studId&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<p>  元素<association>被用来导入“有一个”(has-one)类型的关联。在上述的例子中，我们使用了<association>元素引用了另外的在同一个 XML 文件中定义的<resultmap>。</resultmap></association></association></p>
<p>我们也可以使用&lt;association 定义内联的 resultMap，代码如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;resultMap type=&quot;Student&quot; id=&quot;StudentWithAddressResult&quot;&gt;</span><br><span class="line">	&lt;id property=&quot;studId&quot; column=&quot;stud_id&quot; /&gt;</span><br><span class="line">	&lt;result property=&quot;name&quot; column=&quot;name&quot; /&gt;</span><br><span class="line">	&lt;result property=&quot;email&quot; column=&quot;email&quot; /&gt;</span><br><span class="line">	&lt;association property=&quot;address&quot; javaType=&quot;Address&quot;&gt;</span><br><span class="line">		&lt;id property=&quot;addrId&quot; column=&quot;addr_id&quot; /&gt;</span><br><span class="line">		&lt;result property=&quot;street&quot; column=&quot;street&quot; /&gt;</span><br><span class="line">		&lt;result property=&quot;city&quot; column=&quot;city&quot; /&gt;</span><br><span class="line">		&lt;result property=&quot;state&quot; column=&quot;state&quot; /&gt;</span><br><span class="line">		&lt;result property=&quot;zip&quot; column=&quot;zip&quot; /&gt;</span><br><span class="line">		&lt;result property=&quot;country&quot; column=&quot;country&quot; /&gt;</span><br><span class="line">	&lt;/association&gt;</span><br><span class="line">&lt;/resultMap&gt;</span><br></pre></td></tr></table></figure>
<p>使用嵌套结果 ResultMap 方式，关联的数据可以通过简单的查询语句（如果需要的话，需要与 joins 连接操作配合）<br>进行加载。</p>
<h3 id="使用嵌套查询实现一对一关系映射"><a href="#使用嵌套查询实现一对一关系映射" class="headerlink" title="使用嵌套查询实现一对一关系映射"></a>使用嵌套查询实现一对一关系映射</h3><p>我们可以通过使用嵌套 select 查询来获取 Student 及其 Address 信息，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;resultMap type=&quot;Address&quot; id=&quot;AddressResult&quot;&gt;</span><br><span class="line">	&lt;id property=&quot;addrId&quot; column=&quot;addr_id&quot; /&gt;</span><br><span class="line">	&lt;result property=&quot;street&quot; column=&quot;street&quot; /&gt;</span><br><span class="line">	&lt;result property=&quot;city&quot; column=&quot;city&quot; /&gt;</span><br><span class="line">	&lt;result property=&quot;state&quot; column=&quot;state&quot; /&gt;</span><br><span class="line">	&lt;result property=&quot;zip&quot; column=&quot;zip&quot; /&gt;</span><br><span class="line">	&lt;result property=&quot;country&quot; column=&quot;country&quot; /&gt;</span><br><span class="line">&lt;/resultMap&gt;</span><br><span class="line"></span><br><span class="line">&lt;select id=&quot;findAddressById&quot; parameterType=&quot;int&quot; resultMap=&quot;AddressResult&quot;&gt;</span><br><span class="line">	SELECT * FROM ADDRESSES WHERE ADDR_ID=#&#123;id&#125;</span><br><span class="line">&lt;/select&gt;</span><br><span class="line"></span><br><span class="line">&lt;resultMap type=&quot;Student&quot; id=&quot;StudentWithAddressResult&quot;&gt;</span><br><span class="line">	&lt;id property=&quot;studId&quot; column=&quot;stud_id&quot; /&gt;</span><br><span class="line">	&lt;result property=&quot;name&quot; column=&quot;name&quot; /&gt;</span><br><span class="line">	&lt;result property=&quot;email&quot; column=&quot;email&quot; /&gt;</span><br><span class="line">	&lt;association property=&quot;address&quot; column=&quot;addr_id&quot; select=&quot;findAddressById&quot; /&gt;</span><br><span class="line">&lt;/resultMap&gt;</span><br><span class="line"></span><br><span class="line">&lt;select id=&quot;findStudentWithAddress&quot; parameterType=&quot;int&quot; resultMap=&quot;StudentWithAddressResult&quot;&gt;</span><br><span class="line">	SELECT * FROM STUDENTS WHERE STUD_ID=#&#123;Id&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>
<p>在此方式中，<association>元素的 select 属性被设置成了 id 为 findAddressById 的语句。这里，两个分开的SQL 语句将会在数据库中执行，第一个调用 findStudentById 加载 student 信息，而第二个调用 findAddressById 来加载 address 信息。</association></p>
<p>Addr_id 列的值将会被作为输入参数传递给 selectAddressById 语句。</p>
<p>我们可以如下调用 findStudentWithAddress 映射语句：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">StudentMapper mapper = sqlSession.getMapper(StudentMapper.class);</span><br><span class="line">Student student = mapper.selectStudentWithAddress(studId);</span><br><span class="line">System.out.println(student);</span><br><span class="line">System.out.println(student.getAddress());</span><br></pre></td></tr></table></figure></p>
<h2 id="一对多映射"><a href="#一对多映射" class="headerlink" title="一对多映射"></a>一对多映射</h2><p>在我们的域模型样例中，一个讲师可以教授一个或者多个课程。这意味着讲师和课程之间存在一对多的映射关系。<br>我们可以使用<collection>元素将 一对多类型的结果 映射到 一个对象集合上。<br>TUTORS 表的样例数据如下：<br>TUTOR_ID | NAME | EMAIL | PHONE |   ADDR_ID<br>— | — | — |—|—<br>1 | John| john@gmail.com| 123-456-7890| 1<br>2 |Ying |ying@gmail.com |111-222-3333 |2 </collection></p>
<p>COURSE 表的样例数据如下：</p>
<table>
<thead>
<tr>
<th>COURSE_ID</th>
<th>NAME</th>
<th>DESCRIPTION</th>
<th>START_DATE</th>
<th>END_DATE</th>
<th>TUTOR_ID</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>JavaSE</td>
<td>Java SE</td>
<td>2013-01-10</td>
<td>2013-02-10</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>JavaEE</td>
<td>Java EE 6</td>
<td>2013-01-10</td>
<td>2013-03-10</td>
<td>2</td>
</tr>
<tr>
<td>3</td>
<td>MyBatis</td>
<td>MyBatis</td>
<td>2013-01-10</td>
<td>2013-02-20</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>在上述的表数据中，John 讲师教授一个课程，而 Ying 讲师教授两个课程。</p>
<p>Course 和 Tutor 的 JavaBean 定义如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public class Tutor &#123;</span><br><span class="line">	private Integer tutorId;</span><br><span class="line">	private String name;</span><br><span class="line">	private String email;</span><br><span class="line">	private Address address;</span><br><span class="line">	private List&lt;Course&gt; courses;</span><br><span class="line">	// setters &amp; getters</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class Course &#123;</span><br><span class="line">	private Integer courseId;</span><br><span class="line">	private String name;</span><br><span class="line">	private String description;</span><br><span class="line">	private Date startDate;</span><br><span class="line">	private Date endDate;</span><br><span class="line">	private Integer tutorId;</span><br><span class="line">	//setters &amp; getters</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>现在让我们看看如何获取讲师信息以及其所教授的课程列表信息。<collection>元素被用来将多行课程结果映射成一个课程 Course 对象的一个集合。和一对一映射一样，我们可以使用嵌套结果 ResultMap 和嵌套 Select 语句两种方式映射实现一对多映射。</collection></p>
<h3 id="使用内嵌结果-ResultMap-实现一对多映射"><a href="#使用内嵌结果-ResultMap-实现一对多映射" class="headerlink" title="使用内嵌结果 ResultMap 实现一对多映射"></a>使用内嵌结果 ResultMap 实现一对多映射</h3><p>我们可以使用嵌套结果 resultMap 方式获得讲师及其课程信息，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;resultMap type=&quot;Course&quot; id=&quot;CourseResult&quot;&gt;</span><br><span class="line">	&lt;id column=&quot;course_id&quot; property=&quot;courseId&quot; /&gt;</span><br><span class="line">	&lt;result column=&quot;name&quot; property=&quot;name&quot; /&gt;</span><br><span class="line">	&lt;result column=&quot;description&quot; property=&quot;description&quot; /&gt;</span><br><span class="line">	&lt;result column=&quot;start_date&quot; property=&quot;startDate&quot; /&gt;</span><br><span class="line">	&lt;result column=&quot;end_date&quot; property=&quot;endDate&quot; /&gt;</span><br><span class="line">&lt;/resultMap&gt;</span><br><span class="line"></span><br><span class="line">&lt;resultMap type=&quot;Tutor&quot; id=&quot;TutorResult&quot;&gt;</span><br><span class="line">	&lt;id column=&quot;tutor_id&quot; property=&quot;tutorId&quot; /&gt;</span><br><span class="line">	&lt;result column=&quot;tutor_name&quot; property=&quot;name&quot; /&gt;</span><br><span class="line">	&lt;result column=&quot;email&quot; property=&quot;email&quot; /&gt;</span><br><span class="line">	&lt;collection property=&quot;courses&quot; resultMap=&quot;CourseResult&quot; /&gt;</span><br><span class="line">&lt;/resultMap&gt;</span><br><span class="line"></span><br><span class="line">&lt;select id=&quot;findTutorById&quot; parameterType=&quot;int&quot; resultMap=&quot;TutorResult&quot;&gt;</span><br><span class="line">	SELECT T.TUTOR_ID, T.NAME AS TUTOR_NAME, EMAIL, C.COURSE_ID,</span><br><span class="line">	C.NAME, DESCRIPTION, START_DATE, END_DATE</span><br><span class="line">	FROM TUTORS T LEFT OUTER JOIN ADDRESSES A ON T.ADDR_ID=A.ADDR_ID</span><br><span class="line">	LEFT OUTER JOIN COURSES C ON T.TUTOR_ID=C.TUTOR_ID</span><br><span class="line">	WHERE T.TUTOR_ID=#&#123;tutorId&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>
<p>这里我们使用了一个简单的使用了 JOINS 连接的 Select 语句获取讲师及其所教课程信息。<collection>元素的<br>resultMap 属性设置成了 CourseResult，CourseResult 包含了 Course 对象属性与表列名之间的映射。</collection></p>
<h3 id="使用嵌套-Select-语句实现一对多映射"><a href="#使用嵌套-Select-语句实现一对多映射" class="headerlink" title="使用嵌套 Select 语句实现一对多映射"></a>使用嵌套 Select 语句实现一对多映射</h3><p>我们可以使用嵌套 Select 语句方式获得讲师及其课程信息，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;resultMap type=&quot;Course&quot; id=&quot;CourseResult&quot;&gt;</span><br><span class="line">	&lt;id column=&quot;course_id&quot; property=&quot;courseId&quot; /&gt;</span><br><span class="line">	&lt;result column=&quot;name&quot; property=&quot;name&quot; /&gt;</span><br><span class="line">	&lt;result column=&quot;description&quot; property=&quot;description&quot; /&gt;</span><br><span class="line">	&lt;result column=&quot;start_date&quot; property=&quot;startDate&quot; /&gt;</span><br><span class="line">	&lt;result column=&quot;end_date&quot; property=&quot;endDate&quot; /&gt;</span><br><span class="line">&lt;/resultMap&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;resultMap type=&quot;Tutor&quot; id=&quot;TutorResult&quot;&gt;</span><br><span class="line">	&lt;id column=&quot;tutor_id&quot; property=&quot;tutorId&quot; /&gt;</span><br><span class="line">	&lt;result column=&quot;tutor_name&quot; property=&quot;name&quot; /&gt;</span><br><span class="line">	&lt;result column=&quot;email&quot; property=&quot;email&quot; /&gt;</span><br><span class="line">	&lt;association property=&quot;address&quot; resultMap=&quot;AddressResult&quot; /&gt;</span><br><span class="line">	&lt;collection property=&quot;courses&quot; column=&quot;tutor_id&quot; select=&quot;findCoursesByTutor&quot; /&gt;</span><br><span class="line">&lt;/resultMap&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;select id=&quot;findTutorById&quot; parameterType=&quot;int&quot; resultMap=&quot;TutorResult&quot;&gt;</span><br><span class="line">	SELECT T.TUTOR_ID, T.NAME AS TUTOR_NAME, EMAIL FROM TUTORS T WHERE T.TUTOR_ID=#&#123;tutorId&#125;</span><br><span class="line">&lt;/select&gt;</span><br><span class="line"></span><br><span class="line">&lt;select id=&quot;findCoursesByTutor&quot; parameterType=&quot;int&quot; resultMap=&quot;CourseResult&quot;&gt;</span><br><span class="line">	SELECT * FROM COURSES WHERE TUTOR_ID=#&#123;tutorId&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<p>在这种方式中，<aossication>元素的 select 属性被设置为 id 为 findCourseByTutor 的语句，用来触发单独的 SQL 查询加载课程信息。tutor_id 这一列值将会作为输入参数传递给 findCouresByTutor 语句。</aossication></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public interface TutorMapper &#123;</span><br><span class="line">	Tutor findTutorById(int tutorId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TutorMapper mapper = sqlSession.getMapper(TutorMapper.class);</span><br><span class="line">Tutor tutor = mapper.findTutorById(tutorId);</span><br><span class="line">System.out.println(tutor);</span><br><span class="line">List&lt;Course&gt; courses = tutor.getCourses();</span><br><span class="line">for (Course course : courses)</span><br><span class="line">&#123;</span><br><span class="line">	System.out.println(course);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>嵌套 Select 语句查询会导致 N+1 选择问题。首先，主查询将会执行（1 次），对于主查询返回的每一行，另外一个查询将会被执行（主查询 N 行，则此查询 N 次）。对于大型数据库而言，这会导致很差的性能问题。</p>
<h2 id="动态-SQL"><a href="#动态-SQL" class="headerlink" title="动态 SQL"></a>动态 SQL</h2><p>有时候，静态的 SQL 语句并不能满足应用程序的需求。我们可以根据一些条件，来动态地构建 SQL 语句。</p>
</blockquote>
<p>例如，在 Web 应用程序中，有可能有一些搜索界面，需要输入一个或多个选项，然后根据这些已选择的条件去执行检索操作。在实现这种类型的搜索功能，我们可能需要根据这些条件 来构建动态的 SQL 语句。如果用户提供了任何输入条件，我们需要将那个条件 添加到 SQL 语句的 WHERE 子句中。MyBatis 通过使用<code>&lt;if&gt;</code>,<code>&lt;choose&gt;</code>,<code>&lt;where&gt;</code>,<code>&lt;foreach&gt;</code>,<code>&lt;trim&gt;</code>元素提供了对构造动态 SQL 语句的高级别支持。</p>
<h3 id="If-条件"><a href="#If-条件" class="headerlink" title="If 条件"></a>If 条件</h3><p>   <code>&lt;if&gt;</code>元素被用来有条件地嵌入 SQL 片段，如果测试条件被赋值为 true，则相应地 SQL 片段将会被添加到 SQL 语<br>句中。<br>   假定我们有一个课程搜索界面，设置了 讲师（Tutor）下拉列表框，课程名称（CourseName）文本输入框，开始<br>时间（StartDate）输入框，结束时间（EndDate）输入框，作为搜索条件。假定课讲师下拉列表是必须选的，其他的都是可选的。</p>
<p>当用户点击 搜索 按钮时，我们需要显示符合以下条件的成列表：</p>
<ul>
<li>特定讲师的课程</li>
<li>课程名 包含输入的课程名称关键字的课程；如果课程名称输入为空，则取所有课程</li>
<li>在开始时间和结束时间段内的课程</li>
</ul>
<p>我们可以对应的映射语句，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;resultMap type=&quot;Course&quot; id=&quot;CourseResult&quot;&gt;</span><br><span class="line">&lt;id column=&quot;course_id&quot; property=&quot;courseId&quot; /&gt;</span><br><span class="line">&lt;result column=&quot;name&quot; property=&quot;name&quot; /&gt;</span><br><span class="line">&lt;result column=&quot;description&quot; property=&quot;description&quot; /&gt;</span><br><span class="line">&lt;result column=&quot;start_date&quot; property=&quot;startDate&quot; /&gt;</span><br><span class="line">&lt;result column=&quot;end_date&quot; property=&quot;endDate&quot; /&gt;</span><br><span class="line">&lt;/resultMap&gt;</span><br><span class="line"></span><br><span class="line">&lt;select id=&quot;searchCourses&quot; parameterType=&quot;hashmap&quot; resultMap=&quot;CourseResult&quot;&gt;&lt;/select&gt;</span><br><span class="line">	SELECT * FROM COURSES WHERE TUTOR_ID= #&#123;tutorId&#125;</span><br><span class="line">	&lt;if test=&quot;courseName != null&quot;&gt;</span><br><span class="line">		AND NAME LIKE #&#123;courseName&#125;</span><br><span class="line">	&lt;/if&gt;</span><br><span class="line">	&lt;if test=&quot;startDate != null&quot;&gt;</span><br><span class="line">		AND START_DATE &gt;= #&#123;startDate&#125;</span><br><span class="line">	&lt;/if&gt;</span><br><span class="line">	&lt;if test=&quot;endDate != null&quot;&gt;</span><br><span class="line">		AND END_DATE &lt;= #&#123;endDate&#125;</span><br><span class="line">	&lt;/if&gt;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public interface CourseMapper &#123;</span><br><span class="line">	List&lt;Course&gt; searchCourses(Map&lt;String, Object&gt; map);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void searchCourses() &#123;</span><br><span class="line">	Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();</span><br><span class="line">	map.put(&quot;tutorId&quot;, 1);</span><br><span class="line">	map.put(&quot;courseName&quot;, &quot;%java%&quot;);</span><br><span class="line">	map.put(&quot;startDate&quot;, new Date());</span><br><span class="line">	CourseMapper mapper = sqlSession.getMapper(CourseMapper.class);</span><br><span class="line">	List&lt;Course&gt; courses = mapper.searchCourses(map);</span><br><span class="line">	for (Course course : courses) &#123;</span><br><span class="line">		System.out.println(course);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>此处将生成查询语句 SELECT * FROM COURSES WHERE TUTOR_ID= ? AND NAME like ? AND START_DATE &gt;= ?。准备根据给定条件的动态 SQL 查询将会派上用场。</p>
<blockquote>
<p>MyBatis 是使用 OGNL（Object Graph Navigation Language）表达式来构建动态 SQL 语句。</p>
</blockquote>
<h3 id="choose-when-和-otherwise-条件"><a href="#choose-when-和-otherwise-条件" class="headerlink" title="choose,when 和 otherwise 条件"></a>choose,when 和 otherwise 条件</h3><p>有时候，查询功能是以查询类别为基础的。首先，用户需要选择是否希望通过选择 讲师，课程名称，开始时间，或结束时间作为查询条件类别来进行查询，然后根据选择的查询类别，输入相应的参数。在这样的情景中，我们需要只使用其中一种查询类别。</p>
<p>MyBatis 提供了<code>&lt;choose&gt;</code>元素支持此类型的 SQL 预处理。</p>
<p>  现在让我们书写一个适用此情景的 SQL 映射语句。如果没有选择查询类别，则查询开始时间在今天之后的课程，<br>代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;searchCourses&quot; parameterType=&quot;hashmap&quot; resultMap=&quot;CourseResult&quot;&gt;</span><br><span class="line">	SELECT * FROM COURSES</span><br><span class="line">	&lt;choose&gt;</span><br><span class="line">		&lt;when test=&quot;searchBy == &apos;Tutor&apos;&quot;&gt;</span><br><span class="line">			WHERE TUTOR_ID= #&#123;tutorId&#125;</span><br><span class="line">		&lt;/when&gt;</span><br><span class="line">		&lt;when test=&quot;searchBy == &apos;CourseName&apos;&quot;&gt;</span><br><span class="line">			WHERE name like #&#123;courseName&#125;</span><br><span class="line">		&lt;/when&gt;</span><br><span class="line">		&lt;otherwise&gt;</span><br><span class="line">			WHERE TUTOR start_date &gt;= now()</span><br><span class="line">		&lt;/otherwise&gt;</span><br><span class="line">	&lt;/choose&gt;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<p>MyBatis 计算<choose>测试条件的值，且使用第一个值为 TRUE 的子句。如果没有条件为 true，则使用<otherwise>内的子句。</otherwise></choose></p>
<h3 id="Where-条件"><a href="#Where-条件" class="headerlink" title="Where 条件"></a>Where 条件</h3><p>有时候，所有的查询条件（criteria）应该是可选的。在需要使用至少一种查询条件的情况下，我们应该使用 WHERE子句。并且， 如果有多个条件，我们需要在条件中添加 AND 或 OR。MyBatis 提供了<code>&lt;where&gt;</code>元素支持这种类型的动态 SQL 语句。</p>
<p>在我们查询课程界面，我们假设所有的查询条件是可选的。进而，当需要提供一个或多个查询条件时，应该改使用WHERE 子句。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;select id=&quot;searchCourses&quot; parameterType=&quot;hashmap&quot; resultMap=&quot;CourseResult&quot;&gt;</span><br><span class="line">	SELECT * FROM COURSES</span><br><span class="line">	&lt;where&gt;</span><br><span class="line">		&lt;if test=&quot; tutorId != null &quot;&gt;</span><br><span class="line">			TUTOR_ID= #&#123;tutorId&#125;</span><br><span class="line">		&lt;/if&gt;</span><br><span class="line">		&lt;if test=&quot;courseName != null&quot;&gt;</span><br><span class="line">			AND name like #&#123;courseName&#125;</span><br><span class="line">		&lt;/if&gt;</span><br><span class="line">		&lt;if test=&quot;startDate != null&quot;&gt;</span><br><span class="line">			AND start_date &gt;= #&#123;startDate&#125;</span><br><span class="line">		&lt;/if&gt;</span><br><span class="line">		&lt;if test=&quot;endDate != null&quot;&gt;</span><br><span class="line">			AND end_date &lt;= #&#123;endDate&#125;</span><br><span class="line">		&lt;/if&gt;</span><br><span class="line">	&lt;/where&gt;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<p><where>元素只有在其内部标签有返回内容时才会在动态语句上插入 WHERE 条件语句。并且，如果 WHERE 子句以AND 或者 OR 打头，则打头的 AND 或 OR 将会被移除。</where></p>
<p>如果 tutor_id 参数值为 null，并且 courseName 参数值不为 null，则<where>标签会将 AND name like#{courseName} 中的 AND 移除掉，生成的 SQL WHERE 子句为：where name like #{courseName}。</where></p>
<h3 id="lt-trim-gt-条件"><a href="#lt-trim-gt-条件" class="headerlink" title="&lt;trim&gt;条件"></a><code>&lt;trim&gt;</code>条件</h3><p><code>&lt;trim&gt;</code>元素和<code>&lt;where&gt;</code>元素类似，但是<code>&lt;trim&gt;</code>提供了在添加前缀/后缀 或者 移除前缀/后缀方面提供更大的灵活性。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;searchCourses&quot; parameterType=&quot;hashmap&quot; resultMap=&quot;CourseResult&quot;&gt;</span><br><span class="line">	SELECT * FROM COURSES</span><br><span class="line">	&lt;trim prefix=&quot;WHERE&quot; prefixOverrides=&quot;AND | OR&quot;&gt;</span><br><span class="line">		&lt;if test=&quot; tutorId != null &quot;&gt;</span><br><span class="line"> 			TUTOR_ID= #&#123;tutorId&#125;</span><br><span class="line">		&lt;/if&gt;</span><br><span class="line">		&lt;if test=&quot;courseName != null&quot;&gt;</span><br><span class="line">			AND name like #&#123;courseName&#125;</span><br><span class="line">		&lt;/if&gt;</span><br><span class="line">	&lt;/trim&gt;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<p>这里如果任意一个<code>&lt;if&gt;</code>条件为 true，<code>&lt;trim&gt;</code>元素会插入 WHERE,并且移除紧跟 WHERE 后面的 AND 或 OR</p>
<h3 id="foreach-循环"><a href="#foreach-循环" class="headerlink" title="foreach 循环"></a>foreach 循环</h3><p>另外一个强大的动态 SQL 语句构造标签即是<code>&lt;foreach&gt;</code>。它可以迭代遍历一个数组或者列表，构造 AND/OR 条件或一个 IN 子句。</p>
<p>假设我们想找到 tutor_id 为 1，3，6 的讲师所教授的课程，我们可以传递一个 tutor_id 组成的列表给映射语句，然后通过<code>&lt;foreach&gt;</code>遍历此列表构造动态 SQL。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;searchCoursesByTutors&quot; parameterType=&quot;map&quot; resultMap=&quot;CourseResult&quot;&gt;</span><br><span class="line">	SELECT * FROM COURSES</span><br><span class="line">	&lt;if test=&quot;tutorIds != null&quot;&gt;</span><br><span class="line">		&lt;where&gt;</span><br><span class="line">		&lt;foreach item=&quot;tutorId&quot; collection=&quot;tutorIds&quot;&gt;</span><br><span class="line">			OR tutor_id=#&#123;tutorId&#125;</span><br><span class="line">		&lt;/foreach&gt;</span><br><span class="line">		&lt;/where&gt;</span><br><span class="line">	&lt;/if&gt;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public interface CourseMapper &#123;</span><br><span class="line">	List&lt;Course&gt; searchCoursesByTutors(Map&lt;String, Object&gt; map);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void searchCoursesByTutors()&#123;</span><br><span class="line">	Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();</span><br><span class="line">	List&lt;Integer&gt; tutorIds = new ArrayList&lt;Integer&gt;();</span><br><span class="line">	tutorIds.add(1);</span><br><span class="line">	tutorIds.add(3);</span><br><span class="line">	tutorIds.add(6);</span><br><span class="line">	map.put(&quot;tutorIds&quot;, tutorIds);</span><br><span class="line">	CourseMapper mapper = sqlSession.getMapper(CourseMapper.class);</span><br><span class="line">	List&lt;Course&gt; courses = mapper.searchCoursesByTutors(map);</span><br><span class="line">	for (Course course : courses) &#123;</span><br><span class="line">		System.out.println(course);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在让我们来看一下怎样使用<foreach>生成 IN 子句：</foreach></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;searchCoursesByTutors&quot; parameterType=&quot;map&quot; resultMap=&quot;CourseResult&quot;&gt;</span><br><span class="line">	SELECT * FROM COURSES</span><br><span class="line">	&lt;if test=&quot;tutorIds != null&quot;&gt;</span><br><span class="line">		&lt;where&gt;</span><br><span class="line">			tutor_id IN</span><br><span class="line">				&lt;foreach item=&quot;tutorId&quot; collection=&quot;tutorIds&quot; open=&quot;(&quot; separator=&quot;,&quot; close=&quot;)&quot;&gt;</span><br><span class="line">					#&#123;tutorId&#125;</span><br><span class="line">				&lt;/foreach&gt;</span><br><span class="line">		&lt;/where&gt;</span><br><span class="line">	&lt;/if&gt;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>
<h3 id="set-条件"><a href="#set-条件" class="headerlink" title="set 条件"></a>set 条件</h3><p><code>&lt;set&gt;</code>元素和<code>&lt;where&gt;</code>元素类似，如果其内部条件判断有任何内容返回时，他会插入 SET SQL 片段。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;update id=&quot;updateStudent&quot; parameterType=&quot;Student&quot;&gt;</span><br><span class="line">	update students</span><br><span class="line">	&lt;set&gt;</span><br><span class="line">		&lt;if test=&quot;name != null&quot;&gt;name=#&#123;name&#125;,&lt;/if&gt;</span><br><span class="line">		&lt;if test=&quot;email != null&quot;&gt;email=#&#123;email&#125;,&lt;/if&gt;</span><br><span class="line">		&lt;if test=&quot;phone != null&quot;&gt;phone=#&#123;phone&#125;,&lt;/if&gt;</span><br><span class="line">	&lt;/set&gt;</span><br><span class="line">	where stud_id=#&#123;id&#125;</span><br><span class="line">&lt;/update&gt;</span><br></pre></td></tr></table></figure></p>
<p>这里，如果<code>&lt;if&gt;</code>条件返回了任何文本内容，<set>将会插入 set 关键字和其文本内容，并且会剔除将末尾的 “，。”<br>在上述的例子中，如果 phone!=null,<set>将会让会移除 phone=#{phone}后的逗号“,”，生成 set phone=#{phone} 。</set></set></p>
<h2 id="MyBaits-食谱"><a href="#MyBaits-食谱" class="headerlink" title="MyBaits 食谱"></a>MyBaits 食谱</h2><p>除了简化数据库编程外，MyBatis 还提供了各种功能，这些对实现一些常用任务非常有用，比如按页加载表数据，存取 CLOB/BLOB 类型的数据，处理枚举类型值，等等。让我们来看看其中一些特性吧。</p>
<h3 id="处理枚举类型"><a href="#处理枚举类型" class="headerlink" title="处理枚举类型"></a>处理枚举类型</h3><p>MyBatis 支持开箱方式持久化 enum 类型属性。假设 STUDENTS 表中有一列 gender（性别）类型为 varchar，存储”MALE”或者“FEMALE”两种值。并且，Student 对象有一个 enum 类型的 gender 属性，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public enum Gender&#123;</span><br><span class="line">	FEMALE,</span><br><span class="line">	MALE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认情况下，MyBatis 使用 EnumTypeHandler 来处理 enum 类型的 Java 属性，并且将其存储为 enum 值的名称。你不需要为此做任何额外的配置。你可以可以向使用基本数据类型属性一样使用 enum 类型属性，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class Student &#123;</span><br><span class="line">	private Integer id;</span><br><span class="line">	private String name;</span><br><span class="line">	private String email;</span><br><span class="line">	private PhoneNumber phone;</span><br><span class="line">	private Address address;</span><br><span class="line">	private Gender gender;</span><br><span class="line">	//setters and getters</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;insert id=&quot;insertStudent&quot; parameterType=&quot;Student&quot; useGeneratedKeys=&quot;true&quot; keyProperty=&quot;id&quot;&gt;</span><br><span class="line">	insert into students(name,email,addr_id, phone,gender) values(#&#123;name&#125;,#&#123;email&#125;,#&#123;address.addrId&#125;,#&#123;phone&#125;,#&#123;gender&#125;)</span><br><span class="line">&lt;/insert&gt;</span><br></pre></td></tr></table></figure>
<p>当你执行 insertStudent 语句的时候，MyBatis 会取 Gender 枚举（FEMALE/MALE）的名称，然后将其存储到 GENDER列中。</p>
<p>如果你希望存储原 enum 的顺序位置，而不是 enum 名，，你需要明确地配置它。</p>
<p>如 果 你 想 存 储 FEMALE 为 0 ， MALE 为 1 到 gender 列 中 ， 你 需 要 在 mybatis-config.xml 文 件 中 配 置EnumOrdinalTypeHandler:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;typeHandler handler=&quot;org.apache.ibatis.type.EnumOrdinalTypeHandler&quot; javaType=&quot;org.freecode.domain.Gender&quot;/&gt;</span><br></pre></td></tr></table></figure></p>
<p>使用顺序位置为值存储到数据库时要当心。顺序值是根据 enum 中的声明顺序赋值的。如果你改变了 Gender enum 的声明顺序，则数据库存储的数据和此顺序值就不匹配了。</p>
<h3 id="处理-CLOB-BLOB-类型数据"><a href="#处理-CLOB-BLOB-类型数据" class="headerlink" title="处理 CLOB/BLOB 类型数据"></a>处理 CLOB/BLOB 类型数据</h3><p>MyBatis 提供了内建的对 CLOB/BLOB 类型列的映射处理支持。</p>
<p>假设我们有如下的表结构来存储学生和讲师的照片和简介信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE USER_PICS</span><br><span class="line">(</span><br><span class="line">ID INT(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">NAME VARCHAR(50) DEFAULT NULL,</span><br><span class="line">PIC BLOB,</span><br><span class="line">BIO LONGTEXT,</span><br><span class="line">PRIMARY KEY (ID)</span><br><span class="line">) ENGINE=INNODB AUTO_INCREMENT=1 DEFAULT CHARSET=LATIN1;</span><br></pre></td></tr></table></figure></p>
<p>这里，照片可以是 PNG,JPG 或其他格式的。简介信息可以是学生或者讲师的漫长的人生经历。默认情况下，MyBatis将 CLOB 类型的列映射到 java.lang.String 类型上、而把 BLOB 列映射到 byte[] 类型上。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class UserPic &#123;</span><br><span class="line">	private int id;</span><br><span class="line">	private String name;</span><br><span class="line">	private byte[] pic;</span><br><span class="line">	private String bio;</span><br><span class="line">	//setters &amp; getters</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>创建 UserPicMapper.xml 文件，配置映射语句，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;insert id=&quot;insertUserPic&quot; parameterType=&quot;UserPic&quot;&gt;</span><br><span class="line">	INSERT INTO USER_PICS(NAME, PIC,BIO) VALUES(#&#123;name&#125;,#&#123;pic&#125;,#&#123;bio&#125;)</span><br><span class="line">&lt;/insert&gt;</span><br><span class="line">&lt;select id=&quot;getUserPic&quot; parameterType=&quot;int&quot; resultType=&quot;UserPic&quot;&gt;</span><br><span class="line">	SELECT * FROM USER_PICS WHERE ID=#&#123;id&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<p>下列的 insertUserPic()展示了如何将数据插入到 CLOB/BLOB 类型的列上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public void insertUserPic() &#123;</span><br><span class="line">	byte[] pic = null;</span><br><span class="line">	try &#123;</span><br><span class="line">		File file = new File(&quot;C:\\Images\\UserImg.jpg&quot;);</span><br><span class="line">		InputStream is = new FileInputStream(file);</span><br><span class="line">		pic = new byte[is.available()];</span><br><span class="line">		is.read(pic);</span><br><span class="line">		is.close();</span><br><span class="line">	&#125;catch (FileNotFoundException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125;catch (IOException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">	String name = &quot;UserName&quot;;</span><br><span class="line">	String bio = &quot;put some lenghty bio here&quot;;</span><br><span class="line">	UserPic userPic = new UserPic(0, name, pic , bio);</span><br><span class="line">	SqlSession sqlSession = MyBatisUtil.openSession();</span><br><span class="line">	try &#123;</span><br><span class="line">		UserPicMapper mapper = sqlSession.getMapper(UserPicMapper.class);</span><br><span class="line">		mapper.insertUserPic(userPic);</span><br><span class="line">		sqlSession.commit();</span><br><span class="line">	&#125; finally &#123;</span><br><span class="line">		sqlSession.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面的 getUserPic()方法展示了怎样将 CLOB 类型数据读取到 String 类型，BLOB 类型数据读取成 byte[]属性：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public void getUserPic() &#123;</span><br><span class="line">	UserPic userPic = null;</span><br><span class="line">	SqlSession sqlSession = MyBatisUtil.openSession();</span><br><span class="line">	try &#123;</span><br><span class="line">		UserPicMapper mapper = sqlSession.getMapper(UserPicMapper.class);</span><br><span class="line">		userPic = mapper.getUserPic(1);</span><br><span class="line">	&#125; finally &#123;</span><br><span class="line">		sqlSession.close();</span><br><span class="line">	&#125;</span><br><span class="line">	byte[] pic = userPic.getPic();</span><br><span class="line">	try &#123;</span><br><span class="line">		OutputStream os = new FileOutputStream(new File(&quot;C:\\Images\\UserImage_FromDB.jpg&quot;));</span><br><span class="line">		os.write(pic);</span><br><span class="line">		os.close();</span><br><span class="line">    &#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125; catch (IOException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="传入多个输入参数"><a href="#传入多个输入参数" class="headerlink" title="传入多个输入参数"></a>传入多个输入参数</h3><p>MyBatis 中的映射语句有一个 parameterType 属性来制定输入参数的类型。如果我们想给映射语句传入多个参数的话，我们可以将所有的输入参数放到 HashMap 中，将 HashMap 传递给映射语句。</p>
<p>MyBatis 还提供了另外一种传递多个输入参数给映射语句的方法。假设我们想通过给定的 name 和 email 信息查找学生信息，定义查询接口如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Public interface StudentMapper &#123;</span><br><span class="line">	List&lt;Student&gt; findAllStudentsByNameEmail(String name, String email);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>MyBatis 支持 将多个输入参数传递给映射语句，并以#{param}的语法形式引用它们：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;findAllStudentsByNameEmail&quot; resultMap=&quot;StudentResult&quot;&gt;</span><br><span class="line">	select stud_id, name,email, phone from Students where name=#&#123;param1&#125; and email=#&#123;param2&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<p>这里#{param1}引用第一个参数 name，而#{param2}引用了第二个参数 email。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">StudentMapper studentMapper = sqlSession.getMapper(StudentMapper.class);</span><br><span class="line">studentMapper.findAllStudentsByNameEmail(name, email);</span><br></pre></td></tr></table></figure></p>
<h3 id="多行结果集映射成-Map"><a href="#多行结果集映射成-Map" class="headerlink" title="多行结果集映射成 Map"></a>多行结果集映射成 Map</h3><p>如果你有一个映射语句返回多行记录，并且你想以 HashMap 的形式存储记录的值，使用记录列名作为 key 值，而记录对应值或为 value 值。我们可以使用 sqlSession.selectMap(),如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot; findAllStudents&quot; resultMap=&quot;StudentResult&quot;&gt;</span><br><span class="line">	select * from Students</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Integer, Student&gt; studentMap = sqlSession.selectMap(&quot;org.freecode.mappers.StudentMapper.findAllStudents&quot;, &quot;studId&quot;);</span><br></pre></td></tr></table></figure>
<p>这里 studentMap 将会将 studId 作为 key 值，而 Student 对象作为 value 值。</p>
<h3 id="使用-RowBounds-对结果集进行分页"><a href="#使用-RowBounds-对结果集进行分页" class="headerlink" title="使用 RowBounds 对结果集进行分页"></a>使用 RowBounds 对结果集进行分页</h3><p>有时候，我们会需要跟海量的数据打交道，比如一个有数百万条数据级别的表。由于计算机内存的现实我们不可能一次性加载这么多数据，我们可以获取到数据的一部分。特别是在 Web 应用程序中，分页机制被用来以一页一页的形式展示海量的数据。</p>
<p>MyBatis 可以使用 RowBounds 逐页加载表数据。RowBounds 对象可以使用 offset 和 limit 参数来构建。参数offset 表示开始位置，而 limit 表示要取的记录的数目。假设如果你想每页加载并显示 25 条学生的记录，你可以使用如下的代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;findAllStudents&quot; resultMap=&quot;StudentResult&quot;&gt;</span><br><span class="line">	select * from Students</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<p>然后，你可以加载如下加载第一页数据（前 25 条）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int offset =0 , limit =25;</span><br><span class="line">RowBounds rowBounds = new RowBounds(offset, limit);</span><br><span class="line">List&lt;Student&gt; = studentMapper.getStudents(rowBounds);</span><br></pre></td></tr></table></figure></p>
<p>若要展示第二页，使用 offset=25,limit=25;第三页，则为 offset=50，limit=25。</p>
<h3 id="使用-ResultSetHandler-自定义结果集-ResultSet-处理"><a href="#使用-ResultSetHandler-自定义结果集-ResultSet-处理" class="headerlink" title="使用 ResultSetHandler 自定义结果集 ResultSet 处理"></a>使用 ResultSetHandler 自定义结果集 ResultSet 处理</h3><p>MyBatis 在将查询结果集映射到 JavaBean 方面提供了很大的选择性。但是，有时候我们会遇到由于特定的目的，需要我们自己处理 SQL 查询结果的情况。MyBatis 提供了 ResultHandler 插件形式允许我们以任何自己喜欢的方式处理结果集 ResultSet。</p>
<p>  假设我们想从学生的 stud_id 被用作 key，而 name 被用作 value 的 HashMap 中获取到 student 信息。</p>
<blockquote>
<p>mybatis-3.2.2 并不支持使用 resultMap 配置将查询的结果集映射成一个属性为key，而另外属性为 value 的 HashMap。<br>sqlSession.selectMap()则可以返回 以给定列为 key，记录对象为 value 的 map。<br>我们不能将其配置成使用其中一个属性作为 key，而另外的属性作为 value。</p>
</blockquote>
<p>对于 sqlSession.select()方法，我们可以传递给它一个 ResultHandler 的实现，它会被调用来处理 ResultSet的每一条记录。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface ResultHandler &#123;</span><br><span class="line">	void handleResult(ResultContext context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>现在然我们来看一下怎么使用 ResultHandler 来处理结果集 ResultSet，并返回自定义化的结果。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public Map&lt;Integer, String&gt; getStudentIdNameMap() &#123;</span><br><span class="line"></span><br><span class="line">	final Map&lt;Integer, String&gt; map = new HashMap&lt;Integer, String&gt;();</span><br><span class="line">	SqlSession sqlSession = MyBatisUtil.openSession();</span><br><span class="line">	try &#123;</span><br><span class="line">	sqlSession.select(&quot;org.freecode.mappers.StudentMapper.findAllStudents&quot;, new ResultHandler()&#123;</span><br><span class="line"></span><br><span class="line">		@Override</span><br><span class="line">		public void handleResult(ResultContext context) &#123;</span><br><span class="line">			Student student = (Student) context.getResultObject();</span><br><span class="line">			map.put(student.getStudId(), student.getName());</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	&#125; finally &#123;</span><br><span class="line">		sqlSession.close();</span><br><span class="line">	&#125;</span><br><span class="line">	return map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在 上 述 的 代 码 中 ， 我 们 提 供 了 匿 名 内 部 ResultHandler 实 现 类 ， 在 handleResult() 方 法 中 ， 我 们 使 用context.getResultObject()获取当前的 result 对象，即 Student 对象，因为我们定义了 findAllStudent 映射语句的 resultMap=”studentResult“。对查询返回的每一行都会调用 handleResult()方法，并且我们从 Student 对象中取出 studId 和 name，将其放到 map 中。</p>
<h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><p>将从数据库中加载的数据缓存到内存中，是很多应用程序为了提高性能而采取的一贯做法。MyBatis 对通过映射的SELECT 语句加载的查询结果提供了内建的缓存支持。默认情况下，启用一级缓存；即，如果你使用同一个 SqlSession接口对象调用了相同的 SELECT 语句，则直接会从缓存中返回结果，而不是再查询一次数据库。</p>
<p>我们可以在 SQL 映射器 XML 配置文件中使用<code>&lt;cache /&gt;</code>元素添加全局二级缓存。<br>当你加入了<code>&lt;cache /&gt;</code>元素，将会出现以下情况：</p>
<ul>
<li>所有的在映射语句文件定义的<code>&lt;select&gt;</code>语句的查询结果都会被缓存</li>
<li>所有的在映射语句文件定义的<code>&lt;insert&gt;</code>,<code>&lt;update&gt;</code> 和<code>&lt;delete&gt;</code>语句将会刷新缓存</li>
<li>缓存根据最近最少被使用（Least Recently Used，LRU）算法管理</li>
<li>缓存不会被任何形式的基于时间表的刷新（没有刷新时间间隔），即不支持定时刷新机制</li>
<li>缓存将存储 1024 个 查询方法返回的列表或者对象的引用</li>
<li>缓存会被当作一个读/写缓存。这是指检索出的对象不会被共享，并且可以被调用者安全地修改，不会其他潜在的调用者或者线程的潜在修改干扰。（即，缓存是线程安全的）</li>
</ul>
<p>你也可以通过复写默认属性来自定义缓存的行为，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;cache eviction=&quot;FIFO&quot; flushInterval=&quot;60000&quot; size=&quot;512&quot; readOnly=&quot;true&quot;/&gt;</span><br></pre></td></tr></table></figure></p>
<p>以下是对上述属性的描述：</p>
<ul>
<li>eviction:此处定义缓存的移除机制。默认值是 LRU，其可能的值有：LRU（least recently used,最近最少使用）,FIFO(first in first out,先进先出)，SOFT(soft reference,软引用)，WEAK（weakreference,弱引用）。</li>
<li>flushInterval:定义缓存刷新间隔，以毫秒计。默认情况下不设置。所以不使用刷新间隔，缓存 cache 只有调用语句的时候刷新。</li>
<li>size:此表示缓存 cache 中能容纳的最大元素数。默认值是 1024，你可以设置成任意的正整数。</li>
<li>readOnly:一个只读的缓存 cache 会对所有的调用者返回被缓存对象的同一个实例（实际返回的是被返回对象的一份引用）。一个读/写缓存 cache 将会返回被返回对象的一分拷贝（通过序列化）。默认情况下设置为 false。可能的值有 false 和 true。</li>
</ul>
<p>一个缓存的配置和缓存实例被绑定到映射器配置文件所在的名空间（namespace）上，所以在相同名空间内的所有语句被绑定到一个 cache 中。<br>80</p>
<p>默认的映射语句的 cache 配置如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;select ... flushCache=&quot;false&quot; useCache=&quot;true&quot;/&gt;</span><br><span class="line">&lt;insert ... flushCache=&quot;true&quot;/&gt;</span><br><span class="line">&lt;update ... flushCache=&quot;true&quot;/&gt;</span><br><span class="line">&lt;delete ... flushCache=&quot;true&quot;/&gt;</span><br></pre></td></tr></table></figure></p>
<p>你可以为任意特定的映射语句复写默认的 cache 行为；例如，对一个 select 语句不使用缓存，可以设置useCache=“false”。</p>
<p>除了内建的缓存支持，MyBatis 也提供了与第三方缓存类库如 Ehcache，OSCache，Hazelcast 的集成支持。你可以在 MyBatis 官方网站 <a href="https://code.google.com/p/mybatis/wiki/Caches" target="_blank" rel="external">https://code.google.com/p/mybatis/wiki/Caches</a> 上找到关于继承第三方缓存类库的更多信息。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/04/02/2014/Mybatis井号和$的区别/" itemprop="url">
                  Mybatis ${}和#{} 区别
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-04-02T12:53:00+08:00" content="2014-04-02">
              2014-04-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Java-Web/" itemprop="url" rel="index">
                    <span itemprop="name">Java Web</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Java-Web/Mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">Mybatis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/04/02/2014/Mybatis井号和$的区别/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/04/02/2014/Mybatis井号和$的区别/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这两个标示符均会出现在MyBatis XML SQL 映射文件中。</p>
<ul>
<li>参照理解：<ul>
<li><code>#{}</code>  相当于 PrepareStatement 类<br><strong>以占位符的形式进行数值传递，有效的防止SQL注入</strong></li>
<li><code>${}</code> 相当于 Statement 类<br><strong>值传递，不能能防止SQL注入</strong></li>
</ul>
</li>
</ul>
<blockquote>
<p>需要理解JDBC中的PrepareStatement 和 Statement 的关系。</p>
</blockquote>
<h2 id="占位符替换，能够防止SQL-注入问题。"><a href="#占位符替换，能够防止SQL-注入问题。" class="headerlink" title="#{} 占位符替换，能够防止SQL 注入问题。"></a><code>#{}</code> 占位符替换，能够防止SQL 注入问题。</h2><p>如下Mapper.xml SQL映射语句。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;insert id=&quot;insertSample&quot; parameterType=&quot;Sample&quot;&gt;</span><br><span class="line">     INSERT INTO SAMPLE(ID,NAME,EMAIL, TYPE) VALUES(#&#123;Id&#125;,#&#123;name&#125;,#&#123;email&#125;,#&#123;type&#125;)</span><br><span class="line">&lt;/insert&gt;</span><br></pre></td></tr></table></figure></p>
<p>它将会翻译为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO SAMPLE(ID,NAME,EMAIL, TYPE) VALUES ?,?,?,?</span><br></pre></td></tr></table></figure></p>
<p><strong>?会对应顺序的数值进行赋值传递，并检查数值的合法性.(这里有个预编译阶段，用于检验SQL)</strong></p>
<h2 id="值传递，不能防止SQL注入"><a href="#值传递，不能防止SQL注入" class="headerlink" title="${} 值传递，不能防止SQL注入"></a><code>${}</code> 值传递，不能防止SQL注入</h2><p>如下Mapper.xml SQL映射语句。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;insert id=&quot;insertSample&quot; parameterType=&quot;Sample&quot;&gt;</span><br><span class="line">     INSERT INTO SAMPLE(ID,NAME,EMAIL, TYPE) VALUES($&#123;Id&#125;,$&#123;name&#125;,$&#123;email&#125;,$&#123;type&#125;)</span><br><span class="line">&lt;/insert&gt;</span><br></pre></td></tr></table></figure></p>
<p>它将会翻译为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO SAMPLE(ID,NAME,EMAIL, TYPE) VALUES 4,飞车,baiwoyidao@163.com,游戏</span><br></pre></td></tr></table></figure></p>
<p><strong>直接的SQL生成，没有预编译阶段。</strong></p>
<h2 id="建议"><a href="#建议" class="headerlink" title="建议"></a>建议</h2><ul>
<li>使用<code>#{}</code>替代<code>${}</code><ul>
<li><code>#{}</code>更加安全</li>
<li><code>#{}</code> 性能好一些（部分数据库会对预编译语句进行性能优化）</li>
</ul>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/04/02/2014/MyBatis Boostrap/" itemprop="url">
                  MyBatis Boostrap
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-04-02T10:44:00+08:00" content="2014-04-02">
              2014-04-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Java-Web/" itemprop="url" rel="index">
                    <span itemprop="name">Java Web</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Java-Web/Mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">Mybatis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/04/02/2014/MyBatis Boostrap/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/04/02/2014/MyBatis Boostrap/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>SqlSessionFactory 是MyBatis的核心对象，用于获取SqlSession，并执行映射的 SQL 语句。<br>可以通过基于 XML 的配置信息或者 Java API 创建。</p>
<p>我们将探索各种 MaBatis 配置元素，如 dataSource，environments,全局参数设置,typeAlias，typeHandlers，<br>SQL 映射；接着我们将实例化 SqlSessionFactory。</p>
<ul>
<li>使用 XML 配置 MyBatis</li>
<li>使用 Java API 配置 MyBatis</li>
<li>自定义 MyBatis 日志</li>
</ul>
<h2 id="使用-XML-配置-MyBatis"><a href="#使用-XML-配置-MyBatis" class="headerlink" title="使用 XML 配置 MyBatis"></a>使用 XML 配置 MyBatis</h2><p><strong>构建 SqlSessionFactory 最常见的方式是基于 XML 配置（的构造方式）。下面的 mybatis-config.xml 展示了一个<br>典型的 MyBatis 配置文件的样子：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span><br><span class="line">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">	&lt;properties resource=&quot;application.properties&quot;&gt;</span><br><span class="line">		&lt;property name=&quot;username&quot; value=&quot;db_user&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;password&quot; value=&quot;verysecurepwd&quot; /&gt;</span><br><span class="line">	&lt;/properties&gt;</span><br><span class="line">	&lt;settings&gt;</span><br><span class="line">		&lt;setting name=&quot;cacheEnabled&quot; value=&quot;true&quot; /&gt;</span><br><span class="line">	&lt;/settings&gt;</span><br><span class="line">	&lt;typeAliases&gt;</span><br><span class="line">		&lt;typeAlias alias=&quot;Tutor&quot; type=&quot;com.mybatis3.domain.Tutor&quot; /&gt;</span><br><span class="line">		&lt;package name=&quot;com.mybatis3.domain&quot; /&gt;</span><br><span class="line">	&lt;/typeAliases&gt;</span><br><span class="line">	&lt;typeHandlers&gt;</span><br><span class="line">		&lt;typeHandler handler=&quot;com.mybatis3.typehandlers. PhoneTypeHandler&quot; /&gt;</span><br><span class="line">		&lt;package name=&quot;com.mybatis3.typehandlers&quot; /&gt;</span><br><span class="line">	&lt;/typeHandlers&gt;</span><br><span class="line">	&lt;environments default=&quot;development&quot;&gt;</span><br><span class="line">		&lt;environment id=&quot;development&quot;&gt;</span><br><span class="line">			&lt;transactionManager type=&quot;JDBC&quot; /&gt;</span><br><span class="line">			&lt;dataSource type=&quot;POOLED&quot;&gt;</span><br><span class="line">				&lt;property name=&quot;driver&quot; value=&quot;$&#123;jdbc.driverClassName&#125;&quot; /&gt;</span><br><span class="line">				&lt;property name=&quot;url&quot; value=&quot;$&#123;jdbc.url&#125;&quot; /&gt;</span><br><span class="line">				&lt;property name=&quot;username&quot; value=&quot;$&#123;jdbc.username&#125;&quot; /&gt;</span><br><span class="line">				&lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.password&#125;&quot; /&gt;</span><br><span class="line">			&lt;/dataSource&gt;</span><br><span class="line">		&lt;/environment&gt;</span><br><span class="line">		&lt;environment id=&quot;production&quot;&gt;</span><br><span class="line">			&lt;transactionManager type=&quot;MANAGED&quot; /&gt;</span><br><span class="line">			&lt;dataSource type=&quot;JNDI&quot;&gt;</span><br><span class="line">				&lt;property name=&quot;data_source&quot; value=&quot;java:comp/jdbc/MyBatisDemoDS&quot; /&gt;</span><br><span class="line">			&lt;/dataSource&gt;</span><br><span class="line">		&lt;/environment&gt;</span><br><span class="line">	&lt;/environments&gt;</span><br><span class="line">	&lt;mappers&gt;</span><br><span class="line">		&lt;mapper resource=&quot;com/mybatis3/mappers/StudentMapper.xml&quot; /&gt;</span><br><span class="line">		&lt;mapper url=&quot;file:///D:/mybatisdemo/mappers/TutorMapper.xml&quot; /&gt;</span><br><span class="line">		&lt;mapper class=&quot;com.mybatis3.mappers.TutorMapper&quot; /&gt;</span><br><span class="line">	&lt;/mappers&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure></p>
<p><strong>下面让我们逐个讨论上述配置文件的组成部分</strong></p>
<h3 id="environment-环境"><a href="#environment-环境" class="headerlink" title="environment (环境)"></a>environment (环境)</h3><p>MyBatis 支持配置多个 dataSource 环境，可以将应用部署到不同的环境上， DEV(开发环境)，如TEST（测试换将），<br>QA（质量评估环境）,UAT(用户验收环境),PRODUCTION（生产环境），可以通过将默认 environment 值设置成想要的<br>environment id 值。<br>在上述的配置中，默认的环境 environment 被设置成 development。当需要将程序部署到生产服务器上时，你不需<br>要修改什么配置，只需要将默认环境 environment 值设置成生产环境的<br>明细；使用 REPORTS 数据库存储订单明细的合计，用作报告。<br>如果你的应用需要连接多个数据库，你需要将每个数据库配置成独立的环境，并且为每一个数据库创建一个<br>SqlSessionFactory。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;environments default=&quot;shoppingcart&quot;&gt;</span><br><span class="line">	&lt;environment id=&quot;shoppingcart&quot;&gt;</span><br><span class="line">		&lt;transactionManager type=&quot;MANAGED&quot; /&gt;</span><br><span class="line">		&lt;dataSource type=&quot;JNDI&quot;&gt;</span><br><span class="line">			&lt;property name=&quot;data_source&quot; value=&quot;java:comp/jdbc/ ShoppingcartDS&quot; /&gt;</span><br><span class="line">		&lt;/dataSource&gt;</span><br><span class="line">	&lt;/environment&gt;</span><br><span class="line">	&lt;environment id=&quot;reports&quot;&gt;</span><br><span class="line">		&lt;transactionManager type=&quot;MANAGED&quot; /&gt;</span><br><span class="line">		&lt;dataSource type=&quot;JNDI&quot;&gt;</span><br><span class="line">			&lt;property name=&quot;data_source&quot; value=&quot;java:comp/jdbc/ReportsDS&quot; /&gt;</span><br><span class="line">		&lt;/dataSource&gt;</span><br><span class="line">	&lt;/environment&gt;</span><br><span class="line">&lt;/environments&gt;</span><br></pre></td></tr></table></figure></p>
<p><strong>我们可以通过如下，为每一个环境创建一个SqlSessionFactory</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">inputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line">defaultSqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);</span><br><span class="line">cartSqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream, &quot;shoppingcart&quot;);</span><br><span class="line">reportSqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream, &quot;reports&quot;);</span><br></pre></td></tr></table></figure></p>
<p>创建 SqlSessionFactory 时，如果没有明确指定环境 environment id，则会使用默认的环境 environment 来创<br>建。在上述的源码中，默认的 SqlSessionFactory 便是使用 shoppingcart 环境设置创建的。<br>对于每个环境 environment,我们需要配置 dataSource 和 transactionManager 元素。</p>
<h3 id="DataSource-数据源"><a href="#DataSource-数据源" class="headerlink" title="DataSource (数据源)"></a>DataSource (数据源)</h3><p>dataSource 元素被用来配置数据库连接属性。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;dataSource type=&quot;POOLED&quot;&gt;</span><br><span class="line">	&lt;property name=&quot;driver&quot; value=&quot;$&#123;jdbc.driverClassName&#125;&quot; /&gt;</span><br><span class="line">	&lt;property name=&quot;url&quot; value=&quot;$&#123;jdbc.url&#125;&quot; /&gt;</span><br><span class="line">	&lt;property name=&quot;username&quot; value=&quot;$&#123;jdbc.username&#125;&quot; /&gt;</span><br><span class="line">	&lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.password&#125;&quot; /&gt;</span><br><span class="line">&lt;/dataSource&gt;</span><br></pre></td></tr></table></figure></p>
<p>dataSource 的类型可以配置成其内置类型之一，如 UNPOOLED，POOLED，JNDI。</p>
<ul>
<li>如果将类型设置成 UNPOOLED，MyBatis 会为每一个数据库操作创建一个新的连接，并关闭它。该方式适用于只有小规模数量并发用户的简单应用程序上。</li>
<li>如果将属性设置成 POOLED，MyBatis 会创建一个数据库连接池，连接池中的一个连接将会被用作数据库操作。一旦数据库操作完成，MyBatis 会将此连接返回给连接池。在开发或测试环境中，经常使用此种方式。</li>
<li>如果将类型设置成 JNDI，MyBatis 从在应用服务器向配置好的 JNDI 数据源 dataSource 获取数据库连接。在生产环境中，优先考虑这种方式。</li>
</ul>
<h3 id="TransactionManager-事务管理器"><a href="#TransactionManager-事务管理器" class="headerlink" title="TransactionManager(事务管理器)"></a>TransactionManager(事务管理器)</h3><ul>
<li>MyBatis 支持两种类型的事务管理器： JDBC and MANAGED.<ul>
<li>JDBC 事务管理器被用作当应用程序负责管理数据库连接的生命周期（提交、回退等等）的时候。当你将TransactionManager 属性设置成 JDBC，MyBatis 内部将使用 JdbcTransactionFactory 类创建TransactionManager。例如，部署到 Apache Tomcat 的应用程序，需要应用程序自己管理事务。</li>
<li>MANAGED 事 务 管 理 器 是 当 由 应 用 服 务 器 负 责 管 理 数 据 库 连 接 生 命 周 期 的 时 候 使 用 。 当 你将TransactionManager 属性设置成 MANAGED 时，MyBatis 内部使用 ManagedTransactionFactory 类创建事务管理器TransactionManager。例如，当一个 JavaEE 的应用程序部署在类似 JBoss，WebLogic，GlassFish 应用服务器上时，它们会使用 EJB 进行应用服务器的事务管理能力。在这些管理环境中，你可以使用 MANAGED 事务管理器。<blockquote>
<p>Managed 是托管的意思，即是应用本身不去管理事务，而是把事务管理交给应用所在的服务器进行管理。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="Properties-属性"><a href="#Properties-属性" class="headerlink" title="Properties(属性)"></a>Properties(属性)</h3><p>属性配置元素可以将配置值具体化到一个属性文件中，，并且使用属性文件的 key 名作为占位符。在上述的配置中，我们将数据库连接属性具体化到了 application.properties 文件中，并且为 driver，URL 等属性使用了占位符。</p>
<p><strong>1. 在 applications.properties 文件中配置数据库连接参数，如下所示：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jdbc.driverClassName=com.mysql.jdbc.Driver</span><br><span class="line">jdbc.url=jdbc:mysql://localhost:3306/mybatisdemo</span><br><span class="line">jdbc.username=root</span><br><span class="line">jdbc.password=admin</span><br></pre></td></tr></table></figure></p>
<p><strong>2. 在 mybatis-config.xml 文件中，为属性使用 application.properties 文件中定义的占位符：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;properties resource=&quot;application.properties&quot;&gt;</span><br><span class="line">    &lt;property name=&quot;jdbc.username&quot; value=&quot;db_user&quot; /&gt;</span><br><span class="line">    &lt;property name=&quot;jdbc.password&quot; value=&quot;verysecurepwd&quot; /&gt;</span><br><span class="line">&lt;/properties&gt;</span><br><span class="line">&lt;dataSource type=&quot;POOLED&quot;&gt;</span><br><span class="line">    &lt;property name=&quot;driver&quot; value=&quot;$&#123;jdbc.driverClassName&#125;&quot; /&gt;</span><br><span class="line">    &lt;property name=&quot;url&quot; value=&quot;$&#123;jdbc.url&#125;&quot; /&gt;</span><br><span class="line">    &lt;property name=&quot;username&quot; value=&quot;$&#123;jdbc.username&#125;&quot; /&gt;</span><br><span class="line">    &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.password&#125;&quot; /&gt;</span><br><span class="line">&lt;/dataSource&gt;</span><br></pre></td></tr></table></figure></p>
<p>并且，你可以在<properties>元素中配置默认参数的值。如果<properties>中定义的元素和属性文件定义元素的 key<br>值相同，它们会被属性文件中定义的值覆盖。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;properties resource=&quot;application.properties&quot;&gt;</span><br><span class="line">    &lt;property name=&quot;jdbc.username&quot; value=&quot;db_user&quot; /&gt;</span><br><span class="line">    &lt;property name=&quot;jdbc.password&quot; value=&quot;verysecurepwd&quot; /&gt;</span><br><span class="line">&lt;/properties&gt;</span><br></pre></td></tr></table></figure></properties></properties></p>
<p>这里，如果 application.properties 文件包含值 jdbc.username 和 jdbc.password，则上述定义的 username 和<br>password 的值 db_user 和 verysecurepwd 将会被 application.properties 中定义的对应的 jdbc.username 和<br>jdbc.password 值覆盖。</p>
<h3 id="typeAliases-类型别名"><a href="#typeAliases-类型别名" class="headerlink" title="typeAliases(类型别名)"></a>typeAliases(类型别名)</h3><p>在 SQLMapper 配置文件中，对于 resultType 和 parameterType 属性值，我们需要使用 JavaBean 的完全限定名。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;findStudentById&quot; parameterType=&quot;int&quot; resultType=&quot;com.mybatis3.domain.Student&quot;&gt;</span><br><span class="line">       SELECT STUD_ID AS ID, NAME, EMAIL, DOB FROM STUDENTS WHERE STUD_ID=#&#123;Id&#125;</span><br><span class="line">&lt;/select&gt;</span><br><span class="line">&lt;update id=&quot;updateStudent&quot; parameterType=&quot;com.mybatis3.domain. Student&quot;&gt;</span><br><span class="line">       UPDATE STUDENTS SET NAME=#&#123;name&#125;, EMAIL=#&#123;email&#125;, DOB=#&#123;dob&#125; WHERE STUD_ID=#&#123;id&#125;</span><br><span class="line">&lt;/update&gt;</span><br></pre></td></tr></table></figure></p>
<p>这里我们为 resultType 和 parameterType 属性值设置为 Student 类型的完全限定名： com.mybatis3.domain.Student</p>
<p>我们可以为完全限定名取一个别名（alias），然后其需要使用完全限定名的地方使用别名，而不是到处使用完全限定<br>名。如下例子所示，为完全限定名起一个别名：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;typeAliases&gt;</span><br><span class="line">    &lt;typeAlias alias=&quot;Student&quot; type=&quot;com.mybatis3.domain.Student&quot; /&gt;</span><br><span class="line">    &lt;typeAlias alias=&quot;Tutor&quot; type=&quot;com.mybatis3.domain.Tutor&quot; /&gt;</span><br><span class="line">    &lt;package name=&quot;com.mybatis3.domain&quot; /&gt;</span><br><span class="line">&lt;/typeAliases&gt;</span><br></pre></td></tr></table></figure></p>
<p>然后在 SQL Mapper 映射文件中, 如下使用 Student 的别名：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;findStudentById&quot; parameterType=&quot;int&quot; resultType=&quot;Student&quot;&gt;</span><br><span class="line">    SELECT STUD_ID AS ID, NAME, EMAIL, DOB FROM STUDENTS WHERE STUD_ID=#&#123;id&#125;</span><br><span class="line">&lt;/select&gt;</span><br><span class="line">&lt;update id=&quot;updateStudent&quot; parameterType=&quot;Student&quot;&gt;</span><br><span class="line">    UPDATE STUDENTS SET NAME=#&#123;name&#125;, EMAIL=#&#123;email&#125;, DOB=#&#123;dob&#125; WHERE STUD_ID=#&#123;id&#125;</span><br><span class="line">&lt;/update&gt;</span><br></pre></td></tr></table></figure></p>
<p>你可以不用为每一个 JavaBean 单独定义别名, 你可以为提供需要取别名的 JavaBean 所在的包(package)，MyBatis<br>会自动扫描包内定义的 JavaBeans，然后分别为 JavaBean 注册一个小写字母开头的非完全限定的类名形式的别名。如下所<br>示，提供一个需要为 JavaBeans 起别名的包名：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;typeAliases&gt;</span><br><span class="line">    &lt;package name=&quot;com.mybatis3.domain&quot; /&gt;</span><br><span class="line">&lt;/typeAliases&gt;</span><br></pre></td></tr></table></figure></p>
<p>如果 Student.java 和 Tutor.java Bean 定义在 com.mybatis3.domain 包中，则 com.mybatis3.domain.Student<br>的别名会被注册为 student。而 com.mybatis3.domain.Tutor 别名将会被注册为 tutor。示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;typeAliases&gt;</span><br><span class="line">    &lt;typeAlias alias=&quot;Student&quot; type=&quot;com.mybatis3.domain.Student&quot; /&gt;</span><br><span class="line">    &lt;typeAlias alias=&quot;Tutor&quot; type=&quot;com.mybatis3.domain.Tutor&quot; /&gt;</span><br><span class="line">    &lt;package name=&quot;com.mybatis3.domain&quot; /&gt;</span><br><span class="line">    &lt;package name=&quot;com.mybatis3.webservices.domain&quot; /&gt;</span><br><span class="line">&lt;/typeAliases&gt;</span><br></pre></td></tr></table></figure></p>
<p>还有另外一种方式为 JavaBeans 起别名，使用注解@Alias:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@Alias(&quot;StudentAlias&quot;)</span><br><span class="line">public class Student&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>@Alias 注解将会覆盖配置文件中的<typealiases>定义。</typealiases></p>
<h3 id="typeHandlers-类型处理器"><a href="#typeHandlers-类型处理器" class="headerlink" title="typeHandlers ( 类型处理器)"></a>typeHandlers ( 类型处理器)</h3><p>如上一章已经讨论过，MyBatis 通过抽象 JDBC 来简化了数据持久化逻辑的实现。MyBatis 在其内部使用 JDBC，提供<br>了更简洁的方式实现了数据库操作。<br>当 MyBatis 将一个 Java 对象作为输入参数执行 INSERT 语句操作时，它会创建一个 PreparedStatement 对象，并且<br>使用 setXXX()方式对占位符设置相应的参数值。<br>这里，XXX 可以是 Int，String，Date 等 Java 对象属性类型的任意一个。示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;insert id=&quot;insertStudent&quot; parameterType=&quot;Student&quot;&gt;</span><br><span class="line">    INSERT INTO STUDENTS(STUD_ID,NAME,EMAIL,DOB) VALUES(#&#123;studId&#125;,#&#123;name&#125;,#&#123;email&#125;,#&#123;dob&#125;)</span><br><span class="line">&lt;/insert&gt;</span><br></pre></td></tr></table></figure></p>
<p><strong>为执行这个语句，MyBatis 将采取以下一系列动作：</strong><br><strong>1. 创建一个有占位符的 PreparedStatement 接口，如下：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PreparedStatement pstmt = connection.prepareStatement</span><br><span class="line">(&quot;INSERT INTO STUDENTS(STUD_ID,NAME,EMAIL,DOB) VALUES(?,?,?,?)&quot;);</span><br></pre></td></tr></table></figure></p>
<p><strong>检查 Student 对象的属性 studId 的类型，然后使用合适 setXXX 方法去设置参数值。这里 studId 是 integer<br>类型，所以会使用 setInt()方法：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pstmt.setInt(1,student.getStudId());</span><br></pre></td></tr></table></figure></p>
<p><strong>3. 类似地，对于 name 和 email 属性都是 String 类型，MyBatis 使用 setString()方法设置参数。</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pstmt.setString(2, student.getName());</span><br><span class="line">pstmt.setString(3, student.getEmail());</span><br></pre></td></tr></table></figure></p>
<p><strong>4. 至于 dob 属性, MyBatis 会使用 setDate() 方法设置 dob 处占位符位置的值。</strong></p>
<p><strong>5. MyBaits 会将 java.util.Date 类型转换为 into java.sql.Timestamp 并设值：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pstmt.setTimestamp(4, new Timestamp((student.getDob()).getTime()));</span><br></pre></td></tr></table></figure></p>
<p>   厉害！ MyBatis 是怎么知道对于 Integer 类型属性使用 setInt() 和 String 类型属性使用 setString()方法呢？但<br>其实 MyBatis 是通过使用类型处理器（type handlers）来决定这么做的。</p>
<p>  MyBatis 对 于 以 下 的 类 型 使 用 内 建 的 类 型 处 理 器 ： 所 有 的 基 本 数 据 类 型 、 基 本 类 型 的 包 裹 类 型 、 byte[] 、<br>java.util.Date、java.sql.Date、java,sql.Time、java.sql.Timestamp、java 枚举类型等。所以当 MyBatis 发现<br>属性的类型属于上述类型，他会使用对应的类型处理器将值设置到 PreparedStatement 中，同样地，当从 SQL 结果集构<br>建 JavaBean 时，也有类似的过程。</p>
<p>   那如果我们给了一个自定义的对象类型，来存储存储到数据库呢？示例如下：<br>   假设表 STUDENTS 有一个 PHONE 字段，类型为 VARCHAR(15)，而 JavaBean Student 有一个 PhoneNumber 类定义类<br>型的 phoneNumber 属性。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public class PhoneNumber</span><br><span class="line">&#123;</span><br><span class="line">private String countryCode;</span><br><span class="line">private String stateCode;</span><br><span class="line">private String number;</span><br><span class="line">public PhoneNumber()</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line">public PhoneNumber(String countryCode, String stateCode, String</span><br><span class="line">number)</span><br><span class="line">&#123;</span><br><span class="line">this.countryCode = countryCode;</span><br><span class="line">this.stateCode = stateCode;</span><br><span class="line">this.number = number;</span><br><span class="line">&#125;</span><br><span class="line">public PhoneNumber(String string)</span><br><span class="line">&#123;</span><br><span class="line">if(string != null)</span><br><span class="line">&#123;</span><br><span class="line">String[] parts = string.split(&quot;-&quot;);</span><br><span class="line">if(parts.length &gt; 0) this.countryCode = parts[0];</span><br><span class="line">if(parts.length &gt; 1) this.stateCode = parts[1];</span><br><span class="line">if(parts.length &gt; 2) this.number = parts[2];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">public String getAsString()</span><br><span class="line">&#123;</span><br><span class="line">return countryCode + &quot;-&quot; + stateCode + &quot;-&quot; + number;</span><br><span class="line">&#125;</span><br><span class="line">// Setters and getters</span><br><span class="line">&#125;</span><br><span class="line">public class Student</span><br><span class="line">&#123;</span><br><span class="line">private Integer id;</span><br><span class="line">private String name;</span><br><span class="line">private String email;</span><br><span class="line">private PhoneNumber phone;</span><br><span class="line">// Setters and getters</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;insert id=&quot;insertStudent&quot; parameterType=&quot;Student&quot;&gt;</span><br><span class="line">	insert into students(name,email,phone) values(#&#123;name&#125;,#&#123;email&#125;,#&#123;phone&#125;)</span><br><span class="line">&lt;/insert&gt;</span><br></pre></td></tr></table></figure>
<p>   这里，phone 参数需要传递给#{phone}；而 phone 对象是 PhoneNumber 类型。然而，MyBatis 并不知道该怎样来处<br>理这个类型的对象。</p>
<p>   为了让 MyBatis 明白怎样处理这个自定义的 Java 对象类型，如 PhoneNumber，我们可以创建一个自定义的类型处理<br>器，如下所示：</p>
<p><strong>1. MyBatis 提供了抽象类 BaseTypeHandler<t> ，我们可以继承此类创建自定义类型处理器。</t></strong></p>
<p><strong>域模型对象PhoneNumber</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">package org.freecode.domain;</span><br><span class="line">public class PhoneNumber </span><br><span class="line">&#123;</span><br><span class="line">	private String countryCode;</span><br><span class="line">	private String stateCode;</span><br><span class="line">	private String number;</span><br><span class="line">	</span><br><span class="line">	public PhoneNumber() &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public PhoneNumber(String countryCode, String stateCode, String number) &#123;</span><br><span class="line">		super();</span><br><span class="line">		this.countryCode = countryCode;</span><br><span class="line">		this.stateCode = stateCode;</span><br><span class="line">		this.number = number;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public PhoneNumber(String string) &#123;</span><br><span class="line">		if(string != null)&#123;</span><br><span class="line">			String[] parts = string.split(&quot;-&quot;);</span><br><span class="line">			if(parts.length&gt;0) this.countryCode=parts[0];</span><br><span class="line">			if(parts.length&gt;1) this.stateCode=parts[1];</span><br><span class="line">			if(parts.length&gt;2) this.number=parts[2];</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	@Override</span><br><span class="line">	public String toString() &#123;</span><br><span class="line">		return this.getAsString();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	public String getCountryCode() &#123;</span><br><span class="line">		return countryCode;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setCountryCode(String countryCode) &#123;</span><br><span class="line">		this.countryCode = countryCode;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public String getStateCode() &#123;</span><br><span class="line">		return stateCode;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setStateCode(String stateCode) &#123;</span><br><span class="line">		this.stateCode = stateCode;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public String getNumber() &#123;</span><br><span class="line">		return number;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setNumber(String number) &#123;</span><br><span class="line">		this.number = number;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public String getAsString() &#123;</span><br><span class="line">		return countryCode+&quot;-&quot;+stateCode+&quot;-&quot;+number;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>定义格式转换类 PhoneTypeHandler</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">package org.freecode.typehandlers;</span><br><span class="line"></span><br><span class="line">import java.sql.CallableStatement;</span><br><span class="line">import java.sql.PreparedStatement;</span><br><span class="line">import java.sql.ResultSet;</span><br><span class="line">import java.sql.SQLException;</span><br><span class="line"></span><br><span class="line">import org.apache.ibatis.type.BaseTypeHandler;</span><br><span class="line">import org.apache.ibatis.type.JdbcType;</span><br><span class="line">import org.freecode.domain.PhoneNumber;</span><br><span class="line"></span><br><span class="line">public class PhoneTypeHandler extends BaseTypeHandler&lt;PhoneNumber&gt;&#123;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void setNonNullParameter(PreparedStatement ps, int i,</span><br><span class="line">			PhoneNumber parameter, JdbcType jdbcType) throws SQLException &#123;</span><br><span class="line">		ps.setString(i, parameter.getAsString());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public PhoneNumber getNullableResult(ResultSet rs, String columnName)</span><br><span class="line">			throws SQLException &#123;</span><br><span class="line">		return new PhoneNumber(rs.getString(columnName));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public PhoneNumber getNullableResult(ResultSet rs, int columnIndex)</span><br><span class="line">			throws SQLException &#123;</span><br><span class="line">		return new PhoneNumber(rs.getString(columnIndex));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public PhoneNumber getNullableResult(CallableStatement cs, int columnIndex)</span><br><span class="line">			throws SQLException &#123;</span><br><span class="line">		return new PhoneNumber(cs.getString(columnIndex));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li><p>我们使用 ps.setString()和 rs.getString()方法是因为 phone 列是 VARCHAR 类型。</p>
</li>
<li><p>一旦我们实现了自定义的类型处理器，我们需要在 mybatis-config.xml 中注册它：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span><br><span class="line">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">&lt;properties resource=&quot;application.properties&quot; /&gt;</span><br><span class="line">&lt;typeHandlers&gt;</span><br><span class="line">&lt;typeHandler handler=&quot;com.mybatis3.typehandlers. PhoneTypeHandler&quot; /&gt;</span><br><span class="line">&lt;/typeHandlers&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>注册 PhoneTypeHandler 后, MyBatis 就能够将 Phone 类型的对象值存储到 VARCHAR 类型的列上。</p>
<h3 id="Settings-全局参数设置"><a href="#Settings-全局参数设置" class="headerlink" title="Settings(全局参数设置)"></a>Settings(全局参数设置)</h3><p>为满足应用特定的需求，MyBatis 默认的全局参数设置可以被覆盖(overridden)掉，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;settings&gt;</span><br><span class="line">&lt;setting name=&quot;cacheEnabled&quot; value=&quot;true&quot; /&gt;</span><br><span class="line">&lt;setting name=&quot;lazyLoadingEnabled&quot; value=&quot;true&quot; /&gt;</span><br><span class="line">&lt;setting name=&quot;multipleResultSetsEnabled&quot; value=&quot;true&quot; /&gt;</span><br><span class="line">&lt;setting name=&quot;useColumnLabel&quot; value=&quot;true&quot; /&gt;</span><br><span class="line">&lt;setting name=&quot;useGeneratedKeys&quot; value=&quot;false&quot; /&gt;</span><br><span class="line">&lt;setting name=&quot;autoMappingBehavior&quot; value=&quot;PARTIAL&quot; /&gt;</span><br><span class="line">&lt;setting name=&quot;defaultExecutorType&quot; value=&quot;SIMPLE&quot; /&gt;</span><br><span class="line">&lt;setting name=&quot;defaultStatementTimeout&quot; value=&quot;25000&quot; /&gt;</span><br><span class="line">&lt;setting name=&quot;safeRowBoundsEnabled&quot; value=&quot;false&quot; /&gt;</span><br><span class="line">&lt;setting name=&quot;mapUnderscoreToCamelCase&quot; value=&quot;false&quot; /&gt;</span><br><span class="line">&lt;setting name=&quot;localCacheScope&quot; value=&quot;SESSION&quot; /&gt;</span><br><span class="line">&lt;setting name=&quot;jdbcTypeForNull&quot; value=&quot;OTHER&quot; /&gt;</span><br><span class="line">&lt;setting name=&quot;lazyLoadTriggerMethods&quot; value=&quot;equals,clone,hashCode ,toString&quot; /&gt;</span><br><span class="line">&lt;/settings&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="Mappers-SQL-映射定义"><a href="#Mappers-SQL-映射定义" class="headerlink" title="Mappers(SQL 映射定义)"></a>Mappers(SQL 映射定义)</h3><p>Mapper XML 文件中包含的 SQL 映射语句将会被应用通过使用其 statementid 来执行。我们需要在 mybatis-<br>config.xml 文件中配置 SQL Mapper 文件的位置。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;mappers&gt;</span><br><span class="line">&lt;mapper resource=&quot;com/mybatis3/mappers/StudentMapper.xml&quot; /&gt;</span><br><span class="line">&lt;mapper url=&quot;file:///D:/mybatisdemo/app/mappers/TutorMapper.xml&quot; /&gt;</span><br><span class="line">&lt;mapper class=&quot;com.mybatis3.mappers.TutorMapper&quot; /&gt;</span><br><span class="line">&lt;package name=&quot;com.mybatis3.mappers&quot; /&gt;</span><br><span class="line">&lt;/mappers&gt;</span><br></pre></td></tr></table></figure></p>
<p>以上每一个<mapper> 标签的属性有助于从不同类型的资源中加载映射 mapper：</mapper></p>
<ul>
<li>resource 属性用来指定在 classpath 中的 mapper 文件。</li>
<li>url 属性用来通过完全文件系统路径或者 web URL 地址来指向 mapper 文件</li>
<li>class 属性用来指向一个 mapper 接口</li>
<li>package 属性用来指向可以找到 Mapper 接口的包名</li>
</ul>
<h2 id="使用-Java-API-配置-MyBatis"><a href="#使用-Java-API-配置-MyBatis" class="headerlink" title="使用 Java API 配置 MyBatis"></a>使用 Java API 配置 MyBatis</h2><h2 id="自定义MyBatis-日志"><a href="#自定义MyBatis-日志" class="headerlink" title="自定义MyBatis 日志"></a>自定义MyBatis 日志</h2><p>   MyBatis 使用其内部 LoggerFactory 作为真正的日志类库使用的门面。其内部的 LaggerFactory 会将日志记录任务<br>委托给如下的所示某一个日志实现，日志记录优先级由上到下顺序递减：</p>
<ul>
<li>SLF4J</li>
<li>Apache Commons Logging</li>
<li>Log4j 2</li>
<li>Log4j</li>
<li>JDK logging</li>
</ul>
<p>如果 MyBatis 未发现上述日志记录实现，则 MyBatis 的日志记录功能无效。<br>如果你的运行环境中，在 classpath 中有多个可用的日志类库，并且你希望 MyBaits 使用某个特定的日志实现，你可以通过调用以下其中一个方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">org.apache.ibatis.logging.LogFactory.useSlf4jLogging();</span><br><span class="line">org.apache.ibatis.logging.LogFactory.useLog4JLogging();</span><br><span class="line">org.apache.ibatis.logging.LogFactory.useLog4J2Logging();</span><br><span class="line">org.apache.ibatis.logging.LogFactory.useJdkLogging();</span><br><span class="line">org.apache.ibatis.logging.LogFactory.useCommonsLogging();</span><br><span class="line">org.apache.ibatis.logging.LogFactory.useStdOutLogging();</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>如果你想自定义 MyBatis 日志记录，你应该在调用任何其它方法之前调用以上的其中一个方法。如果你想切换到的日志记录类库在运行时期无效，MyBatis 将会忽略这一请求。</p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/04/01/2014/MyBatis 入门/" itemprop="url">
                  MyBatis 入门
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-04-01T23:44:00+08:00" content="2014-04-01">
              2014-04-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Java-Web/" itemprop="url" rel="index">
                    <span itemprop="name">Java Web</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Java-Web/Mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">Mybatis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/04/01/2014/MyBatis 入门/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/04/01/2014/MyBatis 入门/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Hibernate 太过于庞大，作为同样的持久化ORM 框架Mybatis 就显得非常小巧灵活。</p>
<p>MyBatis 同样是简单易用的。</p>
<p>Java数据库持久化层主要两个部分：</p>
<ul>
<li>将从数据库查询到的数据生成所需要的 Java 对象</li>
<li>将 Java 对象中的数据通过 SQL 持久化到数据库中。</li>
</ul>
<h2 id="为什么-选择MyBatis"><a href="#为什么-选择MyBatis" class="headerlink" title="为什么 选择MyBatis ?"></a>为什么 选择MyBatis ?</h2><h3 id="消除大量JDBC冗余代码"><a href="#消除大量JDBC冗余代码" class="headerlink" title="消除大量JDBC冗余代码"></a>消除大量JDBC冗余代码</h3><ul>
<li>无需关注重复性JDBC操作 (不再与connection，statement，resultSet 重复性对象打交道)，MyBatis 会处理这些底层工作<blockquote>
<p>创建 Connection 连接，创建一个 Statement 对象，设置输入参数，关闭资源</p>
</blockquote>
</li>
<li>需要配置数据库连接属性和 SQL 语句。 （POJO &lt;–&gt; SQL Table）<ul>
<li>Mybatis 准备需要被执行的 SQL statement 对象并且将 Java 对象作为输入数据传递给 statement 对象的任务</li>
<li>MyBatis 自动化了将从输入的 Java 对象中的属性设置成查询参数、从 SQL 结果集上生成 Java 对象</li>
</ul>
</li>
</ul>
<p><strong>实例说明</strong><br><strong>1. 在 SQL Mapper 映射配置文件中配置 SQL 语句，假定为 StudentMapper.xml</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;findStudentById&quot; parameterType=&quot;int&quot; resultType=&quot;Student&quot;&gt;</span><br><span class="line">     SELECT STUD_ID AS studId, NAME, EMAIL, DOB FROM STUDENTS WHERE STUD_ID=#&#123;Id&#125;</span><br><span class="line">&lt;/select&gt;</span><br><span class="line"></span><br><span class="line">&lt;insert id=&quot;insertStudent&quot; parameterType=&quot;Student&quot;&gt;</span><br><span class="line">     INSERT INTO STUDENTS(STUD_ID,NAME,EMAIL,DOB) VALUES(#&#123;studId&#125;,#&#123;name&#125;,#&#123;email&#125;,#&#123;dob&#125;)</span><br><span class="line">&lt;/insert&gt;</span><br></pre></td></tr></table></figure>
<p><strong>2. 创建一个 StudentMapper 接口</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public interface StudentMapper &#123;</span><br><span class="line">           Student findStudentById(Integer id);</span><br><span class="line">           void insertStudent(Student student);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>3. 在 Java 代码中，你可以使用如下代码触发 SQL 语句：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SqlSession session = getSqlSessionFactory().openSession();</span><br><span class="line">StudentMapper mapper = session.getMapper(StudentMapper.class);</span><br><span class="line"><span class="comment">// Select Student by Id</span></span><br><span class="line">Student student = mapper.selectStudentById(<span class="number">1</span>);</span><br><span class="line"><span class="comment">//To insert a Student record</span></span><br><span class="line">mapper.insertStudent(student);</span><br></pre></td></tr></table></figure>
<p><strong>编码完成</strong></p>
<h3 id="低学习曲线"><a href="#低学习曲线" class="headerlink" title="低学习曲线"></a>低学习曲线</h3><p><strong>你需要熟悉Java 和 SQL 即可</strong></p>
<h3 id="能够很好地与传统数据库协同工作"><a href="#能够很好地与传统数据库协同工作" class="headerlink" title="能够很好地与传统数据库协同工作"></a>能够很好地与传统数据库协同工作</h3><p>Hibernate将 Java 对象静态地映射到数据库的表上<br>MyBatis 是将查询的结果与 Java 对象映射起来。你可以根据面相对象的模型创建 Java 域对象，执行传统数据库的查询，然后将结果映射到对应的 Java 对象上。</p>
<h3 id="接受-SQL"><a href="#接受-SQL" class="headerlink" title="接受 SQL"></a>接受 SQL</h3><p>Hibernate鼓励使用实体对象（Entity Objects）和在其底层自动产生 SQL 语句。这种<br>的 SQL 生成方式，我们有可能不能够利用到数据库的一些特有的特性。Hibernate 允许执行本地 SQL，但是这样会打破持<br>久层和数据库独立的原则。</p>
<p>MyBatis 框架接受 SQL 语句，而不是将其对开发人员隐藏起来。由于 MyBatis 不会产生任何的 SQL 语句，所以开发<br>人员就要准备 SQL 语句，这样就可以充分利用数据库特有的特性并且可以准备自定义的查询。另外，MyBatis 对存储过程<br>也提供了支持。</p>
<h3 id="与Spring-集成"><a href="#与Spring-集成" class="headerlink" title="与Spring 集成"></a>与Spring 集成</h3><p>MyBatis 提供了与 流行的依赖注入框架 Spring 和 Guice 的开包即用的集成支持，这将进一步简化 MyBatis 的使用</p>
<h3 id="与第三方缓存类库的集成支持"><a href="#与第三方缓存类库的集成支持" class="headerlink" title="与第三方缓存类库的集成支持"></a>与第三方缓存类库的集成支持</h3><p>MyBatis 有内建的 SqlSession 级别的缓存机制，用于缓存 Select 语句查询出来的结果。除此之外，MyBatis 提供<br>了与多种第三方缓存类库的集成支持，如 EHCache，OSCache，Hazelcast。</p>
<h3 id="良好的性能"><a href="#良好的性能" class="headerlink" title="良好的性能"></a>良好的性能</h3><ul>
<li>MyBatis 支持数据库连接池，消除了为每一个请求创建一个数据库连接的开销</li>
<li>MyBatis 提供了内建的缓存机制，在 SqlSession 级别提供了对 SQL 查询结果的缓存。即:如果你调用了相同的select 查询，MyBatis会将放在缓存的结果返回，而不会去再查询数据库。</li>
<li>MyBatis 框架并没有大量地使用代理机制2，因此对于其他的过度地使用代理的 ORM 框架而言，MyBatis 可以获得更<br>好的性能。</li>
</ul>
<p><strong>如果你的应用是以面向对象模型，并且向动态生成 SQL 语句，那么 MyBatis可能就不符合你的要求。另外，如果你想让你的应用有一个传递性的缓存机制的话（保存父对象时也应该保存关联的子对象），Hibernate 会更适合你。</strong></p>
<h2 id="Mybatis-入门"><a href="#Mybatis-入门" class="headerlink" title="Mybatis 入门"></a>Mybatis 入门</h2><ul>
<li>Mybatis 入门   <ul>
<li>新建表 STUDENTS，插入样本数据</li>
<li>新建一个 Maven 项目，pom.xml 添加相关依赖</li>
<li>新建建 MyBatisSqlSessionFactory 单例模式类</li>
<li>新建映射器 StudentMapper 接口和 StudentService 类</li>
<li>新建一个 JUnit 测试类来测试 StudentService</li>
</ul>
</li>
</ul>
<h3 id="新建表-STUDENTS，插入样本数据"><a href="#新建表-STUDENTS，插入样本数据" class="headerlink" title="新建表 STUDENTS，插入样本数据"></a>新建表 STUDENTS，插入样本数据</h3><p><strong>使用以下 SQL 脚本往 MySQL 数据库中创建 STUDENTS 表插入样本数据：</strong><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> STUDENTS</span><br><span class="line">(</span><br><span class="line">stud_id <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line"><span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">email <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">dob <span class="built_in">date</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (stud_id)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=latin1;</span><br><span class="line"><span class="comment">/*Sample Data for the students table */</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> students(stud_id,<span class="keyword">name</span>,email,dob)</span><br><span class="line"><span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'Student1'</span>,<span class="string">'student1@gmail.com'</span>,<span class="string">'1983-06-25'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> students(stud_id,<span class="keyword">name</span>,email,dob)</span><br><span class="line"><span class="keyword">values</span> (<span class="number">2</span>,<span class="string">'Student2'</span>,<span class="string">'student2@gmail.com'</span>,<span class="string">'1983-06-25'</span>);</span><br></pre></td></tr></table></figure></p>
<h3 id="新建一个-Maven-项目，pom-xml-添加相关依赖"><a href="#新建一个-Maven-项目，pom-xml-添加相关依赖" class="headerlink" title="新建一个 Maven 项目，pom.xml 添加相关依赖"></a>新建一个 Maven 项目，pom.xml 添加相关依赖</h3><ul>
<li>创建一个名为 mybatis-demo的Maven 项目</li>
<li><p>在 pom.xml 中添加以下依赖：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.mybatis&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;mybatis&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;3.2.6&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;5.1.30&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.slf4j&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;1.7.5&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.slf4j&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;1.7.5&lt;/version&gt;</span><br><span class="line">	&lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;log4j&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;log4j&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;1.2.17&lt;/version&gt;</span><br><span class="line">	&lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;4.11&lt;/version&gt;</span><br><span class="line">	&lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建 log4j.properties 文件，添加到 <code>src/main/resources</code> (classpath下) 中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">log4j.rootLogger=DEBUG, stdout</span><br><span class="line">log4j.appender.stdout=org.apache.log4j.ConsoleAppender</span><br><span class="line">log4j.appender.stdout.layout=org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.stdout.layout.ConversionPattern=%d [%-5p] %c - %m%n</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="新建-mybatis-config-xml-和映射器-StudentMapper-xml-配置文件"><a href="#新建-mybatis-config-xml-和映射器-StudentMapper-xml-配置文件" class="headerlink" title="新建 mybatis-config.xml 和映射器 StudentMapper.xml 配置文件"></a>新建 mybatis-config.xml 和映射器 StudentMapper.xml 配置文件</h3><ul>
<li><p><strong><code>mybatis-config.xml</code> 为MyBatis的主要配置文件，其中包括数据库连接信息、类型别名等,创建并添加classpath下</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span><br><span class="line">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">	&lt;typeAliases&gt;</span><br><span class="line">		&lt;typeAlias alias=&quot;Student&quot; type=&quot;org.freecode.domain.Student&quot; /&gt;</span><br><span class="line">	&lt;/typeAliases&gt;</span><br><span class="line">	&lt;environments default=&quot;development&quot;&gt;</span><br><span class="line">		&lt;environment id=&quot;development&quot;&gt;</span><br><span class="line">			&lt;transactionManager type=&quot;JDBC&quot; /&gt;</span><br><span class="line">			&lt;dataSource type=&quot;POOLED&quot;&gt;</span><br><span class="line">				&lt;property name=&quot;driver&quot; value=&quot;com.mysql.jdbc.Driver&quot; /&gt;</span><br><span class="line">				&lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/test&quot; /&gt;</span><br><span class="line">				&lt;property name=&quot;username&quot; value=&quot;root&quot; /&gt;</span><br><span class="line">				&lt;property name=&quot;password&quot; value=&quot;123456&quot; /&gt;</span><br><span class="line">			&lt;/dataSource&gt;</span><br><span class="line">		&lt;/environment&gt;</span><br><span class="line">	&lt;/environments&gt;</span><br><span class="line">	&lt;mappers&gt;</span><br><span class="line">		&lt;mapper resource=&quot;or/freecode/mappers/StudentMapper.xml&quot; /&gt;</span><br><span class="line">	&lt;/mappers&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>StudentMapper.xml</code> 实体映射SQL语句文件，并将其放入自定义mapper目录下。（org.freecode.mappers）</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span><br><span class="line">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span><br><span class="line">&lt;mapper namespace=&quot;org.freecode.mappers.StudentMapper&quot;&gt;</span><br><span class="line">	&lt;resultMap type=&quot;Student&quot; id=&quot;StudentResult&quot;&gt;</span><br><span class="line">		&lt;id property=&quot;studId&quot; column=&quot;stud_id&quot; /&gt;</span><br><span class="line">		&lt;result property=&quot;name&quot; column=&quot;name&quot; /&gt;</span><br><span class="line">		&lt;result property=&quot;email&quot; column=&quot;email&quot; /&gt;</span><br><span class="line">		&lt;result property=&quot;dob&quot; column=&quot;dob&quot; /&gt;</span><br><span class="line">	&lt;/resultMap&gt;</span><br><span class="line">	&lt;select id=&quot;findAllStudents&quot; resultMap=&quot;StudentResult&quot;&gt;</span><br><span class="line">		SELECT * FROM STUDENTS</span><br><span class="line">	&lt;/select&gt;</span><br><span class="line">	&lt;select id=&quot;findStudentById&quot; parameterType=&quot;int&quot; resultType=&quot;Student&quot;&gt;</span><br><span class="line">		SELECT STUD_ID AS STUDID, NAME, EMAIL, DOB</span><br><span class="line">		FROM STUDENTS WHERE STUD_ID=#&#123;Id&#125;</span><br><span class="line">	&lt;/select&gt;</span><br><span class="line">	&lt;insert id=&quot;insertStudent&quot; parameterType=&quot;Student&quot;&gt;</span><br><span class="line">		INSERT INTO STUDENTS(STUD_ID,NAME,EMAIL,DOB)</span><br><span class="line">		VALUES(#&#123;studId &#125;,#&#123;name&#125;,#&#123;email&#125;,#&#123;dob&#125;)</span><br><span class="line">	&lt;/insert&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="新建-MyBatisSqlSessionFactory-单例类"><a href="#新建-MyBatisSqlSessionFactory-单例类" class="headerlink" title="新建 MyBatisSqlSessionFactory 单例类"></a>新建 MyBatisSqlSessionFactory 单例类</h3><p><strong>新建 MyBatisSqlSessionFactory.java 类文件，实例化它，使其持有一个 SqlSessionFactory 单例对象：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">package org.freecode.util;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line"></span><br><span class="line">import org.apache.ibatis.io.Resources;</span><br><span class="line">import org.apache.ibatis.session.SqlSession;</span><br><span class="line">import org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line">import org.apache.ibatis.session.SqlSessionFactoryBuilder;</span><br><span class="line"></span><br><span class="line">public class MyBatisSqlSessionFactory &#123;</span><br><span class="line"></span><br><span class="line">	private static SqlSessionFactory sqlSessionFactory;</span><br><span class="line">	public static SqlSessionFactory getSqlSessionFactory()&#123;</span><br><span class="line">		if(sqlSessionFactory == null)&#123;</span><br><span class="line">			InputStream inputStream;</span><br><span class="line">			try&#123;</span><br><span class="line">				inputStream = Resources.getResourceAsStream(&quot;mybatis-config.xml&quot;);</span><br><span class="line">				</span><br><span class="line">				sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);</span><br><span class="line">			&#125;catch(IOException e)&#123;</span><br><span class="line">				throw new RuntimeException(e.getCause());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		return sqlSessionFactory;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	public static SqlSession openSession()&#123;</span><br><span class="line">		return getSqlSessionFactory().openSession();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>上述的代码段中，我们创建了一个 SqlSessionFactory 对象，我们将使用它来获得 SqlSession 对象和执行映射的SQL 语句。</strong></p>
<h3 id="新建-StudentMapper-接口和-StudentService-类"><a href="#新建-StudentMapper-接口和-StudentService-类" class="headerlink" title="新建 StudentMapper 接口和 StudentService 类"></a>新建 StudentMapper 接口和 StudentService 类</h3><p>让我们创建一个 StudentMapper 接口，其定义的方法名和在 Mapper XML 配置文件定义的 SQL 映射语句名称相同；<br>在创建一个 StudentService.java 类，包含了一些业务操作的实现。</p>
<ul>
<li><p>首先，创建JavaBean Student.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">package org.freecode.domain;</span><br><span class="line"></span><br><span class="line">import java.util.Date;</span><br><span class="line"></span><br><span class="line">public class Student &#123;</span><br><span class="line">	private Integer studId;</span><br><span class="line">	private String name;</span><br><span class="line">	private String email;</span><br><span class="line">	private Date dob;</span><br><span class="line">	public Integer getStudId() &#123;</span><br><span class="line">		return studId;</span><br><span class="line">	&#125;</span><br><span class="line">	public void setStudId(Integer studId) &#123;</span><br><span class="line">		this.studId = studId;</span><br><span class="line">	&#125;</span><br><span class="line">	public String getName() &#123;</span><br><span class="line">		return name;</span><br><span class="line">	&#125;</span><br><span class="line">	public void setName(String name) &#123;</span><br><span class="line">		this.name = name;</span><br><span class="line">	&#125;</span><br><span class="line">	public String getEmail() &#123;</span><br><span class="line">		return email;</span><br><span class="line">	&#125;</span><br><span class="line">	public void setEmail(String email) &#123;</span><br><span class="line">		this.email = email;</span><br><span class="line">	&#125;</span><br><span class="line">	public Date getDob() &#123;</span><br><span class="line">		return dob;</span><br><span class="line">	&#125;</span><br><span class="line">	public void setDob(Date dob) &#123;</span><br><span class="line">		this.dob = dob;</span><br><span class="line">	&#125;</span><br><span class="line">	@Override</span><br><span class="line">	public String toString() &#123;</span><br><span class="line">		return &quot;Student [studId=&quot; + studId + &quot;, name=&quot; + name + &quot;, email=&quot;</span><br><span class="line">				+ email + &quot;, dob=&quot; + dob + &quot;]&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建映射器 Mapper 接口 StudentMapper.java 其方法签名和 StudentMapper.xml 中定义的 SQL 映射定义名相同</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">package org.freecode.mappers;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line">import org.freecode.domain.Student;</span><br><span class="line"></span><br><span class="line">public interface StudentMapper &#123;</span><br><span class="line">	List&lt;Student&gt; findAllStudents();</span><br><span class="line">	Student findStudentById(Integer id);</span><br><span class="line">	void insertStudent(Student student);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 StudentService.java 实现对表 STUDENTS 的数据库操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">package org.freecode.services;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">import org.apache.ibatis.session.SqlSession;</span><br><span class="line">import org.freecode.domain.Student;</span><br><span class="line">import org.freecode.mappers.StudentMapper;</span><br><span class="line">import org.freecode.util.MyBatisSqlSessionFactory;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class StudentService &#123;</span><br><span class="line">	private Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line">	</span><br><span class="line">	public List&lt;Student&gt; findAllStudents()&#123;</span><br><span class="line">		SqlSession sqlSession = MyBatisSqlSessionFactory.openSession();</span><br><span class="line">		</span><br><span class="line">		try&#123;</span><br><span class="line">			StudentMapper studentMapper = sqlSession.getMapper(StudentMapper.class);</span><br><span class="line">			return studentMapper.findAllStudents();</span><br><span class="line">		&#125;finally&#123;</span><br><span class="line">			// 如果sqlSession 没有关闭， 数据库连接不会返回到连接池(pool)中</span><br><span class="line">			sqlSession.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	public Student findStudentById(Integer studId)&#123;</span><br><span class="line">		logger.debug(&quot;Select Student By ID :&#123;&#125;&quot;,studId);</span><br><span class="line">		SqlSession sqlSession = MyBatisSqlSessionFactory.openSession();</span><br><span class="line">		try&#123;</span><br><span class="line">			StudentMapper studentMapper = sqlSession.getMapper(StudentMapper.class);</span><br><span class="line">			return studentMapper.findStudentById(studId);</span><br><span class="line">		&#125;finally&#123;</span><br><span class="line">			sqlSession.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	public void createStudent(Student student)&#123;</span><br><span class="line">		SqlSession sqlSession = MyBatisSqlSessionFactory.openSession();</span><br><span class="line">		try&#123;</span><br><span class="line">			StudentMapper studentMapper = sqlSession.getMapper(StudentMapper.class);</span><br><span class="line">			studentMapper.insertStudent(student);</span><br><span class="line">			sqlSession.commit();</span><br><span class="line">		&#125;finally&#123;</span><br><span class="line">			sqlSession.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	/**</span><br><span class="line">	 * 你也可以不通过Mapper接口执行映射的SQL语句,如下。（并不推荐）</span><br><span class="line">	 * @param studId</span><br><span class="line">	 * @return</span><br><span class="line">	 */</span><br><span class="line">	public Student findStudentById2(Integer studId)&#123;</span><br><span class="line">		SqlSession sqlSession = MyBatisSqlSessionFactory.openSession();</span><br><span class="line">		try&#123;</span><br><span class="line">			return (Student)sqlSession.selectOne(&quot;org.freecode.mappers.StudentMapper.findStudentById&quot;,studId);</span><br><span class="line">		&#125;finally&#123;</span><br><span class="line">			sqlSession.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="新建一个-JUnit-测试类来测试-StudentService"><a href="#新建一个-JUnit-测试类来测试-StudentService" class="headerlink" title="新建一个 JUnit 测试类来测试 StudentService"></a>新建一个 JUnit 测试类来测试 StudentService</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">package org.freecode.services;</span><br><span class="line"></span><br><span class="line">import java.util.Date;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">import org.freecode.domain.Student;</span><br><span class="line">import org.junit.AfterClass;</span><br><span class="line">import org.junit.Assert;</span><br><span class="line">import org.junit.BeforeClass;</span><br><span class="line">import org.junit.Test;</span><br><span class="line"></span><br><span class="line">public class StudentServiceTest &#123;</span><br><span class="line"></span><br><span class="line">	private static StudentService studentService;</span><br><span class="line">	</span><br><span class="line">	@BeforeClass</span><br><span class="line">	public static void setup()&#123;</span><br><span class="line">		studentService = new StudentService();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	@AfterClass</span><br><span class="line">	public static void teardown()&#123;</span><br><span class="line">		studentService = null;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	@Test</span><br><span class="line">	public void testFindAllStudents()&#123;</span><br><span class="line">		List&lt;Student&gt; students = studentService.findAllStudents();</span><br><span class="line">		Assert.assertNotNull(students);</span><br><span class="line">		for (Student student : students)&#123;</span><br><span class="line">			System.out.println(student);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	@Test</span><br><span class="line">	public void testFindStudentById()&#123;</span><br><span class="line">		Student student = studentService.findStudentById(3);</span><br><span class="line">		Assert.assertNotNull(student);</span><br><span class="line">		System.out.println(student);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	@Test</span><br><span class="line">	public void testCreateStudent()&#123;</span><br><span class="line">		Student student = new Student();</span><br><span class="line">		int id = 3;</span><br><span class="line">		student.setStudId(id);</span><br><span class="line">		student.setName(&quot;student_&quot; + id);</span><br><span class="line">		student.setEmail(&quot;student_&quot; + id + &quot;gmail.com&quot;);</span><br><span class="line">		student.setDob(new Date());</span><br><span class="line">		studentService.createStudent(student);</span><br><span class="line">		Student newStudent = studentService.findStudentById(id);</span><br><span class="line">		Assert.assertNotNull(newStudent);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="它是怎么工作的？"><a href="#它是怎么工作的？" class="headerlink" title="它是怎么工作的？"></a>它是怎么工作的？</h3><ul>
<li>首先，我们配置了 MyBatis 最主要的配置文件-mybatis-config.xml,里面包含了 JDBC 连接参数；配置了映射器Mapper XML 配置文件文件，里面包含了 SQL 语句的映射。</li>
<li>我 们 使 用 mybatis-config.xml 内 的 信 息 创 建 了 SqlSessionFactory 对 象 。 每 个 数 据 库 环 境 应 该 就 一 个SqlSessionFactory 对象实例，所以我们使用了单例模式只创建一个 SqlSessionFactory 实例。</li>
<li>我们创建了一个映射器 Mapper 接口-StudentMapper，其定义的方法签名和在 StudentMapper.xml 中定义的完全一样（即映射器 Mapper 接口中的方法名跟 StudentMapper.xml 中的 id 的值相同）。注意 StudentMapper.xml 中namespace 的值被设置成 org.freecode.mappers.StudentMapper，是 StudentMapper 接口的完全限定名。这使我们可以使用接口来调用映射的 SQL 语句。</li>
<li>在 StudentService.java 中，我们在每一个方法中创建了一个新的 SqlSession，并在方法功能完成后关闭SqlSession。每一个线程应该有它自己的 SqlSession 实例。SqlSession 对象实例不是线程安全的，并且不被共享。所以 SqlSession 的作用域最好就是其所在方法的作用域。从 Web 应用程序角度上看，SqlSession 应该存在于 request 级别作用域上。</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="cmp-cc" />
          <p class="site-author-name" itemprop="name">cmp-cc</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">29</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">24</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/cmp-cc" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        
        <div class="links-of-blogroll motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cmp-cc</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  


  




<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"cmp-cc"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();


  </script>

  
    
      <script src="/vendors/ua-parser-js/dist/ua-parser.min.js"></script>
      <script src="/js/src/hook-duoshuo.js"></script>
    
  

 <script type="text/javascript">
  window.onload = function(){setTimeout(function(){/*无登陆账户*/if(!document.getElementsByClassName("ds-account-control")[0]){var cmp_cc_blog_user=localStorage.getItem("cmp-cc_blog_user");var author_name_value = cmp_cc_blog_user?'value="'+cmp_cc_blog_user+'"':'';var i = '<div class="ds-control-group" style="float:right;padding:6px;"><input type="text" '+author_name_value+'id="author_name_proxy" id="ds-dialog-name"  class="custom_input" style="color:#777;width=80%;font-size:13px;border:1px solid #ccc;height:25px;box-shadow: inset 0 1px 1px;padding: 2px 0px 0px 8px;" placeholder="昵称 or 登陆" required></div>';/*展开一个回复，再关闭。 多说没有参数配置啊~ 让人觉得不优雅*/var $last_ds_post_reply = $(".ds-post-reply:last");$last_ds_post_reply.click().click();$(".ds-post-options.ds-gradient-bg").append(i);$(".ds-post-button").click(function(){$(this).submit();$("#ds-wrapper").hide();var author_name = $("#author_name_proxy").val();$("#ds-wrapper #ds-dialog-name").val(author_name);$("#ds-wrapper form").submit();/*www.cmp-cc.github.com*/localStorage.setItem("cmp-cc_blog_user",author_name);$(".custom_input").val(author_name);});}},300);} 
 </script>





  
  
  

  

  
<script type="text/javascript" async src="//push.zhanzhang.baidu.com/push.js">
</script>


</body>
</html>
